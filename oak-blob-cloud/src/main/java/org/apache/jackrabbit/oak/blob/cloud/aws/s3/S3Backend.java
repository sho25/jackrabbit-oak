begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|blob
operator|.
name|cloud
operator|.
name|aws
operator|.
name|s3
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Date
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Properties
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ExecutorService
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Executors
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ThreadPoolExecutor
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|TimeUnit
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|services
operator|.
name|s3
operator|.
name|model
operator|.
name|ListObjectsRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|AsyncTouchCallback
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|AsyncTouchResult
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|AsyncUploadCallback
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|AsyncUploadResult
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|CachingDataStore
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|DataIdentifier
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|DataRecord
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|DataStoreException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|util
operator|.
name|NamedThreadFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|AmazonClientException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|AmazonServiceException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|event
operator|.
name|ProgressEvent
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|event
operator|.
name|ProgressListener
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|services
operator|.
name|s3
operator|.
name|AmazonS3Client
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|services
operator|.
name|s3
operator|.
name|model
operator|.
name|CopyObjectRequest
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|services
operator|.
name|s3
operator|.
name|model
operator|.
name|DeleteObjectsRequest
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|services
operator|.
name|s3
operator|.
name|model
operator|.
name|DeleteObjectsResult
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|services
operator|.
name|s3
operator|.
name|model
operator|.
name|ObjectListing
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|services
operator|.
name|s3
operator|.
name|model
operator|.
name|ObjectMetadata
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|services
operator|.
name|s3
operator|.
name|model
operator|.
name|PutObjectRequest
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|services
operator|.
name|s3
operator|.
name|model
operator|.
name|Region
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|services
operator|.
name|s3
operator|.
name|model
operator|.
name|S3Object
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|services
operator|.
name|s3
operator|.
name|model
operator|.
name|S3ObjectSummary
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|services
operator|.
name|s3
operator|.
name|transfer
operator|.
name|Copy
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|services
operator|.
name|s3
operator|.
name|transfer
operator|.
name|TransferManager
import|;
end_import

begin_import
import|import
name|com
operator|.
name|amazonaws
operator|.
name|services
operator|.
name|s3
operator|.
name|transfer
operator|.
name|Upload
import|;
end_import

begin_comment
comment|/**  * A data store backend that stores data on Amazon S3.  */
end_comment

begin_class
specifier|public
class|class
name|S3Backend
implements|implements
name|SharedS3Backend
block|{
comment|/**      * Logger instance.      */
specifier|private
specifier|static
specifier|final
name|Logger
name|LOG
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|S3Backend
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|KEY_PREFIX
init|=
literal|"dataStore_"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|META_KEY_PREFIX
init|=
literal|"META/"
decl_stmt|;
specifier|private
name|AmazonS3Client
name|s3service
decl_stmt|;
specifier|private
name|String
name|bucket
decl_stmt|;
specifier|private
name|TransferManager
name|tmx
decl_stmt|;
specifier|private
name|CachingDataStore
name|store
decl_stmt|;
specifier|private
name|Properties
name|properties
decl_stmt|;
specifier|private
name|Date
name|startTime
decl_stmt|;
specifier|private
name|ThreadPoolExecutor
name|asyncWriteExecuter
decl_stmt|;
specifier|private
name|S3RequestDecorator
name|s3ReqDecorator
decl_stmt|;
comment|/**      * Initialize S3Backend. It creates AmazonS3Client and TransferManager from      * aws.properties. It creates S3 bucket if it doesn't pre-exist in S3.      */
annotation|@
name|Override
specifier|public
name|void
name|init
parameter_list|(
name|CachingDataStore
name|store
parameter_list|,
name|String
name|homeDir
parameter_list|,
name|String
name|config
parameter_list|)
throws|throws
name|DataStoreException
block|{
name|Properties
name|initProps
init|=
literal|null
decl_stmt|;
comment|//Check is configuration is already provided. That takes precedence
comment|//over config provided via file based config
if|if
condition|(
name|this
operator|.
name|properties
operator|!=
literal|null
condition|)
block|{
name|initProps
operator|=
name|this
operator|.
name|properties
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|config
operator|==
literal|null
condition|)
block|{
name|config
operator|=
name|Utils
operator|.
name|DEFAULT_CONFIG_FILE
expr_stmt|;
block|}
try|try
block|{
name|initProps
operator|=
name|Utils
operator|.
name|readConfig
argument_list|(
name|config
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Could not initialize S3 from "
operator|+
name|config
argument_list|,
name|e
argument_list|)
throw|;
block|}
name|this
operator|.
name|properties
operator|=
name|initProps
expr_stmt|;
block|}
name|init
argument_list|(
name|store
argument_list|,
name|homeDir
argument_list|,
name|initProps
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|init
parameter_list|(
name|CachingDataStore
name|store
parameter_list|,
name|String
name|homeDir
parameter_list|,
name|Properties
name|prop
parameter_list|)
throws|throws
name|DataStoreException
block|{
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|startTime
operator|=
operator|new
name|Date
argument_list|()
expr_stmt|;
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"init"
argument_list|)
expr_stmt|;
name|this
operator|.
name|store
operator|=
name|store
expr_stmt|;
name|s3ReqDecorator
operator|=
operator|new
name|S3RequestDecorator
argument_list|(
name|prop
argument_list|)
expr_stmt|;
name|s3service
operator|=
name|Utils
operator|.
name|openService
argument_list|(
name|prop
argument_list|)
expr_stmt|;
if|if
condition|(
name|bucket
operator|==
literal|null
operator|||
literal|""
operator|.
name|equals
argument_list|(
name|bucket
operator|.
name|trim
argument_list|()
argument_list|)
condition|)
block|{
name|bucket
operator|=
name|prop
operator|.
name|getProperty
argument_list|(
name|S3Constants
operator|.
name|S3_BUCKET
argument_list|)
expr_stmt|;
block|}
name|String
name|region
init|=
name|prop
operator|.
name|getProperty
argument_list|(
name|S3Constants
operator|.
name|S3_REGION
argument_list|)
decl_stmt|;
name|Region
name|s3Region
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|Utils
operator|.
name|DEFAULT_AWS_BUCKET_REGION
operator|.
name|equals
argument_list|(
name|region
argument_list|)
condition|)
block|{
name|s3Region
operator|=
name|Region
operator|.
name|US_Standard
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|Region
operator|.
name|EU_Ireland
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
name|region
argument_list|)
condition|)
block|{
name|s3Region
operator|=
name|Region
operator|.
name|EU_Ireland
expr_stmt|;
block|}
else|else
block|{
name|s3Region
operator|=
name|Region
operator|.
name|fromValue
argument_list|(
name|region
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|s3service
operator|.
name|doesBucketExist
argument_list|(
name|bucket
argument_list|)
condition|)
block|{
name|s3service
operator|.
name|createBucket
argument_list|(
name|bucket
argument_list|,
name|s3Region
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Created bucket [{}] in [{}] "
argument_list|,
name|bucket
argument_list|,
name|region
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Using bucket [{}] in [{}] "
argument_list|,
name|bucket
argument_list|,
name|region
argument_list|)
expr_stmt|;
block|}
name|int
name|writeThreads
init|=
literal|10
decl_stmt|;
name|String
name|writeThreadsStr
init|=
name|prop
operator|.
name|getProperty
argument_list|(
name|S3Constants
operator|.
name|S3_WRITE_THREADS
argument_list|)
decl_stmt|;
if|if
condition|(
name|writeThreadsStr
operator|!=
literal|null
condition|)
block|{
name|writeThreads
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|writeThreadsStr
argument_list|)
expr_stmt|;
block|}
name|LOG
operator|.
name|info
argument_list|(
literal|"Using thread pool of [{}] threads in S3 transfer manager."
argument_list|,
name|writeThreads
argument_list|)
expr_stmt|;
name|tmx
operator|=
operator|new
name|TransferManager
argument_list|(
name|s3service
argument_list|,
operator|(
name|ThreadPoolExecutor
operator|)
name|Executors
operator|.
name|newFixedThreadPool
argument_list|(
name|writeThreads
argument_list|,
operator|new
name|NamedThreadFactory
argument_list|(
literal|"s3-transfer-manager-worker"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|int
name|asyncWritePoolSize
init|=
literal|10
decl_stmt|;
name|String
name|maxConnsStr
init|=
name|prop
operator|.
name|getProperty
argument_list|(
name|S3Constants
operator|.
name|S3_MAX_CONNS
argument_list|)
decl_stmt|;
if|if
condition|(
name|maxConnsStr
operator|!=
literal|null
condition|)
block|{
name|asyncWritePoolSize
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|maxConnsStr
argument_list|)
operator|-
name|writeThreads
expr_stmt|;
block|}
name|asyncWriteExecuter
operator|=
operator|(
name|ThreadPoolExecutor
operator|)
name|Executors
operator|.
name|newFixedThreadPool
argument_list|(
name|asyncWritePoolSize
argument_list|,
operator|new
name|NamedThreadFactory
argument_list|(
literal|"s3-write-worker"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|renameKeyProp
init|=
name|prop
operator|.
name|getProperty
argument_list|(
name|S3Constants
operator|.
name|S3_RENAME_KEYS
argument_list|)
decl_stmt|;
name|boolean
name|renameKeyBool
init|=
operator|(
name|renameKeyProp
operator|==
literal|null
operator|||
literal|""
operator|.
name|equals
argument_list|(
name|renameKeyProp
argument_list|)
operator|)
condition|?
literal|false
else|:
name|Boolean
operator|.
name|parseBoolean
argument_list|(
name|renameKeyProp
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Rename keys [{}]"
argument_list|,
name|renameKeyBool
argument_list|)
expr_stmt|;
if|if
condition|(
name|renameKeyBool
condition|)
block|{
name|renameKeys
argument_list|()
expr_stmt|;
block|}
name|LOG
operator|.
name|debug
argument_list|(
literal|"S3 Backend initialized in [{}] ms"
argument_list|,
operator|+
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|startTime
operator|.
name|getTime
argument_list|()
operator|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"  error "
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Could not initialize S3 from "
operator|+
name|prop
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**      * It uploads file to Amazon S3. If file size is greater than 5MB, this      * method uses parallel concurrent connections to upload.      */
annotation|@
name|Override
specifier|public
name|void
name|write
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|,
name|File
name|file
parameter_list|)
throws|throws
name|DataStoreException
block|{
name|this
operator|.
name|write
argument_list|(
name|identifier
argument_list|,
name|file
argument_list|,
literal|false
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|writeAsync
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|,
name|File
name|file
parameter_list|,
name|AsyncUploadCallback
name|callback
parameter_list|)
throws|throws
name|DataStoreException
block|{
if|if
condition|(
name|callback
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"callback parameter cannot be null in asyncUpload"
argument_list|)
throw|;
block|}
name|asyncWriteExecuter
operator|.
name|execute
argument_list|(
operator|new
name|AsyncUploadJob
argument_list|(
name|identifier
argument_list|,
name|file
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/**      * Check if record identified by identifier exists in Amazon S3.      */
annotation|@
name|Override
specifier|public
name|boolean
name|exists
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|)
throws|throws
name|DataStoreException
block|{
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|String
name|key
init|=
name|getKeyName
argument_list|(
name|identifier
argument_list|)
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|ObjectMetadata
name|objectMetaData
init|=
name|s3service
operator|.
name|getObjectMetadata
argument_list|(
name|bucket
argument_list|,
name|key
argument_list|)
decl_stmt|;
if|if
condition|(
name|objectMetaData
operator|!=
literal|null
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"exists [{}]: [true] took [{}] ms."
argument_list|,
name|identifier
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
return|return
literal|false
return|;
block|}
catch|catch
parameter_list|(
name|AmazonServiceException
name|e
parameter_list|)
block|{
if|if
condition|(
name|e
operator|.
name|getStatusCode
argument_list|()
operator|==
literal|404
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"exists [{}]: [false] took [{}] ms."
argument_list|,
name|identifier
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Error occured to getObjectMetadata for key ["
operator|+
name|identifier
operator|.
name|toString
argument_list|()
operator|+
literal|"]"
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|boolean
name|exists
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|,
name|boolean
name|touch
parameter_list|)
throws|throws
name|DataStoreException
block|{
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|String
name|key
init|=
name|getKeyName
argument_list|(
name|identifier
argument_list|)
decl_stmt|;
name|ObjectMetadata
name|objectMetaData
init|=
literal|null
decl_stmt|;
name|boolean
name|retVal
init|=
literal|false
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|objectMetaData
operator|=
name|s3service
operator|.
name|getObjectMetadata
argument_list|(
name|bucket
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|objectMetaData
operator|!=
literal|null
condition|)
block|{
name|retVal
operator|=
literal|true
expr_stmt|;
if|if
condition|(
name|touch
condition|)
block|{
name|CopyObjectRequest
name|copReq
init|=
operator|new
name|CopyObjectRequest
argument_list|(
name|bucket
argument_list|,
name|key
argument_list|,
name|bucket
argument_list|,
name|key
argument_list|)
decl_stmt|;
name|copReq
operator|.
name|setNewObjectMetadata
argument_list|(
name|objectMetaData
argument_list|)
expr_stmt|;
name|Copy
name|copy
init|=
name|tmx
operator|.
name|copy
argument_list|(
name|s3ReqDecorator
operator|.
name|decorate
argument_list|(
name|copReq
argument_list|)
argument_list|)
decl_stmt|;
name|copy
operator|.
name|waitForCopyResult
argument_list|()
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"[{}] touched took [{}] ms. "
argument_list|,
name|identifier
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|retVal
operator|=
literal|false
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|AmazonServiceException
name|e
parameter_list|)
block|{
if|if
condition|(
name|e
operator|.
name|getStatusCode
argument_list|()
operator|==
literal|404
condition|)
block|{
name|retVal
operator|=
literal|false
expr_stmt|;
block|}
else|else
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Error occured to find exists for key ["
operator|+
name|identifier
operator|.
name|toString
argument_list|()
operator|+
literal|"]"
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Error occured to find exists for key  "
operator|+
name|identifier
operator|.
name|toString
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
name|LOG
operator|.
name|debug
argument_list|(
literal|"exists [{}]: [{}] took [{}] ms."
argument_list|,
operator|new
name|Object
index|[]
block|{
name|identifier
block|,
name|retVal
block|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
block|}
argument_list|)
expr_stmt|;
return|return
name|retVal
return|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|touchAsync
parameter_list|(
specifier|final
name|DataIdentifier
name|identifier
parameter_list|,
specifier|final
name|long
name|minModifiedDate
parameter_list|,
specifier|final
name|AsyncTouchCallback
name|callback
parameter_list|)
throws|throws
name|DataStoreException
block|{
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
if|if
condition|(
name|callback
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"callback parameter cannot be null in touchAsync"
argument_list|)
throw|;
block|}
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|asyncWriteExecuter
operator|.
name|execute
argument_list|(
operator|new
name|Runnable
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
name|touch
argument_list|(
name|identifier
argument_list|,
name|minModifiedDate
argument_list|)
expr_stmt|;
name|callback
operator|.
name|onSuccess
argument_list|(
operator|new
name|AsyncTouchResult
argument_list|(
name|identifier
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
name|e
parameter_list|)
block|{
name|AsyncTouchResult
name|result
init|=
operator|new
name|AsyncTouchResult
argument_list|(
name|identifier
argument_list|)
decl_stmt|;
name|result
operator|.
name|setException
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|callback
operator|.
name|onFailure
argument_list|(
name|result
argument_list|)
expr_stmt|;
block|}
block|}
block|}
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|callback
operator|.
name|onAbort
argument_list|(
operator|new
name|AsyncTouchResult
argument_list|(
name|identifier
argument_list|)
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Cannot touch the record "
operator|+
name|identifier
operator|.
name|toString
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|touch
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|,
name|long
name|minModifiedDate
parameter_list|)
throws|throws
name|DataStoreException
block|{
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
specifier|final
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
specifier|final
name|String
name|key
init|=
name|getKeyName
argument_list|(
name|identifier
argument_list|)
decl_stmt|;
if|if
condition|(
name|minModifiedDate
operator|>
literal|0
operator|&&
name|minModifiedDate
operator|>
name|getLastModified
argument_list|(
name|identifier
argument_list|)
condition|)
block|{
name|CopyObjectRequest
name|copReq
init|=
operator|new
name|CopyObjectRequest
argument_list|(
name|bucket
argument_list|,
name|key
argument_list|,
name|bucket
argument_list|,
name|key
argument_list|)
decl_stmt|;
name|copReq
operator|.
name|setNewObjectMetadata
argument_list|(
operator|new
name|ObjectMetadata
argument_list|()
argument_list|)
expr_stmt|;
name|Copy
name|copy
init|=
name|tmx
operator|.
name|copy
argument_list|(
name|s3ReqDecorator
operator|.
name|decorate
argument_list|(
name|copReq
argument_list|)
argument_list|)
decl_stmt|;
name|copy
operator|.
name|waitForCompletion
argument_list|()
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"[{}] touched. time taken [{}] ms "
argument_list|,
operator|new
name|Object
index|[]
block|{
name|identifier
block|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
block|}
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"[{}] touch not required. time taken [{}] ms "
argument_list|,
operator|new
name|Object
index|[]
block|{
name|identifier
block|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
block|}
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Error occured in touching key ["
operator|+
name|identifier
operator|.
name|toString
argument_list|()
operator|+
literal|"]"
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|InputStream
name|read
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|)
throws|throws
name|DataStoreException
block|{
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|String
name|key
init|=
name|getKeyName
argument_list|(
name|identifier
argument_list|)
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|S3Object
name|object
init|=
name|s3service
operator|.
name|getObject
argument_list|(
name|bucket
argument_list|,
name|key
argument_list|)
decl_stmt|;
name|InputStream
name|in
init|=
name|object
operator|.
name|getObjectContent
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"[{}] read took [{}]ms"
argument_list|,
name|identifier
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
return|return
name|in
return|;
block|}
catch|catch
parameter_list|(
name|AmazonServiceException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Object not found: "
operator|+
name|key
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|Iterator
argument_list|<
name|DataIdentifier
argument_list|>
name|getAllIdentifiers
parameter_list|()
throws|throws
name|DataStoreException
block|{
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|Set
argument_list|<
name|DataIdentifier
argument_list|>
name|ids
init|=
operator|new
name|HashSet
argument_list|<
name|DataIdentifier
argument_list|>
argument_list|()
decl_stmt|;
name|ObjectListing
name|prevObjectListing
init|=
name|s3service
operator|.
name|listObjects
argument_list|(
name|bucket
argument_list|)
decl_stmt|;
while|while
condition|(
literal|true
condition|)
block|{
for|for
control|(
name|S3ObjectSummary
name|s3ObjSumm
range|:
name|prevObjectListing
operator|.
name|getObjectSummaries
argument_list|()
control|)
block|{
name|String
name|id
init|=
name|getIdentifierName
argument_list|(
name|s3ObjSumm
operator|.
name|getKey
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|id
operator|!=
literal|null
operator|&&
operator|!
name|id
operator|.
name|startsWith
argument_list|(
name|META_KEY_PREFIX
argument_list|)
condition|)
block|{
name|ids
operator|.
name|add
argument_list|(
operator|new
name|DataIdentifier
argument_list|(
name|id
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|prevObjectListing
operator|.
name|isTruncated
argument_list|()
condition|)
break|break;
name|prevObjectListing
operator|=
name|s3service
operator|.
name|listNextBatchOfObjects
argument_list|(
name|prevObjectListing
argument_list|)
expr_stmt|;
block|}
name|LOG
operator|.
name|debug
argument_list|(
literal|"getAllIdentifiers returned size [{}] took [{}] ms."
argument_list|,
name|ids
operator|.
name|size
argument_list|()
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
return|return
name|ids
operator|.
name|iterator
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|AmazonServiceException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Could not list objects"
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|long
name|getLastModified
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|)
throws|throws
name|DataStoreException
block|{
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|String
name|key
init|=
name|getKeyName
argument_list|(
name|identifier
argument_list|)
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|ObjectMetadata
name|object
init|=
name|s3service
operator|.
name|getObjectMetadata
argument_list|(
name|bucket
argument_list|,
name|key
argument_list|)
decl_stmt|;
name|long
name|lastModified
init|=
name|object
operator|.
name|getLastModified
argument_list|()
operator|.
name|getTime
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Identifier [{}]'s lastModified = [{}] took [{}]ms."
argument_list|,
operator|new
name|Object
index|[]
block|{
name|identifier
block|,
name|lastModified
block|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
block|}
argument_list|)
expr_stmt|;
return|return
name|lastModified
return|;
block|}
catch|catch
parameter_list|(
name|AmazonServiceException
name|e
parameter_list|)
block|{
if|if
condition|(
name|e
operator|.
name|getStatusCode
argument_list|()
operator|==
literal|404
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"getLastModified:Identifier [{}] not found. Took [{}] ms."
argument_list|,
name|identifier
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
block|}
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|long
name|getLength
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|)
throws|throws
name|DataStoreException
block|{
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|String
name|key
init|=
name|getKeyName
argument_list|(
name|identifier
argument_list|)
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|ObjectMetadata
name|object
init|=
name|s3service
operator|.
name|getObjectMetadata
argument_list|(
name|bucket
argument_list|,
name|key
argument_list|)
decl_stmt|;
name|long
name|length
init|=
name|object
operator|.
name|getContentLength
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Identifier [{}]'s length = [{}] took [{}]ms."
argument_list|,
operator|new
name|Object
index|[]
block|{
name|identifier
block|,
name|length
block|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
block|}
argument_list|)
expr_stmt|;
return|return
name|length
return|;
block|}
catch|catch
parameter_list|(
name|AmazonServiceException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Could not length of dataIdentifier "
operator|+
name|identifier
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|deleteRecord
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|)
throws|throws
name|DataStoreException
block|{
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|String
name|key
init|=
name|getKeyName
argument_list|(
name|identifier
argument_list|)
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|s3service
operator|.
name|deleteObject
argument_list|(
name|bucket
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Identifier [{}] deleted. It took [{}]ms."
argument_list|,
operator|new
name|Object
index|[]
block|{
name|identifier
block|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
block|}
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|AmazonServiceException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Could not getLastModified of dataIdentifier "
operator|+
name|identifier
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|Set
argument_list|<
name|DataIdentifier
argument_list|>
name|deleteAllOlderThan
parameter_list|(
name|long
name|min
parameter_list|)
throws|throws
name|DataStoreException
block|{
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
comment|// S3 stores lastModified to lower boundary of timestamp in ms.
comment|// and hence min is reduced by 1000ms.
name|min
operator|=
name|min
operator|-
literal|1000
expr_stmt|;
name|Set
argument_list|<
name|DataIdentifier
argument_list|>
name|deleteIdSet
init|=
operator|new
name|HashSet
argument_list|<
name|DataIdentifier
argument_list|>
argument_list|(
literal|30
argument_list|)
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|ObjectListing
name|prevObjectListing
init|=
name|s3service
operator|.
name|listObjects
argument_list|(
name|bucket
argument_list|)
decl_stmt|;
while|while
condition|(
literal|true
condition|)
block|{
name|List
argument_list|<
name|DeleteObjectsRequest
operator|.
name|KeyVersion
argument_list|>
name|deleteList
init|=
operator|new
name|ArrayList
argument_list|<
name|DeleteObjectsRequest
operator|.
name|KeyVersion
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|S3ObjectSummary
name|s3ObjSumm
range|:
name|prevObjectListing
operator|.
name|getObjectSummaries
argument_list|()
control|)
block|{
if|if
condition|(
operator|!
name|s3ObjSumm
operator|.
name|getKey
argument_list|()
operator|.
name|startsWith
argument_list|(
name|META_KEY_PREFIX
argument_list|)
condition|)
block|{
name|DataIdentifier
name|identifier
init|=
operator|new
name|DataIdentifier
argument_list|(
name|getIdentifierName
argument_list|(
name|s3ObjSumm
operator|.
name|getKey
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|long
name|lastModified
init|=
name|s3ObjSumm
operator|.
name|getLastModified
argument_list|()
operator|.
name|getTime
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Identifier [{}]'s lastModified = [{}]"
argument_list|,
name|identifier
argument_list|,
name|lastModified
argument_list|)
expr_stmt|;
if|if
condition|(
name|lastModified
operator|<
name|min
operator|&&
name|store
operator|.
name|confirmDelete
argument_list|(
name|identifier
argument_list|)
comment|// confirm once more that record's lastModified< min
comment|//  order is important here
operator|&&
name|s3service
operator|.
name|getObjectMetadata
argument_list|(
name|bucket
argument_list|,
name|s3ObjSumm
operator|.
name|getKey
argument_list|()
argument_list|)
operator|.
name|getLastModified
argument_list|()
operator|.
name|getTime
argument_list|()
operator|<
name|min
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"add id [{}] to delete lists"
argument_list|,
name|s3ObjSumm
operator|.
name|getKey
argument_list|()
argument_list|)
expr_stmt|;
name|deleteList
operator|.
name|add
argument_list|(
operator|new
name|DeleteObjectsRequest
operator|.
name|KeyVersion
argument_list|(
name|s3ObjSumm
operator|.
name|getKey
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|deleteIdSet
operator|.
name|add
argument_list|(
name|identifier
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|deleteList
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|DeleteObjectsRequest
name|delObjsReq
init|=
operator|new
name|DeleteObjectsRequest
argument_list|(
name|bucket
argument_list|)
decl_stmt|;
name|delObjsReq
operator|.
name|setKeys
argument_list|(
name|deleteList
argument_list|)
expr_stmt|;
name|DeleteObjectsResult
name|dobjs
init|=
name|s3service
operator|.
name|deleteObjects
argument_list|(
name|delObjsReq
argument_list|)
decl_stmt|;
if|if
condition|(
name|dobjs
operator|.
name|getDeletedObjects
argument_list|()
operator|.
name|size
argument_list|()
operator|!=
name|deleteList
operator|.
name|size
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Incomplete delete object request. only  "
operator|+
name|dobjs
operator|.
name|getDeletedObjects
argument_list|()
operator|.
name|size
argument_list|()
operator|+
literal|" out of "
operator|+
name|deleteList
operator|.
name|size
argument_list|()
operator|+
literal|" are deleted"
argument_list|)
throw|;
block|}
else|else
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"[{}] records deleted from datastore"
argument_list|,
name|deleteList
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|prevObjectListing
operator|.
name|isTruncated
argument_list|()
condition|)
block|{
break|break;
block|}
name|prevObjectListing
operator|=
name|s3service
operator|.
name|listNextBatchOfObjects
argument_list|(
name|prevObjectListing
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
name|LOG
operator|.
name|info
argument_list|(
literal|"deleteAllOlderThan: min=[{}] exit. Deleted[{}] records. Number of records deleted [{}] took [{}]ms"
argument_list|,
operator|new
name|Object
index|[]
block|{
name|min
block|,
name|deleteIdSet
block|,
name|deleteIdSet
operator|.
name|size
argument_list|()
block|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
block|}
argument_list|)
expr_stmt|;
return|return
name|deleteIdSet
return|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|close
parameter_list|()
block|{
comment|// backend is closing. abort all mulitpart uploads from start.
name|asyncWriteExecuter
operator|.
name|shutdownNow
argument_list|()
expr_stmt|;
if|if
condition|(
name|s3service
operator|.
name|doesBucketExist
argument_list|(
name|bucket
argument_list|)
condition|)
block|{
name|tmx
operator|.
name|abortMultipartUploads
argument_list|(
name|bucket
argument_list|,
name|startTime
argument_list|)
expr_stmt|;
block|}
name|tmx
operator|.
name|shutdownNow
argument_list|()
expr_stmt|;
name|s3service
operator|.
name|shutdown
argument_list|()
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"S3Backend closed."
argument_list|)
expr_stmt|;
block|}
specifier|public
name|String
name|getBucket
parameter_list|()
block|{
return|return
name|bucket
return|;
block|}
specifier|public
name|void
name|setBucket
parameter_list|(
name|String
name|bucket
parameter_list|)
block|{
name|this
operator|.
name|bucket
operator|=
name|bucket
expr_stmt|;
block|}
comment|/**      * Properties used to configure the backend. If provided explicitly      * before init is invoked then these take precedence      *      * @param properties  to configure S3Backend      */
specifier|public
name|void
name|setProperties
parameter_list|(
name|Properties
name|properties
parameter_list|)
block|{
name|this
operator|.
name|properties
operator|=
name|properties
expr_stmt|;
block|}
specifier|public
name|void
name|addMetadataRecord
parameter_list|(
specifier|final
name|InputStream
name|input
parameter_list|,
specifier|final
name|String
name|name
parameter_list|)
throws|throws
name|DataStoreException
block|{
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|Upload
name|upload
init|=
name|tmx
operator|.
name|upload
argument_list|(
name|s3ReqDecorator
operator|.
name|decorate
argument_list|(
operator|new
name|PutObjectRequest
argument_list|(
name|bucket
argument_list|,
name|addMetaKeyPrefix
argument_list|(
name|name
argument_list|)
argument_list|,
name|input
argument_list|,
operator|new
name|ObjectMetadata
argument_list|()
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|upload
operator|.
name|waitForUploadResult
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error in uploading"
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Error in uploading"
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|public
name|DataRecord
name|getMetadataRecord
parameter_list|(
name|String
name|name
parameter_list|)
block|{
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|ObjectMetadata
name|meta
init|=
name|s3service
operator|.
name|getObjectMetadata
argument_list|(
name|bucket
argument_list|,
name|addMetaKeyPrefix
argument_list|(
name|name
argument_list|)
argument_list|)
decl_stmt|;
return|return
operator|new
name|S3DataRecord
argument_list|(
name|s3service
argument_list|,
name|bucket
argument_list|,
name|name
argument_list|,
name|meta
operator|.
name|getLastModified
argument_list|()
operator|.
name|getTime
argument_list|()
argument_list|,
name|meta
operator|.
name|getContentLength
argument_list|()
argument_list|)
return|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|public
name|List
argument_list|<
name|DataRecord
argument_list|>
name|getAllMetadataRecords
parameter_list|(
name|String
name|prefix
parameter_list|)
block|{
name|List
argument_list|<
name|DataRecord
argument_list|>
name|metadataList
init|=
operator|new
name|ArrayList
argument_list|<
name|DataRecord
argument_list|>
argument_list|()
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|ListObjectsRequest
name|listObjectsRequest
init|=
operator|new
name|ListObjectsRequest
argument_list|()
operator|.
name|withBucketName
argument_list|(
name|bucket
argument_list|)
operator|.
name|withPrefix
argument_list|(
name|addMetaKeyPrefix
argument_list|(
name|prefix
argument_list|)
argument_list|)
decl_stmt|;
name|ObjectListing
name|prevObjectListing
init|=
name|s3service
operator|.
name|listObjects
argument_list|(
name|listObjectsRequest
argument_list|)
decl_stmt|;
for|for
control|(
specifier|final
name|S3ObjectSummary
name|s3ObjSumm
range|:
name|prevObjectListing
operator|.
name|getObjectSummaries
argument_list|()
control|)
block|{
name|metadataList
operator|.
name|add
argument_list|(
operator|new
name|S3DataRecord
argument_list|(
name|s3service
argument_list|,
name|bucket
argument_list|,
name|stripMetaKeyPrefix
argument_list|(
name|s3ObjSumm
operator|.
name|getKey
argument_list|()
argument_list|)
argument_list|,
name|s3ObjSumm
operator|.
name|getLastModified
argument_list|()
operator|.
name|getTime
argument_list|()
argument_list|,
name|s3ObjSumm
operator|.
name|getSize
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|metadataList
return|;
block|}
specifier|public
name|boolean
name|deleteMetadataRecord
parameter_list|(
name|String
name|name
parameter_list|)
block|{
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|s3service
operator|.
name|deleteObject
argument_list|(
name|bucket
argument_list|,
name|addMetaKeyPrefix
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|true
return|;
block|}
specifier|public
name|void
name|deleteAllMetadataRecords
parameter_list|(
name|String
name|prefix
parameter_list|)
block|{
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|ListObjectsRequest
name|listObjectsRequest
init|=
operator|new
name|ListObjectsRequest
argument_list|()
operator|.
name|withBucketName
argument_list|(
name|bucket
argument_list|)
operator|.
name|withPrefix
argument_list|(
name|addMetaKeyPrefix
argument_list|(
name|prefix
argument_list|)
argument_list|)
decl_stmt|;
name|ObjectListing
name|metaList
init|=
name|s3service
operator|.
name|listObjects
argument_list|(
name|listObjectsRequest
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|DeleteObjectsRequest
operator|.
name|KeyVersion
argument_list|>
name|deleteList
init|=
operator|new
name|ArrayList
argument_list|<
name|DeleteObjectsRequest
operator|.
name|KeyVersion
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|S3ObjectSummary
name|s3ObjSumm
range|:
name|metaList
operator|.
name|getObjectSummaries
argument_list|()
control|)
block|{
name|deleteList
operator|.
name|add
argument_list|(
operator|new
name|DeleteObjectsRequest
operator|.
name|KeyVersion
argument_list|(
name|s3ObjSumm
operator|.
name|getKey
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|deleteList
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|DeleteObjectsRequest
name|delObjsReq
init|=
operator|new
name|DeleteObjectsRequest
argument_list|(
name|bucket
argument_list|)
decl_stmt|;
name|delObjsReq
operator|.
name|setKeys
argument_list|(
name|deleteList
argument_list|)
expr_stmt|;
name|DeleteObjectsResult
name|dobjs
init|=
name|s3service
operator|.
name|deleteObjects
argument_list|(
name|delObjsReq
argument_list|)
decl_stmt|;
block|}
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|private
specifier|static
name|String
name|addMetaKeyPrefix
parameter_list|(
name|String
name|key
parameter_list|)
block|{
return|return
name|META_KEY_PREFIX
operator|+
name|key
return|;
block|}
specifier|private
specifier|static
name|String
name|stripMetaKeyPrefix
parameter_list|(
name|String
name|name
parameter_list|)
block|{
if|if
condition|(
name|name
operator|.
name|startsWith
argument_list|(
name|META_KEY_PREFIX
argument_list|)
condition|)
block|{
return|return
name|name
operator|.
name|substring
argument_list|(
name|META_KEY_PREFIX
operator|.
name|length
argument_list|()
argument_list|)
return|;
block|}
return|return
name|name
return|;
block|}
comment|/**      * S3DataRecord which lazily retrieves the input stream of the record.      */
specifier|static
class|class
name|S3DataRecord
implements|implements
name|DataRecord
block|{
specifier|private
name|AmazonS3Client
name|s3service
decl_stmt|;
specifier|private
name|DataIdentifier
name|identifier
decl_stmt|;
specifier|private
name|long
name|length
decl_stmt|;
specifier|private
name|long
name|lastModified
decl_stmt|;
specifier|private
name|String
name|bucket
decl_stmt|;
specifier|public
name|S3DataRecord
parameter_list|(
name|AmazonS3Client
name|s3service
parameter_list|,
name|String
name|bucket
parameter_list|,
name|String
name|key
parameter_list|,
name|long
name|lastModified
parameter_list|,
name|long
name|length
parameter_list|)
block|{
name|this
operator|.
name|s3service
operator|=
name|s3service
expr_stmt|;
name|this
operator|.
name|identifier
operator|=
operator|new
name|DataIdentifier
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|this
operator|.
name|lastModified
operator|=
name|lastModified
expr_stmt|;
name|this
operator|.
name|length
operator|=
name|length
expr_stmt|;
name|this
operator|.
name|bucket
operator|=
name|bucket
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|DataIdentifier
name|getIdentifier
parameter_list|()
block|{
return|return
name|identifier
return|;
block|}
annotation|@
name|Override
specifier|public
name|String
name|getReference
parameter_list|()
block|{
return|return
name|identifier
operator|.
name|toString
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getLength
parameter_list|()
throws|throws
name|DataStoreException
block|{
return|return
name|length
return|;
block|}
annotation|@
name|Override
specifier|public
name|InputStream
name|getStream
parameter_list|()
throws|throws
name|DataStoreException
block|{
return|return
name|s3service
operator|.
name|getObject
argument_list|(
name|bucket
argument_list|,
name|addMetaKeyPrefix
argument_list|(
name|identifier
operator|.
name|toString
argument_list|()
argument_list|)
argument_list|)
operator|.
name|getObjectContent
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getLastModified
parameter_list|()
block|{
return|return
name|lastModified
return|;
block|}
block|}
specifier|private
name|void
name|write
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|,
name|File
name|file
parameter_list|,
name|boolean
name|asyncUpload
parameter_list|,
name|AsyncUploadCallback
name|callback
parameter_list|)
throws|throws
name|DataStoreException
block|{
name|String
name|key
init|=
name|getKeyName
argument_list|(
name|identifier
argument_list|)
decl_stmt|;
name|ObjectMetadata
name|objectMetaData
init|=
literal|null
decl_stmt|;
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
comment|// check if the same record already exists
try|try
block|{
name|objectMetaData
operator|=
name|s3service
operator|.
name|getObjectMetadata
argument_list|(
name|bucket
argument_list|,
name|key
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|AmazonServiceException
name|ase
parameter_list|)
block|{
if|if
condition|(
name|ase
operator|.
name|getStatusCode
argument_list|()
operator|!=
literal|404
condition|)
block|{
throw|throw
name|ase
throw|;
block|}
block|}
if|if
condition|(
name|objectMetaData
operator|!=
literal|null
condition|)
block|{
name|long
name|l
init|=
name|objectMetaData
operator|.
name|getContentLength
argument_list|()
decl_stmt|;
if|if
condition|(
name|l
operator|!=
name|file
operator|.
name|length
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Collision: "
operator|+
name|key
operator|+
literal|" new length: "
operator|+
name|file
operator|.
name|length
argument_list|()
operator|+
literal|" old length: "
operator|+
name|l
argument_list|)
throw|;
block|}
name|LOG
operator|.
name|debug
argument_list|(
literal|"[{}]'s exists, lastmodified = [{}]"
argument_list|,
name|key
argument_list|,
name|objectMetaData
operator|.
name|getLastModified
argument_list|()
operator|.
name|getTime
argument_list|()
argument_list|)
expr_stmt|;
name|CopyObjectRequest
name|copReq
init|=
operator|new
name|CopyObjectRequest
argument_list|(
name|bucket
argument_list|,
name|key
argument_list|,
name|bucket
argument_list|,
name|key
argument_list|)
decl_stmt|;
name|copReq
operator|.
name|setNewObjectMetadata
argument_list|(
name|objectMetaData
argument_list|)
expr_stmt|;
name|Copy
name|copy
init|=
name|tmx
operator|.
name|copy
argument_list|(
name|s3ReqDecorator
operator|.
name|decorate
argument_list|(
name|copReq
argument_list|)
argument_list|)
decl_stmt|;
try|try
block|{
name|copy
operator|.
name|waitForCopyResult
argument_list|()
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"lastModified of [{}] updated successfully."
argument_list|,
name|identifier
argument_list|)
expr_stmt|;
if|if
condition|(
name|callback
operator|!=
literal|null
condition|)
block|{
name|callback
operator|.
name|onSuccess
argument_list|(
operator|new
name|AsyncUploadResult
argument_list|(
name|identifier
argument_list|,
name|file
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e2
parameter_list|)
block|{
name|AsyncUploadResult
name|asyncUpRes
init|=
operator|new
name|AsyncUploadResult
argument_list|(
name|identifier
argument_list|,
name|file
argument_list|)
decl_stmt|;
name|asyncUpRes
operator|.
name|setException
argument_list|(
name|e2
argument_list|)
expr_stmt|;
if|if
condition|(
name|callback
operator|!=
literal|null
condition|)
block|{
name|callback
operator|.
name|onAbort
argument_list|(
name|asyncUpRes
argument_list|)
expr_stmt|;
block|}
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Could not upload "
operator|+
name|key
argument_list|,
name|e2
argument_list|)
throw|;
block|}
block|}
if|if
condition|(
name|objectMetaData
operator|==
literal|null
condition|)
block|{
try|try
block|{
comment|// start multipart parallel upload using amazon sdk
name|Upload
name|up
init|=
name|tmx
operator|.
name|upload
argument_list|(
name|s3ReqDecorator
operator|.
name|decorate
argument_list|(
operator|new
name|PutObjectRequest
argument_list|(
name|bucket
argument_list|,
name|key
argument_list|,
name|file
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
comment|// wait for upload to finish
if|if
condition|(
name|asyncUpload
condition|)
block|{
name|up
operator|.
name|addProgressListener
argument_list|(
operator|new
name|S3UploadProgressListener
argument_list|(
name|up
argument_list|,
name|identifier
argument_list|,
name|file
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"added upload progress listener to identifier [{}]"
argument_list|,
name|identifier
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|up
operator|.
name|waitForUploadResult
argument_list|()
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"synchronous upload to identifier [{}] completed."
argument_list|,
name|identifier
argument_list|)
expr_stmt|;
if|if
condition|(
name|callback
operator|!=
literal|null
condition|)
block|{
name|callback
operator|.
name|onSuccess
argument_list|(
operator|new
name|AsyncUploadResult
argument_list|(
name|identifier
argument_list|,
name|file
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e2
parameter_list|)
block|{
name|AsyncUploadResult
name|asyncUpRes
init|=
operator|new
name|AsyncUploadResult
argument_list|(
name|identifier
argument_list|,
name|file
argument_list|)
decl_stmt|;
name|asyncUpRes
operator|.
name|setException
argument_list|(
name|e2
argument_list|)
expr_stmt|;
if|if
condition|(
name|callback
operator|!=
literal|null
condition|)
block|{
name|callback
operator|.
name|onAbort
argument_list|(
name|asyncUpRes
argument_list|)
expr_stmt|;
block|}
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Could not upload "
operator|+
name|key
argument_list|,
name|e2
argument_list|)
throw|;
block|}
block|}
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
name|LOG
operator|.
name|debug
argument_list|(
literal|"write of [{}], length=[{}], in async mode [{}], in [{}]ms"
argument_list|,
operator|new
name|Object
index|[]
block|{
name|identifier
block|,
name|file
operator|.
name|length
argument_list|()
block|,
name|asyncUpload
block|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
block|}
argument_list|)
expr_stmt|;
block|}
comment|/**      * This method rename object keys in S3 concurrently. The number of      * concurrent threads is defined by 'maxConnections' property in      * aws.properties. As S3 doesn't have "move" command, this method simulate      * move as copy object object to new key and then delete older key.      */
specifier|private
name|void
name|renameKeys
parameter_list|()
throws|throws
name|DataStoreException
block|{
name|long
name|startTime
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
name|long
name|count
init|=
literal|0
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|ObjectListing
name|prevObjectListing
init|=
name|s3service
operator|.
name|listObjects
argument_list|(
name|bucket
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|DeleteObjectsRequest
operator|.
name|KeyVersion
argument_list|>
name|deleteList
init|=
operator|new
name|ArrayList
argument_list|<
name|DeleteObjectsRequest
operator|.
name|KeyVersion
argument_list|>
argument_list|()
decl_stmt|;
name|int
name|nThreads
init|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"maxConnections"
argument_list|)
argument_list|)
decl_stmt|;
name|ExecutorService
name|executor
init|=
name|Executors
operator|.
name|newFixedThreadPool
argument_list|(
name|nThreads
argument_list|,
operator|new
name|NamedThreadFactory
argument_list|(
literal|"s3-object-rename-worker"
argument_list|)
argument_list|)
decl_stmt|;
name|boolean
name|taskAdded
init|=
literal|false
decl_stmt|;
while|while
condition|(
literal|true
condition|)
block|{
for|for
control|(
name|S3ObjectSummary
name|s3ObjSumm
range|:
name|prevObjectListing
operator|.
name|getObjectSummaries
argument_list|()
control|)
block|{
name|executor
operator|.
name|execute
argument_list|(
operator|new
name|KeyRenameThread
argument_list|(
name|s3ObjSumm
operator|.
name|getKey
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|taskAdded
operator|=
literal|true
expr_stmt|;
name|count
operator|++
expr_stmt|;
comment|// delete the object if it follows old key name format
if|if
condition|(
name|s3ObjSumm
operator|.
name|getKey
argument_list|()
operator|.
name|startsWith
argument_list|(
name|KEY_PREFIX
argument_list|)
condition|)
block|{
name|deleteList
operator|.
name|add
argument_list|(
operator|new
name|DeleteObjectsRequest
operator|.
name|KeyVersion
argument_list|(
name|s3ObjSumm
operator|.
name|getKey
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|prevObjectListing
operator|.
name|isTruncated
argument_list|()
condition|)
break|break;
name|prevObjectListing
operator|=
name|s3service
operator|.
name|listNextBatchOfObjects
argument_list|(
name|prevObjectListing
argument_list|)
expr_stmt|;
block|}
comment|// This will make the executor accept no new threads
comment|// and finish all existing threads in the queue
name|executor
operator|.
name|shutdown
argument_list|()
expr_stmt|;
try|try
block|{
comment|// Wait until all threads are finish
while|while
condition|(
name|taskAdded
operator|&&
operator|!
name|executor
operator|.
name|awaitTermination
argument_list|(
literal|10
argument_list|,
name|TimeUnit
operator|.
name|SECONDS
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Rename S3 keys tasks timedout. Waiting again"
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|ie
parameter_list|)
block|{              }
name|LOG
operator|.
name|info
argument_list|(
literal|"Renamed [{}] keys, time taken [{}]sec"
argument_list|,
name|count
argument_list|,
operator|(
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|startTime
operator|)
operator|/
literal|1000
operator|)
argument_list|)
expr_stmt|;
comment|// Delete older keys.
if|if
condition|(
name|deleteList
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|DeleteObjectsRequest
name|delObjsReq
init|=
operator|new
name|DeleteObjectsRequest
argument_list|(
name|bucket
argument_list|)
decl_stmt|;
name|int
name|batchSize
init|=
literal|500
decl_stmt|,
name|startIndex
init|=
literal|0
decl_stmt|,
name|size
init|=
name|deleteList
operator|.
name|size
argument_list|()
decl_stmt|;
name|int
name|endIndex
init|=
name|batchSize
operator|<
name|size
condition|?
name|batchSize
else|:
name|size
decl_stmt|;
while|while
condition|(
name|endIndex
operator|<=
name|size
condition|)
block|{
name|delObjsReq
operator|.
name|setKeys
argument_list|(
name|Collections
operator|.
name|unmodifiableList
argument_list|(
name|deleteList
operator|.
name|subList
argument_list|(
name|startIndex
argument_list|,
name|endIndex
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|DeleteObjectsResult
name|dobjs
init|=
name|s3service
operator|.
name|deleteObjects
argument_list|(
name|delObjsReq
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Records[{}] deleted in datastore from index [{}] to [{}]"
argument_list|,
operator|new
name|Object
index|[]
block|{
name|dobjs
operator|.
name|getDeletedObjects
argument_list|()
operator|.
name|size
argument_list|()
block|,
name|startIndex
block|,
operator|(
name|endIndex
operator|-
literal|1
operator|)
block|}
argument_list|)
expr_stmt|;
if|if
condition|(
name|endIndex
operator|==
name|size
condition|)
block|{
break|break;
block|}
else|else
block|{
name|startIndex
operator|=
name|endIndex
expr_stmt|;
name|endIndex
operator|=
operator|(
name|startIndex
operator|+
name|batchSize
operator|)
operator|<
name|size
condition|?
operator|(
name|startIndex
operator|+
name|batchSize
operator|)
else|:
name|size
expr_stmt|;
block|}
block|}
block|}
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**      * The method convert old key format to new format. For e.g. this method      * converts old key dataStore_004cb70c8f87d78f04da41e7547cb434094089ea to      * 004c-b70c8f87d78f04da41e7547cb434094089ea.      */
specifier|private
specifier|static
name|String
name|convertKey
parameter_list|(
name|String
name|oldKey
parameter_list|)
throws|throws
name|IllegalArgumentException
block|{
if|if
condition|(
operator|!
name|oldKey
operator|.
name|startsWith
argument_list|(
name|KEY_PREFIX
argument_list|)
condition|)
block|{
return|return
name|oldKey
return|;
block|}
name|String
name|key
init|=
name|oldKey
operator|.
name|substring
argument_list|(
name|KEY_PREFIX
operator|.
name|length
argument_list|()
argument_list|)
decl_stmt|;
return|return
name|key
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
literal|4
argument_list|)
operator|+
name|Utils
operator|.
name|DASH
operator|+
name|key
operator|.
name|substring
argument_list|(
literal|4
argument_list|)
return|;
block|}
comment|/**      * Get key from data identifier. Object is stored with key in S3.      */
specifier|private
specifier|static
name|String
name|getKeyName
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|)
block|{
name|String
name|key
init|=
name|identifier
operator|.
name|toString
argument_list|()
decl_stmt|;
return|return
name|key
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
literal|4
argument_list|)
operator|+
name|Utils
operator|.
name|DASH
operator|+
name|key
operator|.
name|substring
argument_list|(
literal|4
argument_list|)
return|;
block|}
comment|/**      * Get data identifier from key.      */
specifier|private
specifier|static
name|String
name|getIdentifierName
parameter_list|(
name|String
name|key
parameter_list|)
block|{
if|if
condition|(
operator|!
name|key
operator|.
name|contains
argument_list|(
name|Utils
operator|.
name|DASH
argument_list|)
condition|)
block|{
return|return
literal|null
return|;
block|}
elseif|else
if|if
condition|(
name|key
operator|.
name|contains
argument_list|(
name|META_KEY_PREFIX
argument_list|)
condition|)
block|{
return|return
name|key
return|;
block|}
return|return
name|key
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
literal|4
argument_list|)
operator|+
name|key
operator|.
name|substring
argument_list|(
literal|5
argument_list|)
return|;
block|}
comment|/**      * The class renames object key in S3 in a thread.      */
specifier|private
class|class
name|KeyRenameThread
implements|implements
name|Runnable
block|{
specifier|private
name|String
name|oldKey
decl_stmt|;
specifier|public
name|void
name|run
parameter_list|()
block|{
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|newS3Key
init|=
name|convertKey
argument_list|(
name|oldKey
argument_list|)
decl_stmt|;
name|CopyObjectRequest
name|copReq
init|=
operator|new
name|CopyObjectRequest
argument_list|(
name|bucket
argument_list|,
name|oldKey
argument_list|,
name|bucket
argument_list|,
name|newS3Key
argument_list|)
decl_stmt|;
name|Copy
name|copy
init|=
name|tmx
operator|.
name|copy
argument_list|(
name|s3ReqDecorator
operator|.
name|decorate
argument_list|(
name|copReq
argument_list|)
argument_list|)
decl_stmt|;
try|try
block|{
name|copy
operator|.
name|waitForCopyResult
argument_list|()
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"[{}] renamed to [{}] "
argument_list|,
name|oldKey
argument_list|,
name|newS3Key
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|ie
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|" Exception in renaming [{}] to [{}] "
argument_list|,
operator|new
name|Object
index|[]
block|{
name|ie
block|,
name|oldKey
block|,
name|newS3Key
block|}
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|public
name|KeyRenameThread
parameter_list|(
name|String
name|oldKey
parameter_list|)
block|{
name|this
operator|.
name|oldKey
operator|=
name|oldKey
expr_stmt|;
block|}
block|}
comment|/**      * Listener which receives callback on status of S3 upload.      */
specifier|private
class|class
name|S3UploadProgressListener
implements|implements
name|ProgressListener
block|{
specifier|private
name|File
name|file
decl_stmt|;
specifier|private
name|DataIdentifier
name|identifier
decl_stmt|;
specifier|private
name|AsyncUploadCallback
name|callback
decl_stmt|;
specifier|private
name|Upload
name|upload
decl_stmt|;
specifier|public
name|S3UploadProgressListener
parameter_list|(
name|Upload
name|upload
parameter_list|,
name|DataIdentifier
name|identifier
parameter_list|,
name|File
name|file
parameter_list|,
name|AsyncUploadCallback
name|callback
parameter_list|)
block|{
name|super
argument_list|()
expr_stmt|;
name|this
operator|.
name|identifier
operator|=
name|identifier
expr_stmt|;
name|this
operator|.
name|file
operator|=
name|file
expr_stmt|;
name|this
operator|.
name|callback
operator|=
name|callback
expr_stmt|;
name|this
operator|.
name|upload
operator|=
name|upload
expr_stmt|;
block|}
specifier|public
name|void
name|progressChanged
parameter_list|(
name|ProgressEvent
name|progressEvent
parameter_list|)
block|{
switch|switch
condition|(
name|progressEvent
operator|.
name|getEventCode
argument_list|()
condition|)
block|{
case|case
name|ProgressEvent
operator|.
name|COMPLETED_EVENT_CODE
case|:
name|callback
operator|.
name|onSuccess
argument_list|(
operator|new
name|AsyncUploadResult
argument_list|(
name|identifier
argument_list|,
name|file
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ProgressEvent
operator|.
name|FAILED_EVENT_CODE
case|:
name|AsyncUploadResult
name|result
init|=
operator|new
name|AsyncUploadResult
argument_list|(
name|identifier
argument_list|,
name|file
argument_list|)
decl_stmt|;
try|try
block|{
name|AmazonClientException
name|e
init|=
name|upload
operator|.
name|waitForException
argument_list|()
decl_stmt|;
if|if
condition|(
name|e
operator|!=
literal|null
condition|)
block|{
name|result
operator|.
name|setException
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|interrupt
argument_list|()
expr_stmt|;
block|}
name|callback
operator|.
name|onFailure
argument_list|(
name|result
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
block|}
comment|/**      * This class implements {@link Runnable} interface to upload {@link java.io.File}      * to S3 asynchronously.      */
specifier|private
class|class
name|AsyncUploadJob
implements|implements
name|Runnable
block|{
specifier|private
name|DataIdentifier
name|identifier
decl_stmt|;
specifier|private
name|File
name|file
decl_stmt|;
specifier|private
name|AsyncUploadCallback
name|callback
decl_stmt|;
specifier|public
name|AsyncUploadJob
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|,
name|File
name|file
parameter_list|,
name|AsyncUploadCallback
name|callback
parameter_list|)
block|{
name|super
argument_list|()
expr_stmt|;
name|this
operator|.
name|identifier
operator|=
name|identifier
expr_stmt|;
name|this
operator|.
name|file
operator|=
name|file
expr_stmt|;
name|this
operator|.
name|callback
operator|=
name|callback
expr_stmt|;
block|}
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
name|write
argument_list|(
name|identifier
argument_list|,
name|file
argument_list|,
literal|true
argument_list|,
name|callback
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Could not upload ["
operator|+
name|identifier
operator|+
literal|"], file["
operator|+
name|file
operator|+
literal|"]"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_class

end_unit

