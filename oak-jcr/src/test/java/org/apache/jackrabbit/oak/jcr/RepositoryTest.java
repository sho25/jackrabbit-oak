begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *   http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing,  * software distributed under the License is distributed on an  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  * KIND, either express or implied.  See the License for the  * specific language governing permissions and limitations  * under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|jcr
package|;
end_package

begin_import
import|import static
name|java
operator|.
name|util
operator|.
name|Arrays
operator|.
name|asList
import|;
end_import

begin_import
import|import static
name|javax
operator|.
name|jcr
operator|.
name|ImportUUIDBehavior
operator|.
name|IMPORT_UUID_CREATE_NEW
import|;
end_import

begin_import
import|import static
name|javax
operator|.
name|jcr
operator|.
name|Repository
operator|.
name|OPTION_NODE_AND_PROPERTY_WITH_SAME_NAME_SUPPORTED
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|commons
operator|.
name|JcrUtils
operator|.
name|getChildNodes
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|assertEquals
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|assertFalse
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|assertNotNull
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|assertThat
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|assertTrue
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|fail
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assume
operator|.
name|assumeTrue
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|matchers
operator|.
name|JUnitMatchers
operator|.
name|containsString
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|ByteArrayInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|ByteArrayOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStreamReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|Reader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|math
operator|.
name|BigDecimal
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Calendar
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|Binary
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|GuestCredentials
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|InvalidItemStateException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|Item
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|ItemExistsException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|NamespaceException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|NamespaceRegistry
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|NoSuchWorkspaceException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|Node
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|NodeIterator
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|PathNotFoundException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|Property
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|PropertyIterator
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|PropertyType
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|Repository
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|RepositoryException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|Session
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|SimpleCredentials
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|Value
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|ValueFactory
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|nodetype
operator|.
name|NodeDefinition
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|nodetype
operator|.
name|NodeType
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|nodetype
operator|.
name|NodeTypeManager
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|nodetype
operator|.
name|NodeTypeTemplate
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|nodetype
operator|.
name|PropertyDefinitionTemplate
import|;
end_import

begin_import
import|import
name|ch
operator|.
name|qos
operator|.
name|logback
operator|.
name|classic
operator|.
name|Level
import|;
end_import

begin_import
import|import
name|ch
operator|.
name|qos
operator|.
name|logback
operator|.
name|classic
operator|.
name|LoggerContext
import|;
end_import

begin_import
import|import
name|ch
operator|.
name|qos
operator|.
name|logback
operator|.
name|classic
operator|.
name|spi
operator|.
name|ILoggingEvent
import|;
end_import

begin_import
import|import
name|ch
operator|.
name|qos
operator|.
name|logback
operator|.
name|core
operator|.
name|Appender
import|;
end_import

begin_import
import|import
name|ch
operator|.
name|qos
operator|.
name|logback
operator|.
name|core
operator|.
name|AppenderBase
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Lists
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|JcrConstants
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|api
operator|.
name|JackrabbitNode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|api
operator|.
name|JackrabbitRepository
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|api
operator|.
name|ReferenceBinary
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|commons
operator|.
name|cnd
operator|.
name|CndImporter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|commons
operator|.
name|cnd
operator|.
name|ParseException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|commons
operator|.
name|jackrabbit
operator|.
name|SimpleReferenceBinary
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|RandomInputStream
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|fixture
operator|.
name|NodeStoreFixture
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|jcr
operator|.
name|repository
operator|.
name|RepositoryImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|plugins
operator|.
name|nodetype
operator|.
name|NodeTypeConstants
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|spi
operator|.
name|QValue
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|spi
operator|.
name|commons
operator|.
name|conversion
operator|.
name|DefaultNamePathResolver
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|spi
operator|.
name|commons
operator|.
name|value
operator|.
name|QValueFactoryImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|spi
operator|.
name|commons
operator|.
name|value
operator|.
name|QValueValue
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Before
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Ignore
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_class
specifier|public
class|class
name|RepositoryTest
extends|extends
name|AbstractRepositoryTest
block|{
specifier|private
specifier|static
specifier|final
name|String
name|TEST_NODE
init|=
literal|"test_node"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|TEST_PATH
init|=
literal|'/'
operator|+
name|TEST_NODE
decl_stmt|;
specifier|public
name|RepositoryTest
parameter_list|(
name|NodeStoreFixture
name|fixture
parameter_list|)
block|{
name|super
argument_list|(
name|fixture
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Before
specifier|public
name|void
name|setup
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|ValueFactory
name|valueFactory
init|=
name|session
operator|.
name|getValueFactory
argument_list|()
decl_stmt|;
name|Node
name|root
init|=
name|session
operator|.
name|getRootNode
argument_list|()
decl_stmt|;
name|Node
name|foo
init|=
name|root
operator|.
name|addNode
argument_list|(
literal|"foo"
argument_list|)
decl_stmt|;
name|foo
operator|.
name|setProperty
argument_list|(
literal|"stringProp"
argument_list|,
literal|"stringVal"
argument_list|)
expr_stmt|;
name|foo
operator|.
name|setProperty
argument_list|(
literal|"intProp"
argument_list|,
literal|42
argument_list|)
expr_stmt|;
name|foo
operator|.
name|setProperty
argument_list|(
literal|"mvProp"
argument_list|,
operator|new
name|Value
index|[]
block|{
name|valueFactory
operator|.
name|createValue
argument_list|(
literal|1
argument_list|)
block|,
name|valueFactory
operator|.
name|createValue
argument_list|(
literal|2
argument_list|)
block|,
name|valueFactory
operator|.
name|createValue
argument_list|(
literal|3
argument_list|)
block|,         }
argument_list|)
expr_stmt|;
name|root
operator|.
name|addNode
argument_list|(
literal|"bar"
argument_list|)
expr_stmt|;
name|root
operator|.
name|addNode
argument_list|(
name|TEST_NODE
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|createRepository
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Repository
name|repository
init|=
name|getRepository
argument_list|()
decl_stmt|;
name|assertNotNull
argument_list|(
name|repository
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|login
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|assertNotNull
argument_list|(
name|getAdminSession
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|loginWithAttribute
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
operator|(
operator|(
name|JackrabbitRepository
operator|)
name|getRepository
argument_list|()
operator|)
operator|.
name|login
argument_list|(
operator|new
name|GuestCredentials
argument_list|()
argument_list|,
literal|null
argument_list|,
name|Collections
operator|.
expr|<
name|String
argument_list|,
name|Object
operator|>
name|singletonMap
argument_list|(
name|RepositoryImpl
operator|.
name|REFRESH_INTERVAL
argument_list|,
literal|42
argument_list|)
argument_list|)
decl_stmt|;
name|String
index|[]
name|attributeNames
init|=
name|session
operator|.
name|getAttributeNames
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|attributeNames
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|RepositoryImpl
operator|.
name|REFRESH_INTERVAL
argument_list|,
name|attributeNames
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|42L
argument_list|,
name|session
operator|.
name|getAttribute
argument_list|(
name|RepositoryImpl
operator|.
name|REFRESH_INTERVAL
argument_list|)
argument_list|)
expr_stmt|;
name|session
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|loginWithCredentialsAttribute
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|SimpleCredentials
name|sc
init|=
name|getAdminCredentials
argument_list|()
decl_stmt|;
name|sc
operator|.
name|setAttribute
argument_list|(
literal|"attr"
argument_list|,
literal|"val"
argument_list|)
expr_stmt|;
name|Session
name|session
init|=
literal|null
decl_stmt|;
try|try
block|{
name|session
operator|=
name|getRepository
argument_list|()
operator|.
name|login
argument_list|(
name|sc
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|String
index|[]
name|attributeNames
init|=
name|session
operator|.
name|getAttributeNames
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|attributeNames
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"attr"
argument_list|,
name|attributeNames
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"val"
argument_list|,
name|session
operator|.
name|getAttribute
argument_list|(
literal|"attr"
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|session
operator|!=
literal|null
condition|)
block|{
name|session
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
argument_list|(
name|expected
operator|=
name|NoSuchWorkspaceException
operator|.
name|class
argument_list|)
specifier|public
name|void
name|loginInvalidWorkspace
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Repository
name|repository
init|=
name|getRepository
argument_list|()
decl_stmt|;
name|repository
operator|.
name|login
argument_list|(
operator|new
name|GuestCredentials
argument_list|()
argument_list|,
literal|"invalid"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Ignore
argument_list|(
literal|"OAK-118"
argument_list|)
comment|// TODO OAK-118: implement workspace management
annotation|@
name|Test
specifier|public
name|void
name|getWorkspaceNames
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|String
index|[]
name|workspaces
init|=
name|getAdminSession
argument_list|()
operator|.
name|getWorkspace
argument_list|()
operator|.
name|getAccessibleWorkspaceNames
argument_list|()
decl_stmt|;
name|Set
argument_list|<
name|String
argument_list|>
name|names
init|=
operator|new
name|HashSet
argument_list|<
name|String
argument_list|>
argument_list|()
block|{
block|{
name|add
argument_list|(
literal|"default"
argument_list|)
expr_stmt|;
block|}
block|}
decl_stmt|;
name|assertTrue
argument_list|(
name|asList
argument_list|(
name|workspaces
argument_list|)
operator|.
name|containsAll
argument_list|(
name|names
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|names
operator|.
name|containsAll
argument_list|(
name|asList
argument_list|(
name|workspaces
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Ignore
argument_list|(
literal|"OAK-118"
argument_list|)
comment|// TODO OAK-118: implement workspace management
annotation|@
name|Test
specifier|public
name|void
name|createDeleteWorkspace
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|getAdminSession
argument_list|()
operator|.
name|getWorkspace
argument_list|()
operator|.
name|createWorkspace
argument_list|(
literal|"new"
argument_list|)
expr_stmt|;
name|Session
name|session2
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
try|try
block|{
name|String
index|[]
name|workspaces
init|=
name|session2
operator|.
name|getWorkspace
argument_list|()
operator|.
name|getAccessibleWorkspaceNames
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
name|asList
argument_list|(
name|workspaces
argument_list|)
operator|.
name|contains
argument_list|(
literal|"new"
argument_list|)
argument_list|)
expr_stmt|;
name|Session
name|session3
init|=
name|getRepository
argument_list|()
operator|.
name|login
argument_list|(
literal|"new"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"new"
argument_list|,
name|session3
operator|.
name|getWorkspace
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|session3
operator|.
name|logout
argument_list|()
expr_stmt|;
name|session2
operator|.
name|getWorkspace
argument_list|()
operator|.
name|deleteWorkspace
argument_list|(
literal|"new"
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
name|Session
name|session4
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
try|try
block|{
name|String
index|[]
name|workspaces
init|=
name|session4
operator|.
name|getWorkspace
argument_list|()
operator|.
name|getAccessibleWorkspaceNames
argument_list|()
decl_stmt|;
name|assertFalse
argument_list|(
name|asList
argument_list|(
name|workspaces
argument_list|)
operator|.
name|contains
argument_list|(
literal|"new"
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session4
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|getRoot
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|root
init|=
name|getAdminSession
argument_list|()
operator|.
name|getRootNode
argument_list|()
decl_stmt|;
name|assertNotNull
argument_list|(
name|root
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|""
argument_list|,
name|root
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"/"
argument_list|,
name|root
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|getRootFromPath
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|root
init|=
name|getNode
argument_list|(
literal|"/"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|""
argument_list|,
name|root
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"/"
argument_list|,
name|root
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
argument_list|(
name|expected
operator|=
name|PathNotFoundException
operator|.
name|class
argument_list|)
specifier|public
name|void
name|getPropertyDot
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|node
operator|.
name|getProperty
argument_list|(
literal|"."
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
argument_list|(
name|expected
operator|=
name|PathNotFoundException
operator|.
name|class
argument_list|)
specifier|public
name|void
name|getPropertyDotDot
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|node
operator|.
name|getProperty
argument_list|(
literal|".."
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|hasPropertyDot
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|root
init|=
name|getNode
argument_list|(
literal|"/"
argument_list|)
decl_stmt|;
name|assertFalse
argument_list|(
operator|(
name|root
operator|.
name|hasProperty
argument_list|(
literal|"."
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|assertFalse
argument_list|(
operator|(
name|node
operator|.
name|hasProperty
argument_list|(
literal|"."
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|hasPropertyDotDot
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|root
init|=
name|getNode
argument_list|(
literal|"/"
argument_list|)
decl_stmt|;
name|assertFalse
argument_list|(
operator|(
name|root
operator|.
name|hasProperty
argument_list|(
literal|".."
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|assertFalse
argument_list|(
operator|(
name|node
operator|.
name|hasProperty
argument_list|(
literal|".."
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|getNodeDot
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|Node
name|same
init|=
name|node
operator|.
name|getNode
argument_list|(
literal|"."
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|same
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"foo"
argument_list|,
name|same
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|same
operator|.
name|isSame
argument_list|(
name|node
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|getNodeDotDot
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|Node
name|root
init|=
name|node
operator|.
name|getNode
argument_list|(
literal|".."
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|root
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|""
argument_list|,
name|root
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|root
operator|.
name|isSame
argument_list|(
name|node
operator|.
name|getParent
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
argument_list|(
name|expected
operator|=
name|PathNotFoundException
operator|.
name|class
argument_list|)
specifier|public
name|void
name|getRootGetDotDot
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|root
init|=
name|getNode
argument_list|(
literal|"/"
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|root
argument_list|)
expr_stmt|;
name|root
operator|.
name|getNode
argument_list|(
literal|".."
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|hasNodeDot
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|root
init|=
name|getNode
argument_list|(
literal|"/"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|root
operator|.
name|hasNode
argument_list|(
literal|"."
argument_list|)
argument_list|)
expr_stmt|;
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"."
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|hasNodeDotDot
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|root
init|=
name|getNode
argument_list|(
literal|"/"
argument_list|)
decl_stmt|;
name|assertFalse
argument_list|(
name|root
operator|.
name|hasNode
argument_list|(
literal|".."
argument_list|)
argument_list|)
expr_stmt|;
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|".."
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
argument_list|(
name|expected
operator|=
name|ItemExistsException
operator|.
name|class
argument_list|)
specifier|public
name|void
name|testAddNodeDot
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
comment|// add a node with '..' should fail...
name|node
operator|.
name|addNode
argument_list|(
literal|".."
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
argument_list|(
name|expected
operator|=
name|ItemExistsException
operator|.
name|class
argument_list|)
specifier|public
name|void
name|testAddNodeDotDot
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|node
operator|.
name|addNode
argument_list|(
literal|"."
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|getNode
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"foo"
argument_list|,
name|node
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"/foo"
argument_list|,
name|node
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|/**      * Test SNS 1-based indexed path.      * JCR 2.0, Chapter 22.2:      *<em>      *     A name in a content repository path that does not explicitly specify an index implies an index of 1.      *     For example, /a/b/c is equivalent to /a[1]/b[1]/c[1].      *</em>      *      * @throws RepositoryException      */
annotation|@
name|Test
specifier|public
name|void
name|getNodeSNS
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/foo[1]"
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"foo"
argument_list|,
name|node
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"/foo"
argument_list|,
name|node
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|node
operator|.
name|addNode
argument_list|(
literal|"bar"
argument_list|)
expr_stmt|;
name|Node
name|bar
init|=
name|getNode
argument_list|(
literal|"/foo[1]/bar[1]"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"/foo/bar"
argument_list|,
name|bar
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
try|try
block|{
name|getNode
argument_list|(
literal|"/foo[1]/bar[2]"
argument_list|)
expr_stmt|;
name|fail
argument_list|(
literal|"retrieving wrong SNS index should throw PathNotFoundException"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|PathNotFoundException
name|e
parameter_list|)
block|{
comment|// expected.
block|}
try|try
block|{
name|getProperty
argument_list|(
literal|"/foo[1]/bar[2]/jcr:primaryType"
argument_list|)
expr_stmt|;
name|fail
argument_list|(
literal|"retrieving wrong SNS index should throw PathNotFoundException"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|PathNotFoundException
name|e
parameter_list|)
block|{
comment|// expected.
block|}
name|assertTrue
argument_list|(
name|getAdminSession
argument_list|()
operator|.
name|nodeExists
argument_list|(
literal|"/foo[1]/bar[1]"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"bar[1]"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasProperty
argument_list|(
literal|"bar[1]/jcr:primaryType"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|getAdminSession
argument_list|()
operator|.
name|propertyExists
argument_list|(
literal|"/foo[1]/bar[1]/jcr:primaryType"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|getAdminSession
argument_list|()
operator|.
name|nodeExists
argument_list|(
literal|"/foo[1]/bar[2]"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"bar[2]"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|node
operator|.
name|hasProperty
argument_list|(
literal|"bar[2]/jcr:primaryType"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|getAdminSession
argument_list|()
operator|.
name|propertyExists
argument_list|(
literal|"/foo[1]/bar[2]/jcr:primaryType"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
argument_list|(
name|expected
operator|=
name|RepositoryException
operator|.
name|class
argument_list|)
specifier|public
name|void
name|getNodeAbsolutePath
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|root
init|=
name|getNode
argument_list|(
literal|"/"
argument_list|)
decl_stmt|;
name|root
operator|.
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|getNodeByIdentifier
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|String
name|id
init|=
name|node
operator|.
name|getIdentifier
argument_list|()
decl_stmt|;
name|Node
name|node2
init|=
name|getAdminSession
argument_list|()
operator|.
name|getNodeByIdentifier
argument_list|(
name|id
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|isSame
argument_list|(
name|node2
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|getNodeByUUID
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
operator|.
name|addNode
argument_list|(
literal|"boo"
argument_list|)
decl_stmt|;
name|node
operator|.
name|addMixin
argument_list|(
name|JcrConstants
operator|.
name|MIX_REFERENCEABLE
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|isNodeType
argument_list|(
name|JcrConstants
operator|.
name|MIX_REFERENCEABLE
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|uuid
init|=
name|node
operator|.
name|getUUID
argument_list|()
decl_stmt|;
name|assertNotNull
argument_list|(
name|uuid
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|uuid
argument_list|,
name|node
operator|.
name|getIdentifier
argument_list|()
argument_list|)
expr_stmt|;
name|Node
name|nAgain
init|=
name|node
operator|.
name|getSession
argument_list|()
operator|.
name|getNodeByUUID
argument_list|(
name|uuid
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|nAgain
operator|.
name|isSame
argument_list|(
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|nAgain
operator|.
name|isSame
argument_list|(
name|node
operator|.
name|getSession
argument_list|()
operator|.
name|getNodeByIdentifier
argument_list|(
name|uuid
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|Node
name|childNode
init|=
name|node
operator|.
name|addNode
argument_list|(
literal|"boohoo"
argument_list|)
decl_stmt|;
name|childNode
operator|.
name|addMixin
argument_list|(
name|JcrConstants
operator|.
name|MIX_REFERENCEABLE
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|childNode
operator|.
name|isNodeType
argument_list|(
name|JcrConstants
operator|.
name|MIX_REFERENCEABLE
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|childUuid
init|=
name|childNode
operator|.
name|getUUID
argument_list|()
decl_stmt|;
name|assertNotNull
argument_list|(
name|childUuid
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|childUuid
argument_list|,
name|childNode
operator|.
name|getIdentifier
argument_list|()
argument_list|)
expr_stmt|;
name|nAgain
operator|=
name|childNode
operator|.
name|getSession
argument_list|()
operator|.
name|getNodeByUUID
argument_list|(
name|childUuid
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|nAgain
operator|.
name|isSame
argument_list|(
name|childNode
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|nAgain
operator|.
name|isSame
argument_list|(
name|childNode
operator|.
name|getSession
argument_list|()
operator|.
name|getNodeByIdentifier
argument_list|(
name|childUuid
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|node
operator|.
name|getSession
argument_list|()
operator|.
name|move
argument_list|(
literal|"/foo/boo"
argument_list|,
literal|"/foo/boohoo"
argument_list|)
expr_stmt|;
name|node
operator|=
name|getNode
argument_list|(
literal|"/foo/boohoo"
argument_list|)
expr_stmt|;
name|nAgain
operator|=
name|node
operator|.
name|getSession
argument_list|()
operator|.
name|getNodeByUUID
argument_list|(
name|uuid
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|nAgain
operator|.
name|isSame
argument_list|(
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|nAgain
operator|.
name|isSame
argument_list|(
name|node
operator|.
name|getSession
argument_list|()
operator|.
name|getNodeByIdentifier
argument_list|(
name|uuid
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|getRootChildByUUID
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/"
argument_list|)
operator|.
name|addNode
argument_list|(
literal|"boo"
argument_list|)
decl_stmt|;
name|node
operator|.
name|addMixin
argument_list|(
name|JcrConstants
operator|.
name|MIX_REFERENCEABLE
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|isNodeType
argument_list|(
name|JcrConstants
operator|.
name|MIX_REFERENCEABLE
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|uuid
init|=
name|node
operator|.
name|getUUID
argument_list|()
decl_stmt|;
name|assertNotNull
argument_list|(
name|uuid
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|uuid
argument_list|,
name|node
operator|.
name|getIdentifier
argument_list|()
argument_list|)
expr_stmt|;
name|Node
name|nAgain
init|=
name|node
operator|.
name|getSession
argument_list|()
operator|.
name|getNodeByUUID
argument_list|(
name|uuid
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|nAgain
operator|.
name|isSame
argument_list|(
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|nAgain
operator|.
name|isSame
argument_list|(
name|node
operator|.
name|getSession
argument_list|()
operator|.
name|getNodeByIdentifier
argument_list|(
name|uuid
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|Node
name|childNode
init|=
name|node
operator|.
name|addNode
argument_list|(
literal|"boohoo"
argument_list|)
decl_stmt|;
name|childNode
operator|.
name|addMixin
argument_list|(
name|JcrConstants
operator|.
name|MIX_REFERENCEABLE
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|childNode
operator|.
name|isNodeType
argument_list|(
name|JcrConstants
operator|.
name|MIX_REFERENCEABLE
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|childUuid
init|=
name|childNode
operator|.
name|getUUID
argument_list|()
decl_stmt|;
name|assertNotNull
argument_list|(
name|childUuid
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|childUuid
argument_list|,
name|childNode
operator|.
name|getIdentifier
argument_list|()
argument_list|)
expr_stmt|;
name|nAgain
operator|=
name|childNode
operator|.
name|getSession
argument_list|()
operator|.
name|getNodeByUUID
argument_list|(
name|childUuid
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|nAgain
operator|.
name|isSame
argument_list|(
name|childNode
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|nAgain
operator|.
name|isSame
argument_list|(
name|childNode
operator|.
name|getSession
argument_list|()
operator|.
name|getNodeByIdentifier
argument_list|(
name|childUuid
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|node
operator|.
name|getSession
argument_list|()
operator|.
name|move
argument_list|(
literal|"/boo"
argument_list|,
literal|"/boohoo"
argument_list|)
expr_stmt|;
name|node
operator|=
name|getNode
argument_list|(
literal|"/boohoo"
argument_list|)
expr_stmt|;
name|nAgain
operator|=
name|node
operator|.
name|getSession
argument_list|()
operator|.
name|getNodeByUUID
argument_list|(
name|uuid
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|nAgain
operator|.
name|isSame
argument_list|(
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|nAgain
operator|.
name|isSame
argument_list|(
name|node
operator|.
name|getSession
argument_list|()
operator|.
name|getNodeByIdentifier
argument_list|(
name|uuid
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|getNodeFromNode
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|root
init|=
name|getNode
argument_list|(
literal|"/"
argument_list|)
decl_stmt|;
name|Node
name|node
init|=
name|root
operator|.
name|getNode
argument_list|(
literal|"foo"
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"foo"
argument_list|,
name|node
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"/foo"
argument_list|,
name|node
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|Node
name|nodeAgain
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|isSame
argument_list|(
name|nodeAgain
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|getNodes
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|test
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|test
operator|.
name|addNode
argument_list|(
literal|"foo"
argument_list|)
expr_stmt|;
name|test
operator|.
name|addNode
argument_list|(
literal|"bar"
argument_list|)
expr_stmt|;
name|test
operator|.
name|addNode
argument_list|(
literal|"baz"
argument_list|)
expr_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Set
argument_list|<
name|String
argument_list|>
name|nodeNames
init|=
operator|new
name|HashSet
argument_list|<
name|String
argument_list|>
argument_list|()
block|{
block|{
name|add
argument_list|(
literal|"bar"
argument_list|)
expr_stmt|;
name|add
argument_list|(
literal|"added"
argument_list|)
expr_stmt|;
name|add
argument_list|(
literal|"baz"
argument_list|)
expr_stmt|;
block|}
block|}
decl_stmt|;
name|test
operator|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
expr_stmt|;
name|test
operator|.
name|addNode
argument_list|(
literal|"added"
argument_list|)
expr_stmt|;
comment|// transiently added
name|test
operator|.
name|getNode
argument_list|(
literal|"foo"
argument_list|)
operator|.
name|remove
argument_list|()
expr_stmt|;
comment|// transiently removed
name|test
operator|.
name|getNode
argument_list|(
literal|"bar"
argument_list|)
operator|.
name|remove
argument_list|()
expr_stmt|;
comment|// transiently removed and...
name|test
operator|.
name|addNode
argument_list|(
literal|"bar"
argument_list|)
expr_stmt|;
comment|// ... added again
name|NodeIterator
name|nodes
init|=
name|test
operator|.
name|getNodes
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|3
argument_list|,
name|nodes
operator|.
name|getSize
argument_list|()
argument_list|)
expr_stmt|;
while|while
condition|(
name|nodes
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|String
name|name
init|=
name|nodes
operator|.
name|nextNode
argument_list|()
operator|.
name|getName
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
name|nodeNames
operator|.
name|remove
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|assertTrue
argument_list|(
name|nodeNames
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|getProperties
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Set
argument_list|<
name|String
argument_list|>
name|propertyNames
init|=
operator|new
name|HashSet
argument_list|<
name|String
argument_list|>
argument_list|()
block|{
block|{
name|add
argument_list|(
literal|"intProp"
argument_list|)
expr_stmt|;
name|add
argument_list|(
literal|"mvProp"
argument_list|)
expr_stmt|;
name|add
argument_list|(
literal|"added"
argument_list|)
expr_stmt|;
block|}
block|}
decl_stmt|;
name|Set
argument_list|<
name|String
argument_list|>
name|values
init|=
operator|new
name|HashSet
argument_list|<
name|String
argument_list|>
argument_list|()
block|{
block|{
name|add
argument_list|(
literal|"added"
argument_list|)
expr_stmt|;
name|add
argument_list|(
literal|"1"
argument_list|)
expr_stmt|;
name|add
argument_list|(
literal|"2"
argument_list|)
expr_stmt|;
name|add
argument_list|(
literal|"3"
argument_list|)
expr_stmt|;
name|add
argument_list|(
literal|"42"
argument_list|)
expr_stmt|;
block|}
block|}
decl_stmt|;
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|node
operator|.
name|setProperty
argument_list|(
literal|"added"
argument_list|,
literal|"added"
argument_list|)
expr_stmt|;
comment|// transiently added
name|node
operator|.
name|getProperty
argument_list|(
literal|"stringProp"
argument_list|)
operator|.
name|remove
argument_list|()
expr_stmt|;
comment|// transiently removed
name|node
operator|.
name|getProperty
argument_list|(
literal|"intProp"
argument_list|)
operator|.
name|remove
argument_list|()
expr_stmt|;
comment|// transiently removed...
name|node
operator|.
name|setProperty
argument_list|(
literal|"intProp"
argument_list|,
literal|42
argument_list|)
expr_stmt|;
comment|// ...and added again
name|PropertyIterator
name|properties
init|=
name|node
operator|.
name|getProperties
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|4
argument_list|,
name|properties
operator|.
name|getSize
argument_list|()
argument_list|)
expr_stmt|;
while|while
condition|(
name|properties
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|Property
name|p
init|=
name|properties
operator|.
name|nextProperty
argument_list|()
decl_stmt|;
if|if
condition|(
name|JcrConstants
operator|.
name|JCR_PRIMARYTYPE
operator|.
name|equals
argument_list|(
name|p
operator|.
name|getName
argument_list|()
argument_list|)
condition|)
block|{
continue|continue;
block|}
name|assertTrue
argument_list|(
name|propertyNames
operator|.
name|remove
argument_list|(
name|p
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|.
name|isMultiple
argument_list|()
condition|)
block|{
for|for
control|(
name|Value
name|v
range|:
name|p
operator|.
name|getValues
argument_list|()
control|)
block|{
name|assertTrue
argument_list|(
name|values
operator|.
name|remove
argument_list|(
name|v
operator|.
name|getString
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|assertTrue
argument_list|(
name|values
operator|.
name|remove
argument_list|(
name|p
operator|.
name|getString
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|assertTrue
argument_list|(
name|propertyNames
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|values
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
argument_list|(
name|expected
operator|=
name|PathNotFoundException
operator|.
name|class
argument_list|)
specifier|public
name|void
name|getNonExistingNode
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|getNode
argument_list|(
literal|"/qoo"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|getProperty
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Property
name|property
init|=
name|getProperty
argument_list|(
literal|"/foo/stringProp"
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|property
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"stringProp"
argument_list|,
name|property
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"/foo/stringProp"
argument_list|,
name|property
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|Value
name|value
init|=
name|property
operator|.
name|getValue
argument_list|()
decl_stmt|;
name|assertNotNull
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|STRING
argument_list|,
name|value
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"stringVal"
argument_list|,
name|value
operator|.
name|getString
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|getPropertyFromNode
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|node
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|Property
name|property
init|=
name|node
operator|.
name|getProperty
argument_list|(
literal|"stringProp"
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|property
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"stringProp"
argument_list|,
name|property
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"/foo/stringProp"
argument_list|,
name|property
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|Value
name|value
init|=
name|property
operator|.
name|getValue
argument_list|()
decl_stmt|;
name|assertNotNull
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|STRING
argument_list|,
name|value
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"stringVal"
argument_list|,
name|value
operator|.
name|getString
argument_list|()
argument_list|)
expr_stmt|;
name|Property
name|propertyAgain
init|=
name|getProperty
argument_list|(
literal|"/foo/stringProp"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isSame
argument_list|(
name|propertyAgain
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addNode
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|String
name|newNode
init|=
name|TEST_PATH
operator|+
literal|"/new"
decl_stmt|;
name|assertFalse
argument_list|(
name|session
operator|.
name|nodeExists
argument_list|(
name|newNode
argument_list|)
argument_list|)
expr_stmt|;
name|Node
name|node
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Node
name|added
init|=
name|node
operator|.
name|addNode
argument_list|(
literal|"new"
argument_list|)
decl_stmt|;
name|assertFalse
argument_list|(
name|node
operator|.
name|isNew
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|isModified
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|added
operator|.
name|isNew
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|added
operator|.
name|isModified
argument_list|()
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|assertTrue
argument_list|(
name|session2
operator|.
name|nodeExists
argument_list|(
name|newNode
argument_list|)
argument_list|)
expr_stmt|;
name|added
operator|=
name|session2
operator|.
name|getNode
argument_list|(
name|newNode
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|added
operator|.
name|isNew
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|added
operator|.
name|isModified
argument_list|()
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|testIsNew
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|InterruptedException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|root
init|=
name|session
operator|.
name|getRootNode
argument_list|()
decl_stmt|;
name|Node
name|node1
init|=
name|root
operator|.
name|addNode
argument_list|(
literal|"node1"
argument_list|)
decl_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|node1
operator|.
name|remove
argument_list|()
expr_stmt|;
name|Node
name|node2
init|=
name|root
operator|.
name|addNode
argument_list|(
literal|"node2"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
literal|"The Node is just added"
argument_list|,
name|node2
operator|.
name|isNew
argument_list|()
argument_list|)
expr_stmt|;
name|Node
name|node1Again
init|=
name|root
operator|.
name|addNode
argument_list|(
literal|"node1"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
literal|"The Node is just added but has a remove in same commit"
argument_list|,
name|node1Again
operator|.
name|isNew
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testAddNodeWithExpandedName
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|session
operator|.
name|getWorkspace
argument_list|()
operator|.
name|getNamespaceRegistry
argument_list|()
operator|.
name|registerNamespace
argument_list|(
literal|"foo"
argument_list|,
literal|"http://foo"
argument_list|)
expr_stmt|;
name|Node
name|node
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Node
name|added
init|=
name|node
operator|.
name|addNode
argument_list|(
literal|"{http://foo}new"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"foo:new"
argument_list|,
name|added
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|added
operator|=
name|session
operator|.
name|getNode
argument_list|(
name|TEST_PATH
operator|+
literal|"/{http://foo}new"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"foo:new"
argument_list|,
name|added
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addNodeWithSpecialChars
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|String
name|nodeName
init|=
literal|"foo{"
decl_stmt|;
name|String
name|newNode
init|=
name|TEST_PATH
operator|+
literal|'/'
operator|+
name|nodeName
decl_stmt|;
name|assertFalse
argument_list|(
name|session
operator|.
name|nodeExists
argument_list|(
name|newNode
argument_list|)
argument_list|)
expr_stmt|;
name|Node
name|node
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|node
operator|.
name|addNode
argument_list|(
name|nodeName
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|assertTrue
argument_list|(
name|session2
operator|.
name|nodeExists
argument_list|(
name|newNode
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|addNodeWithNodeType
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|node
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|node
operator|.
name|addNode
argument_list|(
literal|"new"
argument_list|,
literal|"nt:folder"
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addNodeToRootNode
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|root
init|=
name|session
operator|.
name|getRootNode
argument_list|()
decl_stmt|;
name|String
name|newNode
init|=
literal|"newNodeBelowRoot"
decl_stmt|;
name|assertFalse
argument_list|(
name|root
operator|.
name|hasNode
argument_list|(
name|newNode
argument_list|)
argument_list|)
expr_stmt|;
name|root
operator|.
name|addNode
argument_list|(
name|newNode
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addStringProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|addProperty
argument_list|(
name|parentNode
argument_list|,
literal|"string"
argument_list|,
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"string value"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testGetItemReturnsNodeBeforeProperty
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|String
name|snnpSupported
init|=
name|getRepository
argument_list|()
operator|.
name|getDescriptor
argument_list|(
name|OPTION_NODE_AND_PROPERTY_WITH_SAME_NAME_SUPPORTED
argument_list|)
decl_stmt|;
name|assumeTrue
argument_list|(
name|Boolean
operator|.
name|valueOf
argument_list|(
name|snnpSupported
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|newNodeName
init|=
literal|"getItemTest"
decl_stmt|;
name|String
name|nodeAndPropertyName
init|=
literal|"subnode"
decl_stmt|;
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|root
init|=
name|session
operator|.
name|getRootNode
argument_list|()
decl_stmt|;
name|assertFalse
argument_list|(
name|root
operator|.
name|hasNode
argument_list|(
name|newNodeName
argument_list|)
argument_list|)
expr_stmt|;
name|Node
name|newNode
init|=
name|root
operator|.
name|addNode
argument_list|(
name|newNodeName
argument_list|,
name|NodeTypeConstants
operator|.
name|NT_OAK_UNSTRUCTURED
argument_list|)
decl_stmt|;
name|newNode
operator|.
name|setProperty
argument_list|(
name|nodeAndPropertyName
argument_list|,
literal|"prop value"
argument_list|)
expr_stmt|;
name|newNode
operator|.
name|addNode
argument_list|(
name|nodeAndPropertyName
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|Item
name|item
init|=
name|session
operator|.
name|getItem
argument_list|(
literal|"/"
operator|+
name|newNodeName
operator|+
literal|"/"
operator|+
name|nodeAndPropertyName
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
literal|"should retrieve Node before property"
argument_list|,
name|item
operator|.
name|isNode
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addMultiValuedString
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|2
index|]
decl_stmt|;
name|values
index|[
literal|0
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"one"
argument_list|)
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"two"
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi string"
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi string"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|STRING
argument_list|,
name|property
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|values
operator|.
name|length
argument_list|,
name|values2
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|0
index|]
argument_list|,
name|values2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|1
index|]
argument_list|,
name|values2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|addLongProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|addProperty
argument_list|(
name|parentNode
argument_list|,
literal|"long"
argument_list|,
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|42L
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addMultiValuedLong
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|2
index|]
decl_stmt|;
name|values
index|[
literal|0
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|42L
argument_list|)
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|84L
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi long"
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi long"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|LONG
argument_list|,
name|property
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|values
operator|.
name|length
argument_list|,
name|values2
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|0
index|]
argument_list|,
name|values2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|1
index|]
argument_list|,
name|values2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|addDoubleProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|addProperty
argument_list|(
name|parentNode
argument_list|,
literal|"double"
argument_list|,
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|42.2D
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addMultiValuedDouble
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|2
index|]
decl_stmt|;
name|values
index|[
literal|0
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|42.1d
argument_list|)
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|99.0d
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi double"
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi double"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|DOUBLE
argument_list|,
name|property
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|values
operator|.
name|length
argument_list|,
name|values2
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|0
index|]
argument_list|,
name|values2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|1
index|]
argument_list|,
name|values2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|addBooleanProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|addProperty
argument_list|(
name|parentNode
argument_list|,
literal|"boolean"
argument_list|,
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|true
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addMultiValuedBoolean
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|2
index|]
decl_stmt|;
name|values
index|[
literal|0
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi boolean"
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi boolean"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|BOOLEAN
argument_list|,
name|property
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|values
operator|.
name|length
argument_list|,
name|values2
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|0
index|]
argument_list|,
name|values2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|1
index|]
argument_list|,
name|values2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|addDecimalProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|addProperty
argument_list|(
name|parentNode
argument_list|,
literal|"decimal"
argument_list|,
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|BigDecimal
operator|.
name|valueOf
argument_list|(
literal|21
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addMultiValuedDecimal
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|2
index|]
decl_stmt|;
name|values
index|[
literal|0
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|BigDecimal
operator|.
name|valueOf
argument_list|(
literal|42
argument_list|)
argument_list|)
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|BigDecimal
operator|.
name|valueOf
argument_list|(
literal|99
argument_list|)
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi decimal"
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi decimal"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|DECIMAL
argument_list|,
name|property
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|values
operator|.
name|length
argument_list|,
name|values2
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|0
index|]
argument_list|,
name|values2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|1
index|]
argument_list|,
name|values2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|addDateProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|addProperty
argument_list|(
name|parentNode
argument_list|,
literal|"date"
argument_list|,
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|Calendar
operator|.
name|getInstance
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addMultiValuedDate
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|2
index|]
decl_stmt|;
name|Calendar
name|calendar
init|=
name|Calendar
operator|.
name|getInstance
argument_list|()
decl_stmt|;
name|values
index|[
literal|0
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|calendar
argument_list|)
expr_stmt|;
name|calendar
operator|.
name|add
argument_list|(
name|Calendar
operator|.
name|DAY_OF_MONTH
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|calendar
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi date"
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi date"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|DATE
argument_list|,
name|property
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|values
operator|.
name|length
argument_list|,
name|values2
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|0
index|]
argument_list|,
name|values2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|1
index|]
argument_list|,
name|values2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|addURIProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|addProperty
argument_list|(
name|parentNode
argument_list|,
literal|"uri"
argument_list|,
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"http://www.day.com/"
argument_list|,
name|PropertyType
operator|.
name|URI
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addMultiValuedURI
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|2
index|]
decl_stmt|;
name|values
index|[
literal|0
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"http://www.day.com"
argument_list|,
name|PropertyType
operator|.
name|URI
argument_list|)
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"file://var/dam"
argument_list|,
name|PropertyType
operator|.
name|URI
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi uri"
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi uri"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|URI
argument_list|,
name|property
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|values
operator|.
name|length
argument_list|,
name|values2
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|0
index|]
argument_list|,
name|values2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|1
index|]
argument_list|,
name|values2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|addNameProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|addProperty
argument_list|(
name|parentNode
argument_list|,
literal|"name"
argument_list|,
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"jcr:something\""
argument_list|,
name|PropertyType
operator|.
name|NAME
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addMultiValuedName
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|2
index|]
decl_stmt|;
name|values
index|[
literal|0
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"jcr:foo"
argument_list|,
name|PropertyType
operator|.
name|NAME
argument_list|)
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"bar"
argument_list|,
name|PropertyType
operator|.
name|NAME
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi name"
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi name"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|NAME
argument_list|,
name|property
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|values
operator|.
name|length
argument_list|,
name|values2
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|0
index|]
argument_list|,
name|values2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|1
index|]
argument_list|,
name|values2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|addEmptyMultiValue
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|0
index|]
decl_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi value"
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi value"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|STRING
argument_list|,
name|property
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|values2
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|addEmptyMultiValueName
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|0
index|]
decl_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi name"
argument_list|,
name|values
argument_list|,
name|PropertyType
operator|.
name|NAME
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi name"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|NAME
argument_list|,
name|property
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|values2
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|addPathProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|addProperty
argument_list|(
name|parentNode
argument_list|,
literal|"path"
argument_list|,
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"/jcr:foo/bar\""
argument_list|,
name|PropertyType
operator|.
name|PATH
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addMultiValuedPath
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|2
index|]
decl_stmt|;
name|values
index|[
literal|0
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"/nt:foo/jcr:bar"
argument_list|,
name|PropertyType
operator|.
name|PATH
argument_list|)
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"/"
argument_list|,
name|PropertyType
operator|.
name|PATH
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi path"
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi path"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|PATH
argument_list|,
name|property
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|values
operator|.
name|length
argument_list|,
name|values2
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|0
index|]
argument_list|,
name|values2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|1
index|]
argument_list|,
name|values2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|addBinaryProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|InputStream
name|is
init|=
operator|new
name|ByteArrayInputStream
argument_list|(
literal|"foo\""
operator|.
name|getBytes
argument_list|()
argument_list|)
decl_stmt|;
name|Binary
name|bin
init|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createBinary
argument_list|(
name|is
argument_list|)
decl_stmt|;
name|addProperty
argument_list|(
name|parentNode
argument_list|,
literal|"binary"
argument_list|,
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|bin
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addSmallBinaryProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|InputStream
name|is
init|=
operator|new
name|NumberStream
argument_list|(
literal|1234
argument_list|)
decl_stmt|;
name|Binary
name|bin
init|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createBinary
argument_list|(
name|is
argument_list|)
decl_stmt|;
name|addProperty
argument_list|(
name|parentNode
argument_list|,
literal|"bigBinary"
argument_list|,
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|bin
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addBigBinaryProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|InputStream
name|is
init|=
operator|new
name|NumberStream
argument_list|(
literal|123456
argument_list|)
decl_stmt|;
name|Binary
name|bin
init|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createBinary
argument_list|(
name|is
argument_list|)
decl_stmt|;
name|addProperty
argument_list|(
name|parentNode
argument_list|,
literal|"bigBinary"
argument_list|,
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|bin
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addAlienBinaryProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|QValue
name|qValue
init|=
name|QValueFactoryImpl
operator|.
name|getInstance
argument_list|()
operator|.
name|create
argument_list|(
literal|"binaryValue"
operator|.
name|getBytes
argument_list|()
argument_list|)
decl_stmt|;
name|Value
name|value
init|=
operator|new
name|QValueValue
argument_list|(
name|qValue
argument_list|,
operator|new
name|DefaultNamePathResolver
argument_list|(
name|session
argument_list|)
argument_list|)
decl_stmt|;
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
operator|.
name|setProperty
argument_list|(
literal|"binary"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|Value
name|valueAgain
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
operator|.
name|getProperty
argument_list|(
literal|"binary"
argument_list|)
operator|.
name|getValue
argument_list|()
decl_stmt|;
name|assertEqualStream
argument_list|(
name|value
operator|.
name|getBinary
argument_list|()
operator|.
name|getStream
argument_list|()
argument_list|,
name|valueAgain
operator|.
name|getBinary
argument_list|()
operator|.
name|getStream
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addMultiValuedBinary
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|2
index|]
decl_stmt|;
name|InputStream
name|is
init|=
operator|new
name|ByteArrayInputStream
argument_list|(
literal|"foo"
operator|.
name|getBytes
argument_list|()
argument_list|)
decl_stmt|;
name|Binary
name|bin
init|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createBinary
argument_list|(
name|is
argument_list|)
decl_stmt|;
name|values
index|[
literal|0
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|bin
argument_list|)
expr_stmt|;
name|is
operator|=
operator|new
name|ByteArrayInputStream
argument_list|(
literal|"bar"
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|bin
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createBinary
argument_list|(
name|is
argument_list|)
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|bin
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi binary"
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi binary"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|BINARY
argument_list|,
name|property
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|values
operator|.
name|length
argument_list|,
name|values2
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|0
index|]
argument_list|,
name|values2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|1
index|]
argument_list|,
name|values2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|addReferenceProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Node
name|referee
init|=
name|getAdminSession
argument_list|()
operator|.
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|referee
operator|.
name|addMixin
argument_list|(
literal|"mix:referenceable"
argument_list|)
expr_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|addProperty
argument_list|(
name|parentNode
argument_list|,
literal|"reference"
argument_list|,
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|referee
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addMultiValuedReference
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Node
name|referee
init|=
name|getAdminSession
argument_list|()
operator|.
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|referee
operator|.
name|addMixin
argument_list|(
literal|"mix:referenceable"
argument_list|)
expr_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|2
index|]
decl_stmt|;
name|values
index|[
literal|0
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|referee
argument_list|)
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|referee
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi reference"
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi reference"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|REFERENCE
argument_list|,
name|property
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|values
operator|.
name|length
argument_list|,
name|values2
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|0
index|]
argument_list|,
name|values2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|1
index|]
argument_list|,
name|values2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|addWeakReferenceProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Node
name|referee
init|=
name|getAdminSession
argument_list|()
operator|.
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|referee
operator|.
name|addMixin
argument_list|(
literal|"mix:referenceable"
argument_list|)
expr_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|addProperty
argument_list|(
name|parentNode
argument_list|,
literal|"weak reference"
argument_list|,
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|referee
argument_list|,
literal|true
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|addMultiValuedWeakReference
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Node
name|referee
init|=
name|getAdminSession
argument_list|()
operator|.
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|referee
operator|.
name|addMixin
argument_list|(
literal|"mix:referenceable"
argument_list|)
expr_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|2
index|]
decl_stmt|;
name|values
index|[
literal|0
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|referee
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|referee
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi weak reference"
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi weak reference"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|WEAKREFERENCE
argument_list|,
name|property
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|values
operator|.
name|length
argument_list|,
name|values2
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|0
index|]
argument_list|,
name|values2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|1
index|]
argument_list|,
name|values2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|addEmptyMultiValuedProperty
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|0
index|]
decl_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi empty"
argument_list|,
name|values
argument_list|,
name|PropertyType
operator|.
name|BOOLEAN
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi empty"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|values2
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|addMultiValuedStringWithNull
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|3
index|]
decl_stmt|;
name|values
index|[
literal|0
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|values
index|[
literal|2
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi with null"
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi with null"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|PropertyType
operator|.
name|BOOLEAN
argument_list|,
name|property
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|values
operator|.
name|length
operator|-
literal|1
argument_list|,
name|values2
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|transientChanges
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Node
name|node
init|=
name|parentNode
operator|.
name|addNode
argument_list|(
literal|"test"
argument_list|)
decl_stmt|;
name|assertFalse
argument_list|(
name|node
operator|.
name|hasProperty
argument_list|(
literal|"p"
argument_list|)
argument_list|)
expr_stmt|;
name|node
operator|.
name|setProperty
argument_list|(
literal|"p"
argument_list|,
literal|"pv"
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasProperty
argument_list|(
literal|"p"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"n"
argument_list|)
argument_list|)
expr_stmt|;
name|node
operator|.
name|addNode
argument_list|(
literal|"n"
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"n"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasProperties
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasNodes
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|setStringProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|addProperty
argument_list|(
name|parentNode
argument_list|,
literal|"string"
argument_list|,
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"string \" value"
argument_list|)
argument_list|)
expr_stmt|;
name|Property
name|property
init|=
name|parentNode
operator|.
name|getProperty
argument_list|(
literal|"string"
argument_list|)
decl_stmt|;
name|property
operator|.
name|setValue
argument_list|(
literal|"new value"
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|parentNode
operator|.
name|isModified
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isModified
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|property
operator|.
name|isNew
argument_list|()
argument_list|)
expr_stmt|;
name|property
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property2
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/string"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"new value"
argument_list|,
name|property2
operator|.
name|getString
argument_list|()
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|setPropertyAgain
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Property
name|p1
init|=
name|session
operator|.
name|getProperty
argument_list|(
literal|"/foo/stringProp"
argument_list|)
decl_stmt|;
name|Property
name|p2
init|=
name|p1
operator|.
name|getParent
argument_list|()
operator|.
name|setProperty
argument_list|(
literal|"stringProp"
argument_list|,
literal|"newValue"
argument_list|)
decl_stmt|;
name|Property
name|p3
init|=
name|session
operator|.
name|getProperty
argument_list|(
literal|"/foo/stringProp"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"newValue"
argument_list|,
name|p1
operator|.
name|getString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"newValue"
argument_list|,
name|p2
operator|.
name|getString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"newValue"
argument_list|,
name|p3
operator|.
name|getString
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// OAK-6410
annotation|@
name|Ignore
argument_list|(
literal|"OAK-6410"
argument_list|)
annotation|@
name|Test
specifier|public
name|void
name|setInexistentProperty
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|node
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|node
operator|.
name|addMixin
argument_list|(
name|JcrConstants
operator|.
name|MIX_VERSIONABLE
argument_list|)
expr_stmt|;
name|node
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|node
operator|.
name|getSession
argument_list|()
operator|.
name|getWorkspace
argument_list|()
operator|.
name|getVersionManager
argument_list|()
operator|.
name|checkin
argument_list|(
name|TEST_PATH
argument_list|)
expr_stmt|;
name|node
operator|.
name|setProperty
argument_list|(
literal|"inexistent"
argument_list|,
operator|(
name|Value
operator|)
literal|null
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|setDoubleNaNProperty
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|addProperty
argument_list|(
name|parentNode
argument_list|,
literal|"NaN"
argument_list|,
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|Double
operator|.
name|NaN
argument_list|)
argument_list|)
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property2
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/NaN"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|Double
operator|.
name|isNaN
argument_list|(
name|property2
operator|.
name|getDouble
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|setMultiValuedProperty
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Value
index|[]
name|values
init|=
operator|new
name|Value
index|[
literal|2
index|]
decl_stmt|;
name|values
index|[
literal|0
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"one"
argument_list|)
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"two"
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi string2"
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|values
index|[
literal|0
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"eins"
argument_list|)
expr_stmt|;
name|values
index|[
literal|1
index|]
operator|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
literal|"zwei"
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"multi string2"
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Property
name|property
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/multi string2"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|property
operator|.
name|isMultiple
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|values2
init|=
name|property
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|values
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|0
index|]
argument_list|,
name|values2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|values
index|[
literal|1
index|]
argument_list|,
name|values2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|nullProperty
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"newProperty"
argument_list|,
literal|"some value"
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
try|try
block|{
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/newProperty"
argument_list|)
operator|.
name|setValue
argument_list|(
operator|(
name|String
operator|)
literal|null
argument_list|)
expr_stmt|;
name|session2
operator|.
name|save
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
name|Session
name|session3
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|assertFalse
argument_list|(
name|session3
operator|.
name|propertyExists
argument_list|(
name|TEST_PATH
operator|+
literal|"/newProperty"
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session3
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|setPropertyWithConversion
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|n
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Node
name|file
init|=
name|n
operator|.
name|addNode
argument_list|(
literal|"file"
argument_list|,
literal|"nt:file"
argument_list|)
decl_stmt|;
name|Node
name|content
init|=
name|file
operator|.
name|addNode
argument_list|(
literal|"jcr:content"
argument_list|,
literal|"nt:resource"
argument_list|)
decl_stmt|;
name|long
name|value
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|Property
name|property
init|=
name|content
operator|.
name|setProperty
argument_list|(
literal|"jcr:lastModified"
argument_list|,
name|value
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|value
argument_list|,
name|property
operator|.
name|getDate
argument_list|()
operator|.
name|getTimeInMillis
argument_list|()
argument_list|)
expr_stmt|;
name|content
operator|.
name|setProperty
argument_list|(
literal|"jcr:data"
argument_list|,
operator|new
name|ByteArrayInputStream
argument_list|(
literal|"foo"
operator|.
name|getBytes
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|content
operator|.
name|setProperty
argument_list|(
literal|"jcr:mimeType"
argument_list|,
literal|"text/plain"
argument_list|)
expr_stmt|;
name|n
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|removeProperty
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|parentNode
operator|.
name|setProperty
argument_list|(
literal|"newProperty"
argument_list|,
literal|"some value"
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
try|try
block|{
name|session2
operator|.
name|getProperty
argument_list|(
name|TEST_PATH
operator|+
literal|"/newProperty"
argument_list|)
operator|.
name|remove
argument_list|()
expr_stmt|;
name|session2
operator|.
name|save
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
name|Session
name|session3
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|assertFalse
argument_list|(
name|session3
operator|.
name|propertyExists
argument_list|(
name|TEST_PATH
operator|+
literal|"/newProperty"
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session3
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|removeNode
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|parentNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|parentNode
operator|.
name|addNode
argument_list|(
literal|"newNode"
argument_list|)
expr_stmt|;
name|parentNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Node
name|removeNode
init|=
name|session2
operator|.
name|getNode
argument_list|(
name|TEST_PATH
operator|+
literal|"/newNode"
argument_list|)
decl_stmt|;
name|removeNode
operator|.
name|remove
argument_list|()
expr_stmt|;
try|try
block|{
name|removeNode
operator|.
name|getParent
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"Cannot retrieve the parent from a transiently removed item."
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InvalidItemStateException
name|expected
parameter_list|)
block|{             }
name|assertTrue
argument_list|(
name|session2
operator|.
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
operator|.
name|isModified
argument_list|()
argument_list|)
expr_stmt|;
name|session2
operator|.
name|save
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
name|Session
name|session3
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|assertFalse
argument_list|(
name|session3
operator|.
name|nodeExists
argument_list|(
name|TEST_PATH
operator|+
literal|"/newNode"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|session3
operator|.
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
operator|.
name|isModified
argument_list|()
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session3
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|removeNode2
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|foo
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|removeItem
argument_list|(
name|foo
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
try|try
block|{
name|foo
operator|.
name|getParent
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"Cannot retrieve the parent from a transiently removed item."
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InvalidItemStateException
name|e
parameter_list|)
block|{
comment|// success
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|accessRemovedItem
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|foo
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|Node
name|bar
init|=
name|foo
operator|.
name|addNode
argument_list|(
literal|"bar"
argument_list|)
decl_stmt|;
name|Property
name|p
init|=
name|bar
operator|.
name|setProperty
argument_list|(
literal|"name"
argument_list|,
literal|"value"
argument_list|)
decl_stmt|;
name|foo
operator|.
name|remove
argument_list|()
expr_stmt|;
try|try
block|{
name|bar
operator|.
name|getPath
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"Expected InvalidItemStateException"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InvalidItemStateException
name|expected
parameter_list|)
block|{         }
try|try
block|{
name|p
operator|.
name|getPath
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"Expected InvalidItemStateException"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InvalidItemStateException
name|expected
parameter_list|)
block|{         }
block|}
annotation|@
name|Test
specifier|public
name|void
name|accessRemovedProperty
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|foo
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|Property
name|p
init|=
name|foo
operator|.
name|setProperty
argument_list|(
literal|"name"
argument_list|,
literal|"value"
argument_list|)
decl_stmt|;
name|p
operator|.
name|remove
argument_list|()
expr_stmt|;
try|try
block|{
name|p
operator|.
name|getPath
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"Expected InvalidItemStateException"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InvalidItemStateException
name|expected
parameter_list|)
block|{         }
block|}
annotation|@
name|Test
specifier|public
name|void
name|getReferences
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|referee
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|referee
operator|.
name|addMixin
argument_list|(
literal|"mix:referenceable"
argument_list|)
expr_stmt|;
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
operator|.
name|setProperty
argument_list|(
literal|"reference"
argument_list|,
name|session
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|referee
argument_list|)
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|PropertyIterator
name|refs
init|=
name|referee
operator|.
name|getReferences
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
name|refs
operator|.
name|hasNext
argument_list|()
argument_list|)
expr_stmt|;
name|Property
name|p
init|=
name|refs
operator|.
name|nextProperty
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|"reference"
argument_list|,
name|p
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|refs
operator|.
name|hasNext
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|getNamedReferences
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|referee
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|referee
operator|.
name|addMixin
argument_list|(
literal|"mix:referenceable"
argument_list|)
expr_stmt|;
name|Value
name|value
init|=
name|session
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|referee
argument_list|)
decl_stmt|;
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
operator|.
name|setProperty
argument_list|(
literal|"reference1"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|getNode
argument_list|(
literal|"/bar"
argument_list|)
operator|.
name|setProperty
argument_list|(
literal|"reference2"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|PropertyIterator
name|refs
init|=
name|referee
operator|.
name|getReferences
argument_list|(
literal|"reference1"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|refs
operator|.
name|hasNext
argument_list|()
argument_list|)
expr_stmt|;
name|Property
name|p
init|=
name|refs
operator|.
name|nextProperty
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|"reference1"
argument_list|,
name|p
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|refs
operator|.
name|hasNext
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|getWeakReferences
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|referee
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|referee
operator|.
name|addMixin
argument_list|(
literal|"mix:referenceable"
argument_list|)
expr_stmt|;
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
operator|.
name|setProperty
argument_list|(
literal|"weak-reference"
argument_list|,
name|session
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|referee
argument_list|,
literal|true
argument_list|)
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|PropertyIterator
name|refs
init|=
name|referee
operator|.
name|getWeakReferences
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
name|refs
operator|.
name|hasNext
argument_list|()
argument_list|)
expr_stmt|;
name|Property
name|p
init|=
name|refs
operator|.
name|nextProperty
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|"weak-reference"
argument_list|,
name|p
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|refs
operator|.
name|hasNext
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|getNamedWeakReferences
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|referee
init|=
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|referee
operator|.
name|addMixin
argument_list|(
literal|"mix:referenceable"
argument_list|)
expr_stmt|;
name|Value
name|value
init|=
name|session
operator|.
name|getValueFactory
argument_list|()
operator|.
name|createValue
argument_list|(
name|referee
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
operator|.
name|setProperty
argument_list|(
literal|"weak-reference1"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|getNode
argument_list|(
literal|"/bar"
argument_list|)
operator|.
name|setProperty
argument_list|(
literal|"weak-reference2"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|PropertyIterator
name|refs
init|=
name|referee
operator|.
name|getWeakReferences
argument_list|(
literal|"weak-reference1"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|refs
operator|.
name|hasNext
argument_list|()
argument_list|)
expr_stmt|;
name|Property
name|p
init|=
name|refs
operator|.
name|nextProperty
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|"weak-reference1"
argument_list|,
name|p
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|refs
operator|.
name|hasNext
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|sessionSave
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session1
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
name|Session
name|session2
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
try|try
block|{
comment|// Add some items and ensure they are accessible through this session
name|session1
operator|.
name|getNode
argument_list|(
literal|"/"
argument_list|)
operator|.
name|addNode
argument_list|(
literal|"node1"
argument_list|)
expr_stmt|;
name|session1
operator|.
name|getNode
argument_list|(
literal|"/node1"
argument_list|)
operator|.
name|addNode
argument_list|(
literal|"node2"
argument_list|)
expr_stmt|;
name|session1
operator|.
name|getNode
argument_list|(
literal|"/"
argument_list|)
operator|.
name|addNode
argument_list|(
literal|"node1/node3"
argument_list|)
expr_stmt|;
name|Node
name|node1
init|=
name|session1
operator|.
name|getNode
argument_list|(
literal|"/node1"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"/node1"
argument_list|,
name|node1
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|Node
name|node2
init|=
name|session1
operator|.
name|getNode
argument_list|(
literal|"/node1/node2"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"/node1/node2"
argument_list|,
name|node2
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|Node
name|node3
init|=
name|session1
operator|.
name|getNode
argument_list|(
literal|"/node1/node3"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"/node1/node3"
argument_list|,
name|node3
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|node3
operator|.
name|setProperty
argument_list|(
literal|"property1"
argument_list|,
literal|"value1"
argument_list|)
expr_stmt|;
name|Item
name|property1
init|=
name|session1
operator|.
name|getProperty
argument_list|(
literal|"/node1/node3/property1"
argument_list|)
decl_stmt|;
name|assertFalse
argument_list|(
name|property1
operator|.
name|isNode
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"value1"
argument_list|,
operator|(
operator|(
name|Property
operator|)
name|property1
operator|)
operator|.
name|getString
argument_list|()
argument_list|)
expr_stmt|;
comment|// Make sure these items are not accessible through another session
name|assertFalse
argument_list|(
name|session2
operator|.
name|itemExists
argument_list|(
literal|"/node1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|session2
operator|.
name|itemExists
argument_list|(
literal|"/node1/node2"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|session2
operator|.
name|itemExists
argument_list|(
literal|"/node1/node3"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|session2
operator|.
name|itemExists
argument_list|(
literal|"/node1/node3/property1"
argument_list|)
argument_list|)
expr_stmt|;
name|session1
operator|.
name|save
argument_list|()
expr_stmt|;
comment|// Make sure they are accessible through another session
name|assertTrue
argument_list|(
name|session2
operator|.
name|itemExists
argument_list|(
literal|"/node1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session2
operator|.
name|itemExists
argument_list|(
literal|"/node1/node2"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session2
operator|.
name|itemExists
argument_list|(
literal|"/node1/node3"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session2
operator|.
name|itemExists
argument_list|(
literal|"/node1/node3/property1"
argument_list|)
argument_list|)
expr_stmt|;
name|session2
operator|.
name|refresh
argument_list|(
literal|false
argument_list|)
expr_stmt|;
comment|// Make sure they are accessible through another session after refresh
name|assertTrue
argument_list|(
name|session2
operator|.
name|itemExists
argument_list|(
literal|"/node1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session2
operator|.
name|itemExists
argument_list|(
literal|"/node1/node2"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session2
operator|.
name|itemExists
argument_list|(
literal|"/node1/node3"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session2
operator|.
name|itemExists
argument_list|(
literal|"/node1/node3/property1"
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session1
operator|.
name|logout
argument_list|()
expr_stmt|;
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|sessionRefresh
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
comment|// Add some items and ensure they are accessible through this session
name|session
operator|.
name|getNode
argument_list|(
literal|"/"
argument_list|)
operator|.
name|addNode
argument_list|(
literal|"node1"
argument_list|)
expr_stmt|;
name|session
operator|.
name|getNode
argument_list|(
literal|"/node1"
argument_list|)
operator|.
name|addNode
argument_list|(
literal|"node2"
argument_list|)
expr_stmt|;
name|session
operator|.
name|getNode
argument_list|(
literal|"/"
argument_list|)
operator|.
name|addNode
argument_list|(
literal|"node1/node3"
argument_list|)
expr_stmt|;
name|Node
name|node1
init|=
name|session
operator|.
name|getNode
argument_list|(
literal|"/node1"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"/node1"
argument_list|,
name|node1
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|Node
name|node2
init|=
name|session
operator|.
name|getNode
argument_list|(
literal|"/node1/node2"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"/node1/node2"
argument_list|,
name|node2
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|Node
name|node3
init|=
name|session
operator|.
name|getNode
argument_list|(
literal|"/node1/node3"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"/node1/node3"
argument_list|,
name|node3
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|node3
operator|.
name|setProperty
argument_list|(
literal|"property1"
argument_list|,
literal|"value1"
argument_list|)
expr_stmt|;
name|Item
name|property1
init|=
name|session
operator|.
name|getProperty
argument_list|(
literal|"/node1/node3/property1"
argument_list|)
decl_stmt|;
name|assertFalse
argument_list|(
name|property1
operator|.
name|isNode
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"value1"
argument_list|,
operator|(
operator|(
name|Property
operator|)
name|property1
operator|)
operator|.
name|getString
argument_list|()
argument_list|)
expr_stmt|;
comment|// Make sure these items are still accessible after refresh(true);
name|session
operator|.
name|refresh
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session
operator|.
name|itemExists
argument_list|(
literal|"/node1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session
operator|.
name|itemExists
argument_list|(
literal|"/node1/node2"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session
operator|.
name|itemExists
argument_list|(
literal|"/node1/node3"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session
operator|.
name|itemExists
argument_list|(
literal|"/node1/node3/property1"
argument_list|)
argument_list|)
expr_stmt|;
name|session
operator|.
name|refresh
argument_list|(
literal|false
argument_list|)
expr_stmt|;
comment|// Make sure these items are not accessible after refresh(false);
name|assertFalse
argument_list|(
name|session
operator|.
name|itemExists
argument_list|(
literal|"/node1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|session
operator|.
name|itemExists
argument_list|(
literal|"/node1/node2"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|session
operator|.
name|itemExists
argument_list|(
literal|"/node1/node3"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|session
operator|.
name|itemExists
argument_list|(
literal|"/node1/node3/property1"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|sessionRefreshFalse
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session1
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
name|Session
name|session2
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Node
name|foo
init|=
name|session1
operator|.
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|foo
operator|.
name|addNode
argument_list|(
literal|"added"
argument_list|)
expr_stmt|;
name|session2
operator|.
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
operator|.
name|addNode
argument_list|(
literal|"bar"
argument_list|)
expr_stmt|;
name|session2
operator|.
name|save
argument_list|()
expr_stmt|;
name|session1
operator|.
name|refresh
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|foo
operator|.
name|hasNode
argument_list|(
literal|"added"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|foo
operator|.
name|hasNode
argument_list|(
literal|"bar"
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session1
operator|.
name|logout
argument_list|()
expr_stmt|;
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|sessionRefreshTrue
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session1
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
name|Session
name|session2
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
try|try
block|{
name|Node
name|foo
init|=
name|session1
operator|.
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
decl_stmt|;
name|Node
name|added
init|=
name|foo
operator|.
name|addNode
argument_list|(
literal|"added"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|added
operator|.
name|isNew
argument_list|()
argument_list|)
expr_stmt|;
name|session2
operator|.
name|getNode
argument_list|(
literal|"/foo"
argument_list|)
operator|.
name|addNode
argument_list|(
literal|"bar"
argument_list|)
expr_stmt|;
name|session2
operator|.
name|save
argument_list|()
expr_stmt|;
name|session1
operator|.
name|refresh
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|foo
operator|.
name|hasNode
argument_list|(
literal|"added"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|foo
operator|.
name|getNode
argument_list|(
literal|"added"
argument_list|)
operator|.
name|isNew
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|foo
operator|.
name|hasNode
argument_list|(
literal|"bar"
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session1
operator|.
name|logout
argument_list|()
expr_stmt|;
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|sessionIsolation
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session1
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
name|Session
name|session2
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
try|try
block|{
name|session1
operator|.
name|getRootNode
argument_list|()
operator|.
name|addNode
argument_list|(
literal|"node1"
argument_list|)
expr_stmt|;
name|session2
operator|.
name|getRootNode
argument_list|()
operator|.
name|addNode
argument_list|(
literal|"node2"
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session1
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session2
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node2"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|session1
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node2"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|session2
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node1"
argument_list|)
argument_list|)
expr_stmt|;
name|session1
operator|.
name|save
argument_list|()
expr_stmt|;
name|session2
operator|.
name|save
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
name|session1
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session1
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node2"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session2
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node1"
argument_list|)
argument_list|)
expr_stmt|;
comment|// save refreshes
name|assertTrue
argument_list|(
name|session2
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node2"
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session1
operator|.
name|logout
argument_list|()
expr_stmt|;
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|inThreadSessionSynchronisation
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session1
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
name|Session
name|session2
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
name|Session
name|session3
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
try|try
block|{
name|session1
operator|.
name|getRootNode
argument_list|()
operator|.
name|addNode
argument_list|(
literal|"newNode"
argument_list|)
expr_stmt|;
name|session1
operator|.
name|save
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
name|session2
operator|.
name|nodeExists
argument_list|(
literal|"/newNode"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session3
operator|.
name|nodeExists
argument_list|(
literal|"/newNode"
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session1
operator|.
name|logout
argument_list|()
expr_stmt|;
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
name|session3
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|saveRefreshConflict
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session1
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
name|Session
name|session2
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
try|try
block|{
name|session1
operator|.
name|getRootNode
argument_list|()
operator|.
name|addNode
argument_list|(
literal|"node"
argument_list|)
operator|.
name|setProperty
argument_list|(
literal|"p"
argument_list|,
literal|"v1"
argument_list|)
expr_stmt|;
name|session2
operator|.
name|getRootNode
argument_list|()
operator|.
name|addNode
argument_list|(
literal|"node"
argument_list|)
operator|.
name|setProperty
argument_list|(
literal|"p"
argument_list|,
literal|"v2"
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session1
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session2
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node"
argument_list|)
argument_list|)
expr_stmt|;
name|session1
operator|.
name|save
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
name|session1
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session2
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node"
argument_list|)
argument_list|)
expr_stmt|;
name|session2
operator|.
name|refresh
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session1
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session2
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node"
argument_list|)
argument_list|)
expr_stmt|;
try|try
block|{
name|session2
operator|.
name|save
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"Expected InvalidItemStateException"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InvalidItemStateException
name|expected
parameter_list|)
block|{             }
block|}
finally|finally
block|{
name|session1
operator|.
name|logout
argument_list|()
expr_stmt|;
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|saveConflict
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|getAdminSession
argument_list|()
operator|.
name|getRootNode
argument_list|()
operator|.
name|addNode
argument_list|(
literal|"node"
argument_list|)
expr_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session1
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
name|Session
name|session2
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
try|try
block|{
name|session1
operator|.
name|getNode
argument_list|(
literal|"/node"
argument_list|)
operator|.
name|remove
argument_list|()
expr_stmt|;
name|session2
operator|.
name|getNode
argument_list|(
literal|"/node"
argument_list|)
operator|.
name|addNode
argument_list|(
literal|"2"
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|session1
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session2
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session2
operator|.
name|getRootNode
argument_list|()
operator|.
name|getNode
argument_list|(
literal|"node"
argument_list|)
operator|.
name|hasNode
argument_list|(
literal|"2"
argument_list|)
argument_list|)
expr_stmt|;
name|session1
operator|.
name|save
argument_list|()
expr_stmt|;
name|assertFalse
argument_list|(
name|session1
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|session2
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"node"
argument_list|)
argument_list|)
expr_stmt|;
try|try
block|{
name|session2
operator|.
name|save
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"Expected InvalidItemStateException"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InvalidItemStateException
name|expected
parameter_list|)
block|{             }
block|}
finally|finally
block|{
name|session1
operator|.
name|logout
argument_list|()
expr_stmt|;
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|liveNodes
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|n1
init|=
operator|(
name|Node
operator|)
name|session
operator|.
name|getItem
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Node
name|n2
init|=
operator|(
name|Node
operator|)
name|session
operator|.
name|getItem
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Node
name|c1
init|=
name|n1
operator|.
name|addNode
argument_list|(
literal|"c1"
argument_list|)
decl_stmt|;
name|Node
name|c2
init|=
name|n2
operator|.
name|addNode
argument_list|(
literal|"c2"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|n1
operator|.
name|hasNode
argument_list|(
literal|"c1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|n1
operator|.
name|hasNode
argument_list|(
literal|"c2"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|n2
operator|.
name|hasNode
argument_list|(
literal|"c1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|n2
operator|.
name|hasNode
argument_list|(
literal|"c2"
argument_list|)
argument_list|)
expr_stmt|;
name|c1
operator|.
name|remove
argument_list|()
expr_stmt|;
name|assertFalse
argument_list|(
name|n1
operator|.
name|hasNode
argument_list|(
literal|"c1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|n1
operator|.
name|hasNode
argument_list|(
literal|"c2"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|n2
operator|.
name|hasNode
argument_list|(
literal|"c1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|n2
operator|.
name|hasNode
argument_list|(
literal|"c2"
argument_list|)
argument_list|)
expr_stmt|;
name|c2
operator|.
name|remove
argument_list|()
expr_stmt|;
name|assertFalse
argument_list|(
name|n1
operator|.
name|hasNode
argument_list|(
literal|"c1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|n1
operator|.
name|hasNode
argument_list|(
literal|"c2"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|n2
operator|.
name|hasNode
argument_list|(
literal|"c1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|n2
operator|.
name|hasNode
argument_list|(
literal|"c2"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|move
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|node
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Node
name|source
init|=
name|node
operator|.
name|addNode
argument_list|(
literal|"source"
argument_list|)
operator|.
name|addNode
argument_list|(
literal|"node"
argument_list|)
decl_stmt|;
name|node
operator|.
name|addNode
argument_list|(
literal|"target"
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|session
operator|.
name|refresh
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|session
operator|.
name|move
argument_list|(
name|TEST_PATH
operator|+
literal|"/source/node"
argument_list|,
name|TEST_PATH
operator|+
literal|"/target/moved"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|TEST_PATH
operator|+
literal|"/target/moved"
argument_list|,
name|source
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"source/node"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"source"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"target/moved"
argument_list|)
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|assertFalse
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"source/node"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"source"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"target/moved"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|renameNonOrderable
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|root
init|=
name|session
operator|.
name|getRootNode
argument_list|()
decl_stmt|;
name|Node
name|parent
init|=
name|root
operator|.
name|addNode
argument_list|(
literal|"parent"
argument_list|,
name|NodeTypeConstants
operator|.
name|NT_OAK_UNSTRUCTURED
argument_list|)
decl_stmt|;
name|parent
operator|.
name|addNode
argument_list|(
literal|"fo"
argument_list|)
expr_stmt|;
name|Node
name|foo
init|=
name|parent
operator|.
name|addNode
argument_list|(
literal|"foo"
argument_list|)
decl_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
operator|(
operator|(
name|JackrabbitNode
operator|)
name|foo
operator|)
operator|.
name|rename
argument_list|(
literal|"renamed"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"renamed"
argument_list|,
name|foo
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|session
operator|.
name|nodeExists
argument_list|(
literal|"/parent/foo"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|session
operator|.
name|nodeExists
argument_list|(
literal|"/parent/renamed"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
argument_list|(
name|expected
operator|=
name|RepositoryException
operator|.
name|class
argument_list|)
specifier|public
name|void
name|moveToDescendant
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|node
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Node
name|source
init|=
name|node
operator|.
name|addNode
argument_list|(
literal|"s"
argument_list|)
decl_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|session
operator|.
name|refresh
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|session
operator|.
name|move
argument_list|(
name|TEST_PATH
operator|+
literal|"/s"
argument_list|,
name|TEST_PATH
operator|+
literal|"/s/t"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|oak962
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|root
init|=
name|session
operator|.
name|getRootNode
argument_list|()
operator|.
name|addNode
argument_list|(
literal|"root"
argument_list|)
decl_stmt|;
name|root
operator|.
name|addNode
argument_list|(
literal|"N3"
argument_list|)
expr_stmt|;
name|root
operator|.
name|addNode
argument_list|(
literal|"N6"
argument_list|)
operator|.
name|addNode
argument_list|(
literal|"N7"
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|session
operator|.
name|move
argument_list|(
literal|"/root/N6/N7"
argument_list|,
literal|"/root/N3/N12"
argument_list|)
expr_stmt|;
name|root
operator|.
name|getNode
argument_list|(
literal|"N3"
argument_list|)
operator|.
name|getNode
argument_list|(
literal|"N12"
argument_list|)
operator|.
name|remove
argument_list|()
expr_stmt|;
name|root
operator|.
name|getNode
argument_list|(
literal|"N6"
argument_list|)
operator|.
name|remove
argument_list|()
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|moveReferenceable
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|node
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|node
operator|.
name|addNode
argument_list|(
literal|"source"
argument_list|)
operator|.
name|addNode
argument_list|(
literal|"node"
argument_list|)
operator|.
name|addMixin
argument_list|(
literal|"mix:referenceable"
argument_list|)
expr_stmt|;
name|node
operator|.
name|addNode
argument_list|(
literal|"target"
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|session
operator|.
name|refresh
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|session
operator|.
name|move
argument_list|(
name|TEST_PATH
operator|+
literal|"/source/node"
argument_list|,
name|TEST_PATH
operator|+
literal|"/target/moved"
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"source/node"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"source"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"target/moved"
argument_list|)
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|assertFalse
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"source/node"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"source"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"target/moved"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|workspaceMove
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|node
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|node
operator|.
name|addNode
argument_list|(
literal|"source"
argument_list|)
operator|.
name|addNode
argument_list|(
literal|"node"
argument_list|)
expr_stmt|;
name|node
operator|.
name|addNode
argument_list|(
literal|"target"
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|session
operator|.
name|getWorkspace
argument_list|()
operator|.
name|move
argument_list|(
name|TEST_PATH
operator|+
literal|"/source/node"
argument_list|,
name|TEST_PATH
operator|+
literal|"/target/moved"
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"source/node"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"source"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|node
operator|.
name|hasNode
argument_list|(
literal|"target/moved"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|invalidItemStateExceptionOnRemovedNode
parameter_list|()
throws|throws
name|Exception
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|parentPath
range|:
operator|new
name|String
index|[]
block|{
literal|"/"
block|,
name|TEST_PATH
block|}
control|)
block|{
name|Node
name|parent
init|=
name|session
operator|.
name|getNode
argument_list|(
name|parentPath
argument_list|)
decl_stmt|;
name|Node
name|child
init|=
name|parent
operator|.
name|addNode
argument_list|(
literal|"child"
argument_list|)
decl_stmt|;
name|String
name|childPath
init|=
name|child
operator|.
name|getPath
argument_list|()
decl_stmt|;
name|child
operator|.
name|remove
argument_list|()
expr_stmt|;
try|try
block|{
name|child
operator|.
name|getPath
argument_list|()
expr_stmt|;
name|fail
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InvalidItemStateException
name|expected
parameter_list|)
block|{ }
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
try|try
block|{
name|child
operator|.
name|getPath
argument_list|()
expr_stmt|;
name|fail
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InvalidItemStateException
name|expected
parameter_list|)
block|{ }
name|parent
operator|.
name|addNode
argument_list|(
literal|"child"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|childPath
argument_list|,
name|child
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|setPrimaryType
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|testNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"nt:unstructured"
argument_list|,
name|testNode
operator|.
name|getPrimaryNodeType
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"nt:unstructured"
argument_list|,
name|testNode
operator|.
name|getProperty
argument_list|(
literal|"jcr:primaryType"
argument_list|)
operator|.
name|getString
argument_list|()
argument_list|)
expr_stmt|;
name|testNode
operator|.
name|setPrimaryType
argument_list|(
literal|"nt:folder"
argument_list|)
expr_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|testNode
operator|=
name|session2
operator|.
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"nt:folder"
argument_list|,
name|testNode
operator|.
name|getPrimaryNodeType
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"nt:folder"
argument_list|,
name|testNode
operator|.
name|getProperty
argument_list|(
literal|"jcr:primaryType"
argument_list|)
operator|.
name|getString
argument_list|()
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|setPrimaryTypeShouldFail
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Node
name|testNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"nt:unstructured"
argument_list|,
name|testNode
operator|.
name|getPrimaryNodeType
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"nt:unstructured"
argument_list|,
name|testNode
operator|.
name|getProperty
argument_list|(
literal|"jcr:primaryType"
argument_list|)
operator|.
name|getString
argument_list|()
argument_list|)
expr_stmt|;
comment|// create subnode that would not be allowed with nt:folder
name|testNode
operator|.
name|addNode
argument_list|(
literal|"unstructured_child"
argument_list|,
name|NodeType
operator|.
name|NT_UNSTRUCTURED
argument_list|)
expr_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|testNode
operator|.
name|setPrimaryType
argument_list|(
literal|"nt:folder"
argument_list|)
expr_stmt|;
try|try
block|{
name|getAdminSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"Changing the primary type to nt:folder should fail."
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|RepositoryException
name|e
parameter_list|)
block|{
comment|// ok
name|getAdminSession
argument_list|()
operator|.
name|refresh
argument_list|(
literal|false
argument_list|)
expr_stmt|;
block|}
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|testNode
operator|=
name|session2
operator|.
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"nt:unstructured"
argument_list|,
name|testNode
operator|.
name|getPrimaryNodeType
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"nt:unstructured"
argument_list|,
name|testNode
operator|.
name|getProperty
argument_list|(
literal|"jcr:primaryType"
argument_list|)
operator|.
name|getString
argument_list|()
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|nodeTypeRegistry
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|NodeTypeManager
name|ntMgr
init|=
name|getAdminSession
argument_list|()
operator|.
name|getWorkspace
argument_list|()
operator|.
name|getNodeTypeManager
argument_list|()
decl_stmt|;
name|assertFalse
argument_list|(
name|ntMgr
operator|.
name|hasNodeType
argument_list|(
literal|"foo"
argument_list|)
argument_list|)
expr_stmt|;
name|NodeTypeTemplate
name|ntd
init|=
name|ntMgr
operator|.
name|createNodeTypeTemplate
argument_list|()
decl_stmt|;
name|ntd
operator|.
name|setName
argument_list|(
literal|"foo"
argument_list|)
expr_stmt|;
name|ntMgr
operator|.
name|registerNodeType
argument_list|(
name|ntd
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|ntMgr
operator|.
name|hasNodeType
argument_list|(
literal|"foo"
argument_list|)
argument_list|)
expr_stmt|;
name|ntMgr
operator|.
name|unregisterNodeType
argument_list|(
literal|"foo"
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|ntMgr
operator|.
name|hasNodeType
argument_list|(
literal|"foo"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testNamespaceRegistry
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|NamespaceRegistry
name|nsReg
init|=
name|getAdminSession
argument_list|()
operator|.
name|getWorkspace
argument_list|()
operator|.
name|getNamespaceRegistry
argument_list|()
decl_stmt|;
name|assertFalse
argument_list|(
name|asList
argument_list|(
name|nsReg
operator|.
name|getPrefixes
argument_list|()
argument_list|)
operator|.
name|contains
argument_list|(
literal|"foo"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|asList
argument_list|(
name|nsReg
operator|.
name|getURIs
argument_list|()
argument_list|)
operator|.
name|contains
argument_list|(
literal|"file:///foo"
argument_list|)
argument_list|)
expr_stmt|;
name|nsReg
operator|.
name|registerNamespace
argument_list|(
literal|"foo"
argument_list|,
literal|"file:///foo"
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|asList
argument_list|(
name|nsReg
operator|.
name|getPrefixes
argument_list|()
argument_list|)
operator|.
name|contains
argument_list|(
literal|"foo"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|asList
argument_list|(
name|nsReg
operator|.
name|getURIs
argument_list|()
argument_list|)
operator|.
name|contains
argument_list|(
literal|"file:///foo"
argument_list|)
argument_list|)
expr_stmt|;
name|nsReg
operator|.
name|unregisterNamespace
argument_list|(
literal|"foo"
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|asList
argument_list|(
name|nsReg
operator|.
name|getPrefixes
argument_list|()
argument_list|)
operator|.
name|contains
argument_list|(
literal|"foo"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|asList
argument_list|(
name|nsReg
operator|.
name|getURIs
argument_list|()
argument_list|)
operator|.
name|contains
argument_list|(
literal|"file:///foo"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|sessionRemappedNamespace
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|NamespaceRegistry
name|nsReg
init|=
name|getAdminSession
argument_list|()
operator|.
name|getWorkspace
argument_list|()
operator|.
name|getNamespaceRegistry
argument_list|()
decl_stmt|;
name|nsReg
operator|.
name|registerNamespace
argument_list|(
literal|"foo"
argument_list|,
literal|"file:///foo"
argument_list|)
expr_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|getRootNode
argument_list|()
operator|.
name|addNode
argument_list|(
literal|"foo:test"
argument_list|)
expr_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|s
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
name|s
operator|.
name|setNamespacePrefix
argument_list|(
literal|"bar"
argument_list|,
literal|"file:///foo"
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|s
operator|.
name|getRootNode
argument_list|()
operator|.
name|hasNode
argument_list|(
literal|"bar:test"
argument_list|)
argument_list|)
expr_stmt|;
name|Node
name|n
init|=
name|s
operator|.
name|getRootNode
argument_list|()
operator|.
name|getNode
argument_list|(
literal|"bar:test"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"bar:test"
argument_list|,
name|n
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|s
operator|.
name|logout
argument_list|()
expr_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|getRootNode
argument_list|()
operator|.
name|getNode
argument_list|(
literal|"foo:test"
argument_list|)
operator|.
name|remove
argument_list|()
expr_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|nsReg
operator|.
name|unregisterNamespace
argument_list|(
literal|"foo"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|registryRemappedNamespace
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|NamespaceRegistry
name|nsReg
init|=
name|getAdminSession
argument_list|()
operator|.
name|getWorkspace
argument_list|()
operator|.
name|getNamespaceRegistry
argument_list|()
decl_stmt|;
name|nsReg
operator|.
name|registerNamespace
argument_list|(
literal|"foo"
argument_list|,
literal|"file:///foo"
argument_list|)
expr_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|getRootNode
argument_list|()
operator|.
name|addNode
argument_list|(
literal|"foo:test"
argument_list|)
expr_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
try|try
block|{
name|nsReg
operator|.
name|registerNamespace
argument_list|(
literal|"bar"
argument_list|,
literal|"file:///foo"
argument_list|)
expr_stmt|;
name|fail
argument_list|(
literal|"Remapping namespace through NamespaceRegistry must not be allowed"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NamespaceException
name|e
parameter_list|)
block|{
comment|// expected
block|}
finally|finally
block|{
name|getAdminSession
argument_list|()
operator|.
name|getRootNode
argument_list|()
operator|.
name|getNode
argument_list|(
literal|"foo:test"
argument_list|)
operator|.
name|remove
argument_list|()
expr_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|nsReg
operator|.
name|unregisterNamespace
argument_list|(
literal|"foo"
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
comment|// Regression test for OAK-299
specifier|public
name|void
name|importNodeType
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
throws|,
name|ParseException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|NodeTypeManager
name|manager
init|=
name|session
operator|.
name|getWorkspace
argument_list|()
operator|.
name|getNodeTypeManager
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|manager
operator|.
name|hasNodeType
argument_list|(
literal|"myNodeType"
argument_list|)
condition|)
block|{
name|StringBuilder
name|defs
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|defs
operator|.
name|append
argument_list|(
literal|"[\"myNodeType\"]\n"
argument_list|)
expr_stmt|;
name|defs
operator|.
name|append
argument_list|(
literal|"  - prop1\n"
argument_list|)
expr_stmt|;
name|defs
operator|.
name|append
argument_list|(
literal|"  + * (nt:base) = nt:unstructured \n"
argument_list|)
expr_stmt|;
name|Reader
name|cndReader
init|=
operator|new
name|InputStreamReader
argument_list|(
operator|new
name|ByteArrayInputStream
argument_list|(
name|defs
operator|.
name|toString
argument_list|()
operator|.
name|getBytes
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|CndImporter
operator|.
name|registerNodeTypes
argument_list|(
name|cndReader
argument_list|,
name|session
argument_list|)
expr_stmt|;
block|}
name|NodeType
name|myNodeType
init|=
name|manager
operator|.
name|getNodeType
argument_list|(
literal|"myNodeType"
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|myNodeType
operator|.
name|isNodeType
argument_list|(
literal|"nt:base"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|mixin
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|NodeTypeManager
name|ntMgr
init|=
name|getAdminSession
argument_list|()
operator|.
name|getWorkspace
argument_list|()
operator|.
name|getNodeTypeManager
argument_list|()
decl_stmt|;
name|NodeTypeTemplate
name|mixTest
init|=
name|ntMgr
operator|.
name|createNodeTypeTemplate
argument_list|()
decl_stmt|;
name|mixTest
operator|.
name|setName
argument_list|(
literal|"mix:test"
argument_list|)
expr_stmt|;
name|mixTest
operator|.
name|setMixin
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|ntMgr
operator|.
name|registerNodeType
argument_list|(
name|mixTest
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|Node
name|testNode
init|=
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|NodeType
index|[]
name|mix
init|=
name|testNode
operator|.
name|getMixinNodeTypes
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|mix
operator|.
name|length
argument_list|)
expr_stmt|;
name|testNode
operator|.
name|addMixin
argument_list|(
literal|"mix:test"
argument_list|)
expr_stmt|;
name|testNode
operator|.
name|getSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|mix
operator|=
name|session2
operator|.
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
operator|.
name|getMixinNodeTypes
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|mix
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"mix:test"
argument_list|,
name|mix
index|[
literal|0
index|]
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
name|testNode
operator|.
name|removeMixin
argument_list|(
literal|"mix:test"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|liveNode
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|n1
init|=
name|session
operator|.
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|Node
name|n2
init|=
name|session
operator|.
name|getNode
argument_list|(
name|TEST_PATH
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|n1
operator|.
name|isSame
argument_list|(
name|n2
argument_list|)
argument_list|)
expr_stmt|;
name|Node
name|c1
init|=
name|n1
operator|.
name|addNode
argument_list|(
literal|"c1"
argument_list|)
decl_stmt|;
name|n1
operator|.
name|setProperty
argument_list|(
literal|"p1"
argument_list|,
literal|"v1"
argument_list|)
expr_stmt|;
name|c1
operator|.
name|setProperty
argument_list|(
literal|"pc1"
argument_list|,
literal|"vc1"
argument_list|)
expr_stmt|;
name|Node
name|c2
init|=
name|n2
operator|.
name|addNode
argument_list|(
literal|"c2"
argument_list|)
decl_stmt|;
name|n2
operator|.
name|setProperty
argument_list|(
literal|"p2"
argument_list|,
literal|"v2"
argument_list|)
expr_stmt|;
name|c2
operator|.
name|setProperty
argument_list|(
literal|"pc2"
argument_list|,
literal|"vc2"
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|c1
operator|.
name|isSame
argument_list|(
name|n2
operator|.
name|getNode
argument_list|(
literal|"c1"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|c2
operator|.
name|isSame
argument_list|(
name|n1
operator|.
name|getNode
argument_list|(
literal|"c2"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|n1
operator|.
name|hasNode
argument_list|(
literal|"c1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|n1
operator|.
name|hasNode
argument_list|(
literal|"c2"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|n1
operator|.
name|hasProperty
argument_list|(
literal|"p1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|n1
operator|.
name|hasProperty
argument_list|(
literal|"p2"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|c1
operator|.
name|hasProperty
argument_list|(
literal|"pc1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|c1
operator|.
name|hasProperty
argument_list|(
literal|"pc2"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|n2
operator|.
name|hasNode
argument_list|(
literal|"c1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|n2
operator|.
name|hasNode
argument_list|(
literal|"c2"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|n2
operator|.
name|hasProperty
argument_list|(
literal|"p1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|n2
operator|.
name|hasProperty
argument_list|(
literal|"p2"
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|c2
operator|.
name|hasProperty
argument_list|(
literal|"pc1"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|c2
operator|.
name|hasProperty
argument_list|(
literal|"pc2"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|expandedName
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|session
operator|.
name|setNamespacePrefix
argument_list|(
literal|"foo"
argument_list|,
literal|"http://example.com/"
argument_list|)
expr_stmt|;
name|session
operator|.
name|getRootNode
argument_list|()
operator|.
name|addNode
argument_list|(
literal|"{0} test"
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
name|session
operator|.
name|nodeExists
argument_list|(
literal|"/{0} test"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testGetDefinitionWithSNS
parameter_list|()
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|node
init|=
name|session
operator|.
name|getNode
argument_list|(
literal|"/jcr:system/jcr:nodeTypes/nt:file"
argument_list|)
decl_stmt|;
comment|// TODO: use getNode("jcr:childNodeDefinition[1]") once that works
for|for
control|(
name|Node
name|child
range|:
name|getChildNodes
argument_list|(
name|node
argument_list|,
literal|"jcr:childNodeDefinition"
argument_list|)
control|)
block|{
name|NodeDefinition
name|definition
init|=
name|child
operator|.
name|getDefinition
argument_list|()
decl_stmt|;
comment|// OAK-829
name|definition
operator|.
name|getDefaultPrimaryType
argument_list|()
expr_stmt|;
comment|// OAK-826
name|definition
operator|.
name|getRequiredPrimaryTypes
argument_list|()
expr_stmt|;
comment|// OAK-826
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|workspaceCopyWithReferences
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|ValueFactory
name|vf
init|=
name|session
operator|.
name|getValueFactory
argument_list|()
decl_stmt|;
name|Node
name|root
init|=
name|session
operator|.
name|getRootNode
argument_list|()
decl_stmt|;
name|Node
name|other
init|=
name|root
operator|.
name|addNode
argument_list|(
literal|"other"
argument_list|)
decl_stmt|;
name|other
operator|.
name|addMixin
argument_list|(
literal|"mix:referenceable"
argument_list|)
expr_stmt|;
name|Node
name|src
init|=
name|root
operator|.
name|addNode
argument_list|(
literal|"src"
argument_list|)
decl_stmt|;
name|Node
name|test
init|=
name|src
operator|.
name|addNode
argument_list|(
literal|"test"
argument_list|)
decl_stmt|;
name|test
operator|.
name|addMixin
argument_list|(
literal|"mix:referenceable"
argument_list|)
expr_stmt|;
name|src
operator|.
name|setProperty
argument_list|(
literal|"test"
argument_list|,
name|test
argument_list|)
expr_stmt|;
name|src
operator|.
name|setProperty
argument_list|(
literal|"other"
argument_list|,
name|other
argument_list|)
expr_stmt|;
name|src
operator|.
name|setProperty
argument_list|(
literal|"multi"
argument_list|,
operator|new
name|Value
index|[]
block|{
name|vf
operator|.
name|createValue
argument_list|(
name|test
argument_list|)
block|,
name|vf
operator|.
name|createValue
argument_list|(
name|other
argument_list|)
block|}
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|session
operator|.
name|getWorkspace
argument_list|()
operator|.
name|copy
argument_list|(
literal|"/src"
argument_list|,
literal|"/dest"
argument_list|)
expr_stmt|;
name|Node
name|dest
init|=
name|root
operator|.
name|getNode
argument_list|(
literal|"dest"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"/dest/test"
argument_list|,
name|dest
operator|.
name|getProperty
argument_list|(
literal|"test"
argument_list|)
operator|.
name|getNode
argument_list|()
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"/other"
argument_list|,
name|dest
operator|.
name|getProperty
argument_list|(
literal|"other"
argument_list|)
operator|.
name|getNode
argument_list|()
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
name|Value
index|[]
name|refs
init|=
name|dest
operator|.
name|getProperty
argument_list|(
literal|"multi"
argument_list|)
operator|.
name|getValues
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|refs
operator|.
name|length
argument_list|)
expr_stmt|;
name|Set
argument_list|<
name|String
argument_list|>
name|paths
init|=
operator|new
name|HashSet
argument_list|<
name|String
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|Value
name|v
range|:
name|refs
control|)
block|{
name|paths
operator|.
name|add
argument_list|(
name|session
operator|.
name|getNodeByIdentifier
argument_list|(
name|v
operator|.
name|getString
argument_list|()
argument_list|)
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertTrue
argument_list|(
name|paths
operator|.
name|contains
argument_list|(
literal|"/other"
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|paths
operator|.
name|contains
argument_list|(
literal|"/dest/test"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
comment|// OAK-1244
specifier|public
name|void
name|importUUIDCreateNew
parameter_list|()
throws|throws
name|Exception
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|node
init|=
name|session
operator|.
name|getRootNode
argument_list|()
operator|.
name|addNode
argument_list|(
literal|"node"
argument_list|)
decl_stmt|;
name|node
operator|.
name|addMixin
argument_list|(
literal|"mix:referenceable"
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|String
name|uuid
init|=
name|node
operator|.
name|getIdentifier
argument_list|()
decl_stmt|;
name|ByteArrayOutputStream
name|out
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|session
operator|.
name|exportSystemView
argument_list|(
literal|"/node"
argument_list|,
name|out
argument_list|,
literal|true
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|node
operator|.
name|remove
argument_list|()
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|session
operator|.
name|importXML
argument_list|(
literal|"/"
argument_list|,
operator|new
name|ByteArrayInputStream
argument_list|(
name|out
operator|.
name|toByteArray
argument_list|()
argument_list|)
argument_list|,
name|IMPORT_UUID_CREATE_NEW
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|node
operator|=
name|session
operator|.
name|getNode
argument_list|(
literal|"/node"
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|uuid
operator|.
name|equals
argument_list|(
name|node
operator|.
name|getIdentifier
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testReferenceBinary
parameter_list|()
throws|throws
name|RepositoryException
block|{
name|ValueFactory
name|valueFactory
init|=
name|getAdminSession
argument_list|()
operator|.
name|getValueFactory
argument_list|()
decl_stmt|;
name|Binary
name|binary
init|=
name|valueFactory
operator|.
name|createBinary
argument_list|(
operator|new
name|RandomInputStream
argument_list|(
literal|1
argument_list|,
literal|256
operator|*
literal|1024
argument_list|)
argument_list|)
decl_stmt|;
name|String
name|reference
init|=
name|binary
operator|instanceof
name|ReferenceBinary
condition|?
operator|(
operator|(
name|ReferenceBinary
operator|)
name|binary
operator|)
operator|.
name|getReference
argument_list|()
else|:
literal|null
decl_stmt|;
name|assumeTrue
argument_list|(
name|reference
operator|!=
literal|null
argument_list|)
expr_stmt|;
name|Session
name|session
init|=
name|createAdminSession
argument_list|()
decl_stmt|;
try|try
block|{
name|valueFactory
operator|=
name|session
operator|.
name|getValueFactory
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
name|binary
argument_list|,
name|valueFactory
operator|.
name|createValue
argument_list|(
operator|new
name|SimpleReferenceBinary
argument_list|(
name|reference
argument_list|)
argument_list|)
operator|.
name|getBinary
argument_list|()
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|session
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|manyTransientChanges
parameter_list|()
throws|throws
name|RepositoryException
block|{
comment|// test for OAK-1670, run with -Dupdate.limit=100
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|test
init|=
name|session
operator|.
name|getRootNode
argument_list|()
operator|.
name|getNode
argument_list|(
name|TEST_NODE
argument_list|)
decl_stmt|;
name|Node
name|foo
init|=
name|test
operator|.
name|addNode
argument_list|(
literal|"foo"
argument_list|)
decl_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|test
operator|.
name|setProperty
argument_list|(
literal|"p"
argument_list|,
literal|"value"
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|76
condition|;
name|i
operator|++
control|)
block|{
name|test
operator|.
name|addNode
argument_list|(
literal|"n"
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
name|Node
name|t
init|=
name|foo
operator|.
name|addNode
argument_list|(
literal|"test"
argument_list|)
decl_stmt|;
name|t
operator|.
name|setProperty
argument_list|(
literal|"prop"
argument_list|,
literal|"value"
argument_list|)
expr_stmt|;
name|session
operator|.
name|getNode
argument_list|(
name|TEST_PATH
operator|+
literal|"/foo/test"
argument_list|)
operator|.
name|setProperty
argument_list|(
literal|"prop"
argument_list|,
literal|"value"
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|session
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
comment|// OAK-2038
specifier|public
name|void
name|importWithRegisteredType
parameter_list|()
throws|throws
name|Exception
block|{
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|NodeTypeManager
name|ntMgr
init|=
name|getAdminSession
argument_list|()
operator|.
name|getWorkspace
argument_list|()
operator|.
name|getNodeTypeManager
argument_list|()
decl_stmt|;
name|NodeTypeTemplate
name|ntd
init|=
name|ntMgr
operator|.
name|createNodeTypeTemplate
argument_list|()
decl_stmt|;
name|ntd
operator|.
name|setName
argument_list|(
literal|"fooType"
argument_list|)
expr_stmt|;
name|PropertyDefinitionTemplate
name|propDefTemplate
init|=
name|ntMgr
operator|.
name|createPropertyDefinitionTemplate
argument_list|()
decl_stmt|;
name|propDefTemplate
operator|.
name|setName
argument_list|(
literal|"fooProp"
argument_list|)
expr_stmt|;
name|propDefTemplate
operator|.
name|setRequiredType
argument_list|(
name|PropertyType
operator|.
name|STRING
argument_list|)
expr_stmt|;
name|ntd
operator|.
name|getPropertyDefinitionTemplates
argument_list|()
operator|.
name|add
argument_list|(
name|propDefTemplate
argument_list|)
expr_stmt|;
name|ntMgr
operator|.
name|registerNodeType
argument_list|(
name|ntd
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|Node
name|node
init|=
name|session
operator|.
name|getRootNode
argument_list|()
operator|.
name|addNode
argument_list|(
literal|"node"
argument_list|,
literal|"fooType"
argument_list|)
decl_stmt|;
name|node
operator|.
name|setProperty
argument_list|(
literal|"fooProp"
argument_list|,
literal|"fooValue"
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|ByteArrayOutputStream
name|out
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|session
operator|.
name|exportDocumentView
argument_list|(
literal|"/node"
argument_list|,
name|out
argument_list|,
literal|true
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|node
operator|.
name|remove
argument_list|()
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|session
operator|.
name|getWorkspace
argument_list|()
operator|.
name|importXML
argument_list|(
literal|"/"
argument_list|,
operator|new
name|ByteArrayInputStream
argument_list|(
name|out
operator|.
name|toByteArray
argument_list|()
argument_list|)
argument_list|,
name|IMPORT_UUID_CREATE_NEW
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
literal|"fooValue"
argument_list|,
name|session
operator|.
name|getProperty
argument_list|(
literal|"/node/fooProp"
argument_list|)
operator|.
name|getString
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|largeMultiValueProperty
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|List
argument_list|<
name|String
argument_list|>
name|logMessages
init|=
name|Lists
operator|.
name|newArrayList
argument_list|()
decl_stmt|;
name|Appender
argument_list|<
name|ILoggingEvent
argument_list|>
name|a
init|=
operator|new
name|AppenderBase
argument_list|<
name|ILoggingEvent
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|void
name|append
parameter_list|(
name|ILoggingEvent
name|e
parameter_list|)
block|{
if|if
condition|(
name|Level
operator|.
name|WARN
operator|.
name|isGreaterOrEqual
argument_list|(
name|e
operator|.
name|getLevel
argument_list|()
argument_list|)
condition|)
block|{
name|logMessages
operator|.
name|add
argument_list|(
name|e
operator|.
name|getFormattedMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
decl_stmt|;
name|a
operator|.
name|start
argument_list|()
expr_stmt|;
name|rootLogger
argument_list|()
operator|.
name|addAppender
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|Session
name|session
init|=
name|getAdminSession
argument_list|()
decl_stmt|;
name|Node
name|node
init|=
name|session
operator|.
name|getRootNode
argument_list|()
operator|.
name|addNode
argument_list|(
literal|"largeMultiValueProperty"
argument_list|,
literal|"nt:unstructured"
argument_list|)
decl_stmt|;
name|String
index|[]
name|largeArray
init|=
operator|new
name|String
index|[
literal|1000
operator|+
literal|1
index|]
decl_stmt|;
comment|//ItemImpl.MV_PROPERTY_WARN_THRESHOLD - 1000
name|Arrays
operator|.
name|fill
argument_list|(
name|largeArray
argument_list|,
literal|"x"
argument_list|)
expr_stmt|;
name|Property
name|p
init|=
name|node
operator|.
name|setProperty
argument_list|(
literal|"fooProp"
argument_list|,
name|largeArray
argument_list|)
decl_stmt|;
name|Property
name|p2
init|=
name|node
operator|.
name|setProperty
argument_list|(
literal|"barProp"
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"x"
block|}
argument_list|)
decl_stmt|;
name|p2
operator|.
name|setValue
argument_list|(
name|largeArray
argument_list|)
expr_stmt|;
name|session
operator|.
name|save
argument_list|()
expr_stmt|;
name|rootLogger
argument_list|()
operator|.
name|detachAppender
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|stop
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
name|logMessages
operator|.
name|size
argument_list|()
operator|>=
literal|2
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
literal|"Warn log message must contains a reference to the large array property path"
argument_list|,
name|logMessages
operator|.
name|toString
argument_list|()
argument_list|,
name|containsString
argument_list|(
name|p
operator|.
name|getPath
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
literal|"Warn log message must contains a reference to the large array property path"
argument_list|,
name|logMessages
operator|.
name|toString
argument_list|()
argument_list|,
name|containsString
argument_list|(
name|p2
operator|.
name|getPath
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
specifier|private
specifier|static
name|ch
operator|.
name|qos
operator|.
name|logback
operator|.
name|classic
operator|.
name|Logger
name|rootLogger
parameter_list|()
block|{
return|return
operator|(
operator|(
name|LoggerContext
operator|)
name|LoggerFactory
operator|.
name|getILoggerFactory
argument_list|()
operator|)
operator|.
name|getLogger
argument_list|(
name|ch
operator|.
name|qos
operator|.
name|logback
operator|.
name|classic
operator|.
name|Logger
operator|.
name|ROOT_LOGGER_NAME
argument_list|)
return|;
block|}
comment|//------------------------------------------------------------< private>---
specifier|private
name|Node
name|getNode
parameter_list|(
name|String
name|path
parameter_list|)
throws|throws
name|RepositoryException
block|{
return|return
name|getAdminSession
argument_list|()
operator|.
name|getNode
argument_list|(
name|path
argument_list|)
return|;
block|}
specifier|private
name|Property
name|getProperty
parameter_list|(
name|String
name|path
parameter_list|)
throws|throws
name|RepositoryException
block|{
return|return
name|getAdminSession
argument_list|()
operator|.
name|getProperty
argument_list|(
name|path
argument_list|)
return|;
block|}
specifier|private
name|void
name|addProperty
parameter_list|(
name|Node
name|parentNode
parameter_list|,
name|String
name|name
parameter_list|,
name|Value
name|value
parameter_list|)
throws|throws
name|RepositoryException
throws|,
name|IOException
block|{
name|String
name|propertyPath
init|=
name|parentNode
operator|.
name|getPath
argument_list|()
operator|+
literal|'/'
operator|+
name|name
decl_stmt|;
name|assertFalse
argument_list|(
name|getAdminSession
argument_list|()
operator|.
name|propertyExists
argument_list|(
name|propertyPath
argument_list|)
argument_list|)
expr_stmt|;
name|Property
name|added
init|=
name|parentNode
operator|.
name|setProperty
argument_list|(
name|name
argument_list|,
name|value
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|parentNode
operator|.
name|isModified
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|added
operator|.
name|isModified
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|added
operator|.
name|isNew
argument_list|()
argument_list|)
expr_stmt|;
name|getAdminSession
argument_list|()
operator|.
name|save
argument_list|()
expr_stmt|;
name|Session
name|session2
init|=
name|createAnonymousSession
argument_list|()
decl_stmt|;
try|try
block|{
name|assertTrue
argument_list|(
name|session2
operator|.
name|propertyExists
argument_list|(
name|propertyPath
argument_list|)
argument_list|)
expr_stmt|;
name|Value
name|value2
init|=
name|session2
operator|.
name|getProperty
argument_list|(
name|propertyPath
argument_list|)
operator|.
name|getValue
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|value
operator|.
name|getType
argument_list|()
argument_list|,
name|value2
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|.
name|getType
argument_list|()
operator|==
name|PropertyType
operator|.
name|BINARY
condition|)
block|{
name|assertEqualStream
argument_list|(
name|value
operator|.
name|getStream
argument_list|()
argument_list|,
name|value2
operator|.
name|getStream
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|assertEquals
argument_list|(
name|value
operator|.
name|getString
argument_list|()
argument_list|,
name|value2
operator|.
name|getString
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|value2
operator|.
name|getType
argument_list|()
operator|==
name|PropertyType
operator|.
name|REFERENCE
operator|||
name|value2
operator|.
name|getType
argument_list|()
operator|==
name|PropertyType
operator|.
name|WEAKREFERENCE
condition|)
block|{
name|String
name|ref
init|=
name|value2
operator|.
name|getString
argument_list|()
decl_stmt|;
name|assertNotNull
argument_list|(
name|getAdminSession
argument_list|()
operator|.
name|getNodeByIdentifier
argument_list|(
name|ref
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
name|session2
operator|.
name|logout
argument_list|()
expr_stmt|;
block|}
block|}
specifier|private
specifier|static
name|void
name|assertEqualStream
parameter_list|(
name|InputStream
name|is1
parameter_list|,
name|InputStream
name|is2
parameter_list|)
throws|throws
name|IOException
block|{
name|byte
index|[]
name|buf1
init|=
operator|new
name|byte
index|[
literal|65536
index|]
decl_stmt|;
name|byte
index|[]
name|buf2
init|=
operator|new
name|byte
index|[
literal|65536
index|]
decl_stmt|;
name|int
name|c
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|c
operator|!=
operator|-
literal|1
condition|)
block|{
name|assertEquals
argument_list|(
name|c
operator|=
name|is1
operator|.
name|read
argument_list|(
name|buf1
argument_list|)
argument_list|,
name|is2
operator|.
name|read
argument_list|(
name|buf2
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|c
condition|;
name|i
operator|++
control|)
block|{
name|assertEquals
argument_list|(
name|buf1
index|[
name|i
index|]
argument_list|,
name|buf2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|//------------------------------------------------------------< NumberStream>---
comment|/**      * Dummy stream class used by the binary property tests.      */
specifier|private
specifier|static
class|class
name|NumberStream
extends|extends
name|InputStream
block|{
specifier|private
specifier|final
name|int
name|limit
decl_stmt|;
specifier|private
name|int
name|counter
decl_stmt|;
specifier|public
name|NumberStream
parameter_list|(
name|int
name|limit
parameter_list|)
block|{
name|this
operator|.
name|limit
operator|=
name|limit
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|int
name|read
parameter_list|()
throws|throws
name|IOException
block|{
return|return
name|counter
operator|<
name|limit
condition|?
name|counter
operator|++
operator|&
literal|0xff
else|:
operator|-
literal|1
return|;
block|}
block|}
block|}
end_class

end_unit

