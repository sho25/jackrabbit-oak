begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to You under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *   http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing,  * software distributed under the License is distributed on an  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  * KIND, either express or implied.  See the License for the  * specific language governing permissions and limitations  * under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|plugins
operator|.
name|blob
operator|.
name|datastore
package|;
end_package

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|assertEquals
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|assertFalse
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|assertTrue
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|OutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|time
operator|.
name|Instant
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Executors
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ScheduledExecutorService
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|function
operator|.
name|Function
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|RepositoryException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|management
operator|.
name|openmbean
operator|.
name|CompositeData
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Lists
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|DataIdentifier
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|DataRecord
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|DataStore
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|DataStoreException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|RandomInputStream
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|api
operator|.
name|blob
operator|.
name|BlobDownloadOptions
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|commons
operator|.
name|IOUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|commons
operator|.
name|concurrent
operator|.
name|ExecutorCloser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|plugins
operator|.
name|blob
operator|.
name|BlobStoreBlob
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|plugins
operator|.
name|blob
operator|.
name|BlobStoreStats
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|spi
operator|.
name|blob
operator|.
name|BlobOptions
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|stats
operator|.
name|DefaultStatisticsProvider
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|stats
operator|.
name|StatisticsProvider
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|After
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Rule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|rules
operator|.
name|TemporaryFolder
import|;
end_import

begin_class
specifier|public
class|class
name|DataStoreBlobStoreStatsTest
block|{
annotation|@
name|Rule
specifier|public
name|TemporaryFolder
name|folder
init|=
operator|new
name|TemporaryFolder
argument_list|(
operator|new
name|File
argument_list|(
literal|"target"
argument_list|)
argument_list|)
decl_stmt|;
specifier|private
name|ScheduledExecutorService
name|executor
init|=
name|Executors
operator|.
name|newSingleThreadScheduledExecutor
argument_list|()
decl_stmt|;
specifier|private
name|StatisticsProvider
name|statsProvider
init|=
operator|new
name|DefaultStatisticsProvider
argument_list|(
name|executor
argument_list|)
decl_stmt|;
specifier|private
name|BlobStoreStats
name|stats
init|=
operator|new
name|BlobStoreStats
argument_list|(
name|statsProvider
argument_list|)
decl_stmt|;
specifier|private
specifier|static
name|int
name|BLOB_LEN
init|=
literal|20
operator|*
literal|1024
decl_stmt|;
annotation|@
name|After
specifier|public
name|void
name|shutDown
parameter_list|()
block|{
operator|new
name|ExecutorCloser
argument_list|(
name|executor
argument_list|)
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSReadBlobStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withReadDelay
argument_list|(
literal|500
argument_list|)
argument_list|)
decl_stmt|;
name|String
name|blobId1
init|=
name|dsbs
operator|.
name|writeBlob
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|blobId2
init|=
name|dsbs
operator|.
name|writeBlob
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|downloadCount
init|=
name|stats
operator|.
name|getDownloadCount
argument_list|()
decl_stmt|;
name|long
name|downloadCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getDownloadCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|downloadTotalSize
init|=
name|stats
operator|.
name|getDownloadTotalSize
argument_list|()
decl_stmt|;
name|long
name|getRecordCount
init|=
name|stats
operator|.
name|getGetRecordCount
argument_list|()
decl_stmt|;
name|long
name|getRecordIfStoredCount
init|=
name|stats
operator|.
name|getGetRecordIfStoredCount
argument_list|()
decl_stmt|;
name|long
name|getRecordFromReferenceCount
init|=
name|stats
operator|.
name|getGetRecordFromReferenceCount
argument_list|()
decl_stmt|;
name|long
name|getRecordForIdCount
init|=
name|stats
operator|.
name|getGetRecordForIdCount
argument_list|()
decl_stmt|;
name|byte
index|[]
name|buffer
init|=
operator|new
name|byte
index|[
name|BLOB_LEN
index|]
decl_stmt|;
name|dsbs
operator|.
name|readBlob
argument_list|(
name|blobId1
argument_list|,
literal|0
argument_list|,
name|buffer
argument_list|,
literal|0
argument_list|,
name|BLOB_LEN
argument_list|)
expr_stmt|;
try|try
init|(
name|InputStream
name|inputStream
init|=
name|dsbs
operator|.
name|getInputStream
argument_list|(
name|blobId2
argument_list|)
init|)
block|{
while|while
condition|(
name|inputStream
operator|.
name|available
argument_list|()
operator|>
literal|0
condition|)
block|{
name|inputStream
operator|.
name|read
argument_list|()
expr_stmt|;
block|}
block|}
name|assertEquals
argument_list|(
name|downloadCount
operator|+
literal|2
argument_list|,
name|stats
operator|.
name|getDownloadCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|downloadTotalSize
operator|+
operator|(
name|BLOB_LEN
operator|*
literal|2
operator|)
argument_list|,
name|stats
operator|.
name|getDownloadTotalSize
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|downloadCountLastMinute
operator|+
literal|2
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getDownloadCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|2L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
comment|// Ensure that the metrics don't overlap.  Calling readBlob() shouldn't increment
comment|// the getRecord() counts.
name|assertEquals
argument_list|(
name|getRecordCount
argument_list|,
name|stats
operator|.
name|getGetRecordCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecordIfStoredCount
argument_list|,
name|stats
operator|.
name|getGetRecordIfStoredCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecordFromReferenceCount
argument_list|,
name|stats
operator|.
name|getGetRecordFromReferenceCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecordForIdCount
argument_list|,
name|stats
operator|.
name|getGetRecordForIdCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSReadBlobErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnGetRecord
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|blobId1
init|=
name|dsbs
operator|.
name|writeBlob
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|blobId2
init|=
name|dsbs
operator|.
name|writeBlob
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|downloadErrorCount
init|=
name|stats
operator|.
name|getDownloadErrorCount
argument_list|()
decl_stmt|;
name|long
name|downloadErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getDownloadErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getRecordErrorCount
init|=
name|stats
operator|.
name|getGetRecordErrorCount
argument_list|()
decl_stmt|;
name|long
name|getRecordIfStoredErrorCount
init|=
name|stats
operator|.
name|getGetRecordIfStoredErrorCount
argument_list|()
decl_stmt|;
name|long
name|getRecordFromReferenceErrorCount
init|=
name|stats
operator|.
name|getGetRecordFromReferenceErrorCount
argument_list|()
decl_stmt|;
name|long
name|getRecordForIdErrorCount
init|=
name|stats
operator|.
name|getGetRecordForIdErrorCount
argument_list|()
decl_stmt|;
name|byte
index|[]
name|buffer
init|=
operator|new
name|byte
index|[
name|BLOB_LEN
index|]
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|readBlob
argument_list|(
name|blobId1
argument_list|,
literal|0
argument_list|,
name|buffer
argument_list|,
literal|0
argument_list|,
name|BLOB_LEN
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{ }
try|try
block|{
name|dsbs
operator|.
name|getInputStream
argument_list|(
name|blobId2
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|downloadErrorCount
operator|+
literal|2
argument_list|,
name|stats
operator|.
name|getDownloadErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|downloadErrorCountLastMinute
operator|+
literal|2
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getDownloadErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|2L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
comment|// Ensure that the metrics don't overlap.  Calling readBlob() shouldn't increment
comment|// the getRecord() counts.
name|assertEquals
argument_list|(
name|getRecordErrorCount
argument_list|,
name|stats
operator|.
name|getGetRecordErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecordIfStoredErrorCount
argument_list|,
name|stats
operator|.
name|getGetRecordIfStoredErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecordFromReferenceErrorCount
argument_list|,
name|stats
operator|.
name|getGetRecordFromReferenceErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecordForIdErrorCount
argument_list|,
name|stats
operator|.
name|getGetRecordForIdErrorCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSWriteBlobStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withWriteDelay
argument_list|(
literal|1000
argument_list|)
argument_list|)
decl_stmt|;
name|long
name|uploadCount
init|=
name|stats
operator|.
name|getUploadCount
argument_list|()
decl_stmt|;
name|long
name|uploadTotalSize
init|=
name|stats
operator|.
name|getUploadTotalSize
argument_list|()
decl_stmt|;
name|long
name|uploadCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getUploadCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|uploadAmountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getUploadSizeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|uploadTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getUploadRateHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|addRecordCount
init|=
name|stats
operator|.
name|getAddRecordCount
argument_list|()
decl_stmt|;
name|dsbs
operator|.
name|writeBlob
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|uploadCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getUploadCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|uploadTotalSize
operator|+
name|BLOB_LEN
argument_list|,
name|stats
operator|.
name|getUploadTotalSize
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|uploadCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getUploadCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|uploadAmountLastMinute
operator|+
name|BLOB_LEN
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getUploadSizeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
operator|(
name|long
operator|)
name|BLOB_LEN
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|uploadTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getUploadRateHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
comment|// Ensure that the metrics don't overlap.  Calling writeBlob() shouldn't increment
comment|// the addRecord() counts.
name|assertEquals
argument_list|(
name|addRecordCount
argument_list|,
name|stats
operator|.
name|getAddRecordCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSWriteBlobErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnAddRecord
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|uploadErrorCount
init|=
name|stats
operator|.
name|getUploadErrorCount
argument_list|()
decl_stmt|;
name|long
name|uploadErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getUploadErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|addRecordErrorCount
init|=
name|stats
operator|.
name|getAddRecordErrorCount
argument_list|()
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|writeBlob
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{ }
try|try
block|{
name|dsbs
operator|.
name|writeBlob
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|,
operator|new
name|BlobOptions
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{ }
try|try
block|{
name|File
name|f
init|=
name|folder
operator|.
name|newFile
argument_list|()
decl_stmt|;
try|try
init|(
name|OutputStream
name|out
init|=
operator|new
name|FileOutputStream
argument_list|(
name|f
argument_list|)
init|)
block|{
name|IOUtils
operator|.
name|copy
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
name|dsbs
operator|.
name|writeBlob
argument_list|(
name|f
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|uploadErrorCount
operator|+
literal|3
argument_list|,
name|stats
operator|.
name|getUploadErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|uploadErrorCountLastMinute
operator|+
literal|3
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getUploadErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|3L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
comment|// Ensure that the metrics don't overlap.  Calling writeBlob() shouldn't increment
comment|// the addRecord() counts.
name|assertEquals
argument_list|(
name|addRecordErrorCount
argument_list|,
name|stats
operator|.
name|getAddRecordErrorCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSAddRecordStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withWriteDelay
argument_list|(
literal|1000
argument_list|)
argument_list|)
decl_stmt|;
name|long
name|addRecordCount
init|=
name|stats
operator|.
name|getAddRecordCount
argument_list|()
decl_stmt|;
name|long
name|addRecordSize
init|=
name|stats
operator|.
name|getAddRecordTotalSize
argument_list|()
decl_stmt|;
name|long
name|addRecordCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getAddRecordCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|addRecordSizeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getAddRecordSizeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|addRecordTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getAddRecordRateHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|uploadCount
init|=
name|stats
operator|.
name|getUploadCount
argument_list|()
decl_stmt|;
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
expr_stmt|;
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|,
operator|new
name|BlobOptions
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|addRecordCount
operator|+
literal|2
argument_list|,
name|stats
operator|.
name|getAddRecordCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|addRecordSize
operator|+
name|BLOB_LEN
operator|*
literal|2
argument_list|,
name|stats
operator|.
name|getAddRecordTotalSize
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|addRecordCountLastMinute
operator|+
literal|2
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getAddRecordCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|2L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|addRecordSizeLastMinute
operator|+
name|BLOB_LEN
operator|*
literal|2
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getAddRecordSizeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
operator|(
name|long
operator|)
name|BLOB_LEN
operator|*
literal|2
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|addRecordTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getAddRecordRateHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
comment|// Ensure that the metrics don't overlap.  Calling addRecord() shouldn't increment
comment|// the upload counts (which pertain to writeBlob()).
name|assertEquals
argument_list|(
name|uploadCount
argument_list|,
name|stats
operator|.
name|getUploadCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSAddRecordErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnAddRecord
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|addRecordErrorCount
init|=
name|stats
operator|.
name|getAddRecordErrorCount
argument_list|()
decl_stmt|;
name|long
name|addRecordErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getAddRecordErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|uploadErrorCount
init|=
name|stats
operator|.
name|getUploadErrorCount
argument_list|()
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
name|e
parameter_list|)
block|{ }
try|try
block|{
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|,
operator|new
name|BlobOptions
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|addRecordErrorCount
operator|+
literal|2
argument_list|,
name|stats
operator|.
name|getAddRecordErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|addRecordErrorCountLastMinute
operator|+
literal|2
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getAddRecordErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|2L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
comment|// Ensure that the metrics don't overlap.  Calling addRecord() shouldn't increment
comment|// the upload counts (which pertain to writeBlob()).
name|assertEquals
argument_list|(
name|uploadErrorCount
argument_list|,
name|stats
operator|.
name|getUploadErrorCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSGetRecordStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withReadDelay
argument_list|()
operator|.
name|withStatsCollector
argument_list|(
name|stats
argument_list|)
argument_list|)
decl_stmt|;
name|DataRecord
name|rec
init|=
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getRecCount
init|=
name|stats
operator|.
name|getGetRecordCount
argument_list|()
decl_stmt|;
name|long
name|getRecCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetRecordCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getRecTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetRecordTimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|downloadCount
init|=
name|stats
operator|.
name|getDownloadCount
argument_list|()
decl_stmt|;
name|dsbs
operator|.
name|getRecord
argument_list|(
name|rec
operator|.
name|getIdentifier
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getGetRecordCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetRecordCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|getRecTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetRecordTimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
comment|// Ensure that the metrics don't overlap.  Calling getRecord() shouldn't increment
comment|// the download counts (which pertain to readBlob()).
name|assertEquals
argument_list|(
name|downloadCount
argument_list|,
name|stats
operator|.
name|getDownloadCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSGetRecordErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnGetRecord
argument_list|()
argument_list|)
decl_stmt|;
name|DataRecord
name|rec
init|=
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getRecErrorCount
init|=
name|stats
operator|.
name|getGetRecordErrorCount
argument_list|()
decl_stmt|;
name|long
name|getRecErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetRecordErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|downloadErrorCount
init|=
name|stats
operator|.
name|getDownloadErrorCount
argument_list|()
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|getRecord
argument_list|(
name|rec
operator|.
name|getIdentifier
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|getRecErrorCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getGetRecordErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecErrorCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetRecordErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
comment|// Ensure that the metrics don't overlap.  Calling getRecord() shouldn't increment
comment|// the download error counts (which pertain to readBlob()).
name|assertEquals
argument_list|(
name|downloadErrorCount
argument_list|,
name|stats
operator|.
name|getDownloadErrorCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSGetRecordIfStoredStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withReadDelay
argument_list|()
argument_list|)
decl_stmt|;
name|DataRecord
name|rec
init|=
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getRecIfStoredCount
init|=
name|stats
operator|.
name|getGetRecordIfStoredCount
argument_list|()
decl_stmt|;
name|long
name|getRecIfStoredCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetRecordIfStoredCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getRecIfStoredTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetRecordIfStoredTimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|downloadCount
init|=
name|stats
operator|.
name|getDownloadCount
argument_list|()
decl_stmt|;
name|dsbs
operator|.
name|getRecordIfStored
argument_list|(
name|rec
operator|.
name|getIdentifier
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecIfStoredCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getGetRecordIfStoredCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecIfStoredCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetRecordIfStoredCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|getRecIfStoredTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetRecordIfStoredTimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
comment|// Ensure that the metrics don't overlap.  Calling getRecordIfStored() shouldn't increment
comment|// the download counts (which pertain to readBlob()).
name|assertEquals
argument_list|(
name|downloadCount
argument_list|,
name|stats
operator|.
name|getDownloadCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSGetRecordIfStoredErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnGetRecord
argument_list|()
argument_list|)
decl_stmt|;
name|DataRecord
name|rec
init|=
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getRecIfStoredErrorCount
init|=
name|stats
operator|.
name|getGetRecordIfStoredErrorCount
argument_list|()
decl_stmt|;
name|long
name|getRecIfStoredErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetRecordIfStoredErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|downloadErrorCount
init|=
name|stats
operator|.
name|getDownloadErrorCount
argument_list|()
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|getRecordIfStored
argument_list|(
name|rec
operator|.
name|getIdentifier
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|getRecIfStoredErrorCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getGetRecordIfStoredErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecIfStoredErrorCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetRecordIfStoredErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
comment|// Ensure that the metrics don't overlap.  Calling getRecordIfStored() shouldn't increment
comment|// the download error counts (which pertain to readBlob()).
name|assertEquals
argument_list|(
name|downloadErrorCount
argument_list|,
name|stats
operator|.
name|getDownloadErrorCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSGetRecordFromReferenceStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withReadDelay
argument_list|()
argument_list|)
decl_stmt|;
name|DataRecord
name|rec
init|=
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getRecFromRefCount
init|=
name|stats
operator|.
name|getGetRecordFromReferenceCount
argument_list|()
decl_stmt|;
name|long
name|getRecFromRefCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetRecordFromReferenceCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getRecFromRefTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetRecordFromReferenceTimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|downloadCount
init|=
name|stats
operator|.
name|getDownloadCount
argument_list|()
decl_stmt|;
name|dsbs
operator|.
name|getRecordFromReference
argument_list|(
name|rec
operator|.
name|getReference
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecFromRefCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getGetRecordFromReferenceCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecFromRefCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetRecordFromReferenceCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|getRecFromRefTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetRecordFromReferenceTimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
comment|// Ensure that the metrics don't overlap.  Calling getRecordFromReference() shouldn't increment
comment|// the download counts (which pertain to readBlob()).
name|assertEquals
argument_list|(
name|downloadCount
argument_list|,
name|stats
operator|.
name|getDownloadCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSGetRecordFromReferenceErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnGetRecord
argument_list|()
argument_list|)
decl_stmt|;
name|DataRecord
name|rec
init|=
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getRecFromRefErrorCount
init|=
name|stats
operator|.
name|getGetRecordFromReferenceErrorCount
argument_list|()
decl_stmt|;
name|long
name|getRecFromRefErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetRecordFromReferenceErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|downloadErrorCount
init|=
name|stats
operator|.
name|getDownloadErrorCount
argument_list|()
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|getRecordFromReference
argument_list|(
name|rec
operator|.
name|getReference
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|getRecFromRefErrorCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getGetRecordFromReferenceErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecFromRefErrorCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetRecordFromReferenceErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
comment|// Ensure that the metrics don't overlap.  Calling getRecordFromReference() shouldn't increment
comment|// the download error counts (which pertain to readBlob()).
name|assertEquals
argument_list|(
name|downloadErrorCount
argument_list|,
name|stats
operator|.
name|getDownloadErrorCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSGetRecordForIdStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withReadDelay
argument_list|()
argument_list|)
decl_stmt|;
name|DataRecord
name|rec
init|=
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getRecForIdCount
init|=
name|stats
operator|.
name|getGetRecordForIdCount
argument_list|()
decl_stmt|;
name|long
name|getRecForIdCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetRecordForIdCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getRecForIdTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetRecordForIdTimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|downloadCount
init|=
name|stats
operator|.
name|getDownloadCount
argument_list|()
decl_stmt|;
name|dsbs
operator|.
name|getRecordForId
argument_list|(
name|rec
operator|.
name|getIdentifier
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecForIdCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getGetRecordForIdCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecForIdCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetRecordForIdCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|getRecForIdTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetRecordForIdTimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
comment|// Ensure that the metrics don't overlap.  Calling getRecordForId() shouldn't increment
comment|// the download counts (which pertain to readBlob()).
name|assertEquals
argument_list|(
name|downloadCount
argument_list|,
name|stats
operator|.
name|getDownloadCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSGetRecordForIdErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnGetRecord
argument_list|()
argument_list|)
decl_stmt|;
name|DataRecord
name|rec
init|=
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getRecForIdErrorCount
init|=
name|stats
operator|.
name|getGetRecordForIdErrorCount
argument_list|()
decl_stmt|;
name|long
name|getRecForIdErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetRecordForIdErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|downloadErrorCount
init|=
name|stats
operator|.
name|getDownloadErrorCount
argument_list|()
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|getRecordForId
argument_list|(
name|rec
operator|.
name|getIdentifier
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|getRecForIdErrorCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getGetRecordForIdErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getRecForIdErrorCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetRecordForIdErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
comment|// Ensure that the metrics don't overlap.  Calling getRecordForId() shouldn't increment
comment|// the download error counts (which pertain to readBlob()).
name|assertEquals
argument_list|(
name|downloadErrorCount
argument_list|,
name|stats
operator|.
name|getDownloadErrorCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSGetAllRecordsStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withListDelay
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getAllRecordsCount
init|=
name|stats
operator|.
name|getGetAllRecordsCount
argument_list|()
decl_stmt|;
name|long
name|getAllRecordsCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetAllRecordsCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getAllRecordsTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetAllRecordsTimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|dsbs
operator|.
name|getAllRecords
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
name|getAllRecordsCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getGetAllRecordsCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getAllRecordsCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetAllRecordsCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|getAllRecordsTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetAllRecordsTimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSDeleteRecordStats
parameter_list|()
throws|throws
name|Exception
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withDeleteDelay
argument_list|(
literal|1010
argument_list|)
argument_list|)
decl_stmt|;
name|DataRecord
name|record
init|=
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|chunkIds
init|=
name|Lists
operator|.
name|newArrayList
argument_list|(
name|record
operator|.
name|getIdentifier
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|modifiedBefore
init|=
name|tomorrow
argument_list|()
decl_stmt|;
name|long
name|deleteCount
init|=
name|stats
operator|.
name|getDeleteCount
argument_list|()
decl_stmt|;
name|long
name|deleteCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getDeleteCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|deleteTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getDeleteTimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|idInDsbs
argument_list|(
name|record
operator|.
name|getIdentifier
argument_list|()
argument_list|,
name|dsbs
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|dsbs
operator|.
name|deleteChunks
argument_list|(
name|chunkIds
argument_list|,
name|modifiedBefore
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|idInDsbs
argument_list|(
name|record
operator|.
name|getIdentifier
argument_list|()
argument_list|,
name|dsbs
argument_list|)
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|deleteCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getDeleteCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|deleteCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getDeleteCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|deleteTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getDeleteTimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSDeleteRecordErrorStats
parameter_list|()
throws|throws
name|Exception
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnDeleteRecord
argument_list|()
argument_list|)
decl_stmt|;
name|DataRecord
name|record
init|=
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|chunkIds
init|=
name|Lists
operator|.
name|newArrayList
argument_list|(
name|record
operator|.
name|getIdentifier
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|modifiedBefore
init|=
name|tomorrow
argument_list|()
decl_stmt|;
name|long
name|deleteErrorCount
init|=
name|stats
operator|.
name|getDeleteErrorCount
argument_list|()
decl_stmt|;
name|long
name|deleteErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getDeleteErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|deleteChunks
argument_list|(
name|chunkIds
argument_list|,
name|modifiedBefore
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|deleteErrorCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getDeleteErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|deleteErrorCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getDeleteErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSDeleteAllOlderThanStats
parameter_list|()
throws|throws
name|Exception
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withDeleteDelay
argument_list|(
literal|1010
argument_list|)
argument_list|)
decl_stmt|;
name|DataRecord
name|record
init|=
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|modifiedBefore
init|=
name|tomorrow
argument_list|()
decl_stmt|;
name|long
name|deleteByDateCount
init|=
name|stats
operator|.
name|getDeleteByDateCount
argument_list|()
decl_stmt|;
name|long
name|deleteByDateCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getDeleteByDateCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|deleteByDateTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getDeleteByDateTimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|idInDsbs
argument_list|(
name|record
operator|.
name|getIdentifier
argument_list|()
argument_list|,
name|dsbs
argument_list|)
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|dsbs
operator|.
name|deleteAllOlderThan
argument_list|(
name|modifiedBefore
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|idInDsbs
argument_list|(
name|record
operator|.
name|getIdentifier
argument_list|()
argument_list|,
name|dsbs
argument_list|)
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|deleteByDateCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getDeleteByDateCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|deleteByDateCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getDeleteByDateCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|deleteByDateTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getDeleteByDateTimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSDeleteAllOlderThanErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnDeleteRecord
argument_list|()
argument_list|)
decl_stmt|;
name|DataRecord
name|record
init|=
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|modifiedBefore
init|=
name|tomorrow
argument_list|()
decl_stmt|;
name|long
name|deleteByDateErrorCount
init|=
name|stats
operator|.
name|getDeleteByDateErrorCount
argument_list|()
decl_stmt|;
name|long
name|deleteByDateErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getDeleteByDateErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|deleteAllOlderThan
argument_list|(
name|modifiedBefore
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|deleteByDateErrorCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getDeleteByDateErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|deleteByDateErrorCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getDeleteByDateErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSListIdsStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withListDelay
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|listIdsCount
init|=
name|stats
operator|.
name|getListIdsCount
argument_list|()
decl_stmt|;
name|long
name|listIdsCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getListIdsCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|listIdsTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getListIdsTimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|dsbs
operator|.
name|getAllIdentifiers
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
name|listIdsCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getListIdsCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|listIdsCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getListIdsCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|listIdsTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getListIdsTimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSListIdsErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnList
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|listIdsErrorCount
init|=
name|stats
operator|.
name|getListIdsErrorCount
argument_list|()
decl_stmt|;
name|long
name|listIdsErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getListIdsErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|getAllIdentifiers
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|listIdsErrorCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getListIdsErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|listIdsErrorCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getListIdsErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSAddMetaRecStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withWriteDelay
argument_list|()
argument_list|)
decl_stmt|;
name|File
name|f
init|=
name|folder
operator|.
name|newFile
argument_list|()
decl_stmt|;
try|try
init|(
name|OutputStream
name|out
init|=
operator|new
name|FileOutputStream
argument_list|(
name|f
argument_list|)
init|)
block|{
name|IOUtils
operator|.
name|copy
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
name|long
name|addMetadataRecordCount
init|=
name|stats
operator|.
name|getAddMetadataRecordCount
argument_list|()
decl_stmt|;
name|long
name|addMetadataRecordCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getAddMetadataRecordCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|addMetadataRecordTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getAddMetadataRecordTimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|dsbs
operator|.
name|addMetadataRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|,
literal|"meta-1"
argument_list|)
expr_stmt|;
name|dsbs
operator|.
name|addMetadataRecord
argument_list|(
name|f
argument_list|,
literal|"meta-1"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|addMetadataRecordCount
operator|+
literal|2
argument_list|,
name|stats
operator|.
name|getAddMetadataRecordCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|addMetadataRecordCountLastMinute
operator|+
literal|2
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getAddMetadataRecordCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|2L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|addMetadataRecordTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getAddMetadataRecordTimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSAddMetaRecErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnAddRecord
argument_list|()
argument_list|)
decl_stmt|;
name|File
name|f
init|=
name|folder
operator|.
name|newFile
argument_list|()
decl_stmt|;
try|try
init|(
name|OutputStream
name|out
init|=
operator|new
name|FileOutputStream
argument_list|(
name|f
argument_list|)
init|)
block|{
name|IOUtils
operator|.
name|copy
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
name|long
name|addMetadataRecordErrorCount
init|=
name|stats
operator|.
name|getAddMetadataRecordErrorCount
argument_list|()
decl_stmt|;
name|long
name|addMetadataRecordErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getAddMetadataRecordErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|addMetadataRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|,
literal|"meta-1"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
name|e
parameter_list|)
block|{ }
try|try
block|{
name|dsbs
operator|.
name|addMetadataRecord
argument_list|(
name|f
argument_list|,
literal|"meta-1"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|addMetadataRecordErrorCount
operator|+
literal|2
argument_list|,
name|stats
operator|.
name|getAddMetadataRecordErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|addMetadataRecordErrorCountLastMinute
operator|+
literal|2
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getAddMetadataRecordErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|2L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSGetMetaRecStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withReadDelay
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|name
init|=
literal|"meta-1"
decl_stmt|;
name|dsbs
operator|.
name|addMetadataRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|long
name|getMetadataRecordCount
init|=
name|stats
operator|.
name|getGetMetadataRecordCount
argument_list|()
decl_stmt|;
name|long
name|getMetadataRecordCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetMetadataRecordCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getMetadataRecordTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetMetadataRecordTimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|dsbs
operator|.
name|getMetadataRecord
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getMetadataRecordCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getGetMetadataRecordCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getMetadataRecordCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetMetadataRecordCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|getMetadataRecordTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetMetadataRecordTimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSGetMetaRecErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnGetRecord
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getMetadataRecordErrorCount
init|=
name|stats
operator|.
name|getGetMetadataRecordErrorCount
argument_list|()
decl_stmt|;
name|long
name|getMetadataRecordErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetMetadataRecordErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|getMetadataRecord
argument_list|(
literal|"fake-name"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|getMetadataRecordErrorCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getGetMetadataRecordErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getMetadataRecordErrorCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetMetadataRecordErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSGetAllMetaRecsStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withListDelay
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getAllMetadataRecordsCount
init|=
name|stats
operator|.
name|getGetAllMetadataRecordsCount
argument_list|()
decl_stmt|;
name|long
name|getAllMetadataRecordsCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetAllMetadataRecordsCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getAllMetadataRecordsTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetAllMetadataRecordsTimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|dsbs
operator|.
name|getAllMetadataRecords
argument_list|(
literal|"prefix"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getAllMetadataRecordsCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getGetAllMetadataRecordsCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getAllMetadataRecordsCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetAllMetadataRecordsCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|getAllMetadataRecordsTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetAllMetadataRecordsTimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSGetAllMetaRecsErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnList
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getAllMetadataRecordsErrorCount
init|=
name|stats
operator|.
name|getGetAllMetadataRecordsErrorCount
argument_list|()
decl_stmt|;
name|long
name|getAllMetadataRecordsErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetAllMetadataRecordsErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|getAllMetadataRecords
argument_list|(
literal|"prefix"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|getAllMetadataRecordsErrorCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getGetAllMetadataRecordsErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getAllMetadataRecordsErrorCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetAllMetadataRecordsErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSMetaRecExistsStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withReadDelay
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|metadataRecordExistsCount
init|=
name|stats
operator|.
name|getMetadataRecordExistsCount
argument_list|()
decl_stmt|;
name|long
name|metadataRecordExistsCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getMetadataRecordExistsCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|metadataRecordExistsTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getMetadataRecordExistsTimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|dsbs
operator|.
name|metadataRecordExists
argument_list|(
literal|"fake-name"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|metadataRecordExistsCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getMetadataRecordExistsCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|metadataRecordExistsCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getMetadataRecordExistsCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|metadataRecordExistsTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getMetadataRecordExistsTimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSMetaRecExistsErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnGetRecord
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|metadataRecordExistsErrorCount
init|=
name|stats
operator|.
name|getMetadataRecordExistsErrorCount
argument_list|()
decl_stmt|;
name|long
name|metadataRecordExistsErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getMetadataRecordExistsErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|metadataRecordExists
argument_list|(
literal|"fake-name"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|metadataRecordExistsErrorCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getMetadataRecordExistsErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|metadataRecordExistsErrorCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getMetadataRecordExistsErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSMetaDeleteStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withDeleteDelay
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|name
init|=
literal|"meta-1"
decl_stmt|;
name|dsbs
operator|.
name|addMetadataRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|long
name|deleteMetadataRecordCount
init|=
name|stats
operator|.
name|getDeleteMetadataRecordCount
argument_list|()
decl_stmt|;
name|long
name|deleteMetadataRecordCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getDeleteMetadataRecordCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|deleteMetadataRecordTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getDeleteMetadataRecordTimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|dsbs
operator|.
name|deleteMetadataRecord
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|deleteMetadataRecordCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getDeleteMetadataRecordCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|deleteMetadataRecordCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getDeleteMetadataRecordCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|deleteMetadataRecordTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getDeleteMetadataRecordTimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSMetaDeleteErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnDeleteRecord
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|name
init|=
literal|"meta-1"
decl_stmt|;
name|dsbs
operator|.
name|addMetadataRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|long
name|deleteMetadataRecordErrorCount
init|=
name|stats
operator|.
name|getDeleteMetadataRecordErrorCount
argument_list|()
decl_stmt|;
name|long
name|deleteMetadataRecordErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getDeleteMetadataRecordErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|deleteMetadataRecord
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|deleteMetadataRecordErrorCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getDeleteMetadataRecordErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|deleteMetadataRecordErrorCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getDeleteMetadataRecordErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSMetaDeleteAllStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withDeleteDelay
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|name
init|=
literal|"meta-1"
decl_stmt|;
name|dsbs
operator|.
name|addMetadataRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|long
name|deleteAllMetadataRecordsCount
init|=
name|stats
operator|.
name|getDeleteAllMetadataRecordsCount
argument_list|()
decl_stmt|;
name|long
name|deleteAllMetadataRecordsCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getDeleteAllMetadataRecordsCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|deleteAllMetadataRecordsTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getDeleteAllMetadataRecordsTimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|dsbs
operator|.
name|deleteAllMetadataRecords
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|deleteAllMetadataRecordsCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getDeleteAllMetadataRecordsCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|deleteAllMetadataRecordsCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getDeleteAllMetadataRecordsCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|deleteAllMetadataRecordsTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getDeleteAllMetadataRecordsTimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSMetaDeleteAllErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnDeleteRecord
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|name
init|=
literal|"meta-1"
decl_stmt|;
name|dsbs
operator|.
name|addMetadataRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|long
name|deleteAllMetadataRecordsErrorCount
init|=
name|stats
operator|.
name|getDeleteAllMetadataRecordsErrorCount
argument_list|()
decl_stmt|;
name|long
name|deleteAllMetadataRecordsErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getDeleteAllMetadataRecordsErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|deleteAllMetadataRecords
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|deleteAllMetadataRecordsErrorCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getDeleteAllMetadataRecordsErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|deleteAllMetadataRecordsErrorCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getDeleteAllMetadataRecordsErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSInitUploadDBAStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withInitBlobUploadDelay
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|initBlobUploadCount
init|=
name|stats
operator|.
name|getInitBlobUploadCount
argument_list|()
decl_stmt|;
name|long
name|initBlobUploadCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getInitBlobUploadCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|initBlobUploadTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getInitBlobUploadTimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|dsbs
operator|.
name|initiateBlobUpload
argument_list|(
name|BLOB_LEN
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|initBlobUploadCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getInitBlobUploadCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|initBlobUploadCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getInitBlobUploadCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|initBlobUploadTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getInitBlobUploadTimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSInitUploadDBAErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnInitBlobUpload
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|initBlobUploadErrorCount
init|=
name|stats
operator|.
name|getInitBlobUploadErrorCount
argument_list|()
decl_stmt|;
name|long
name|initBlobUploadErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getInitBlobUploadErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|initiateBlobUpload
argument_list|(
name|BLOB_LEN
argument_list|,
literal|20
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|initBlobUploadErrorCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getInitBlobUploadErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|initBlobUploadErrorCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getInitBlobUploadErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSCompleteUploadDBAStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withCompleteBlobUploadDelay
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|completeBlobUploadCount
init|=
name|stats
operator|.
name|getCompleteBlobUploadCount
argument_list|()
decl_stmt|;
name|long
name|completeBlobUploadCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getCompleteBlobUploadCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|completeBlobUploadTimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getCompleteBlobUploadTimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|dsbs
operator|.
name|completeBlobUpload
argument_list|(
literal|"fake token"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|completeBlobUploadCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getCompleteBlobUploadCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|completeBlobUploadCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getCompleteBlobUploadCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|completeBlobUploadTimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getCompleteBlobUploadTimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSCompleteUploadDBAErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnCompleteBlobUpload
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|completeBlobUploadErrorCount
init|=
name|stats
operator|.
name|getCompleteBlobUploadErrorCount
argument_list|()
decl_stmt|;
name|long
name|completeBlobUploadErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getCompleteBlobUploadErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|dsbs
operator|.
name|completeBlobUpload
argument_list|(
literal|"fake token"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IllegalArgumentException
name|e
parameter_list|)
block|{ }
name|assertEquals
argument_list|(
name|completeBlobUploadErrorCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getCompleteBlobUploadErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|completeBlobUploadErrorCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getCompleteBlobUploadErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSDownloadGetUriDBAStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withGetDownloadURIDelay
argument_list|()
argument_list|)
decl_stmt|;
name|DataRecord
name|rec
init|=
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getBlobDownloadURICount
init|=
name|stats
operator|.
name|getGetBlobDownloadURICount
argument_list|()
decl_stmt|;
name|long
name|getBlobDownloadURICountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetBlobDownloadURICountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getBlobDownloadURITimeLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetBlobDownloadURITimeHistory
argument_list|()
argument_list|)
decl_stmt|;
name|dsbs
operator|.
name|getDownloadURI
argument_list|(
operator|new
name|BlobStoreBlob
argument_list|(
name|dsbs
argument_list|,
name|rec
operator|.
name|getIdentifier
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
argument_list|,
name|BlobDownloadOptions
operator|.
name|DEFAULT
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getBlobDownloadURICount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getGetBlobDownloadURICount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getBlobDownloadURICountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetBlobDownloadURICountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|getBlobDownloadURITimeLastMinute
operator|<
name|waitForNonzeroMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetBlobDownloadURITimeHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDSBSDownloadGetURIDBAErrorStats
parameter_list|()
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
name|setupDSBS
argument_list|(
name|getDSBuilder
argument_list|()
operator|.
name|withErrorOnGetDownloadURI
argument_list|()
argument_list|)
decl_stmt|;
name|DataRecord
name|rec
init|=
name|dsbs
operator|.
name|addRecord
argument_list|(
name|getTestInputStream
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|getBlobDownloadURIErrorCount
init|=
name|stats
operator|.
name|getGetBlobDownloadURIErrorCount
argument_list|()
decl_stmt|;
name|long
name|getBlobDownloadURIErrorCountLastMinute
init|=
name|getLastMinuteStats
argument_list|(
name|stats
operator|.
name|getGetBlobDownloadURIErrorCountHistory
argument_list|()
argument_list|)
decl_stmt|;
name|dsbs
operator|.
name|getDownloadURI
argument_list|(
operator|new
name|BlobStoreBlob
argument_list|(
name|dsbs
argument_list|,
name|rec
operator|.
name|getIdentifier
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
argument_list|,
name|BlobDownloadOptions
operator|.
name|DEFAULT
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getBlobDownloadURIErrorCount
operator|+
literal|1
argument_list|,
name|stats
operator|.
name|getGetBlobDownloadURIErrorCount
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|getBlobDownloadURIErrorCountLastMinute
operator|+
literal|1
argument_list|,
name|waitForMetric
argument_list|(
name|input
lambda|->
name|getLastMinuteStats
argument_list|(
name|input
operator|.
name|getGetBlobDownloadURIErrorCountHistory
argument_list|()
argument_list|)
argument_list|,
name|stats
argument_list|,
literal|1L
argument_list|,
literal|0L
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
specifier|private
name|InputStream
name|getTestInputStream
parameter_list|()
block|{
return|return
operator|new
name|RandomInputStream
argument_list|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
argument_list|,
name|BLOB_LEN
argument_list|)
return|;
block|}
specifier|private
name|DataStore
name|setupDS
parameter_list|(
name|BlobStoreStatsTestableFileDataStore
operator|.
name|BlobStoreStatsTestableFileDataStoreBuilder
name|dsBuilder
parameter_list|)
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStore
name|ds
init|=
name|dsBuilder
operator|.
name|build
argument_list|()
decl_stmt|;
name|File
name|homeDir
init|=
name|folder
operator|.
name|newFolder
argument_list|()
decl_stmt|;
name|ds
operator|.
name|init
argument_list|(
name|homeDir
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|ds
return|;
block|}
specifier|private
specifier|static
name|long
name|sum
parameter_list|(
name|long
index|[]
name|d
parameter_list|)
block|{
name|long
name|result
init|=
literal|0L
decl_stmt|;
for|for
control|(
name|Long
name|l
range|:
name|d
control|)
block|{
name|result
operator|+=
name|l
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
specifier|private
specifier|static
name|long
name|getLastMinuteStats
parameter_list|(
name|CompositeData
name|data
parameter_list|)
block|{
return|return
name|sum
argument_list|(
operator|(
name|long
index|[]
operator|)
name|data
operator|.
name|get
argument_list|(
literal|"per second"
argument_list|)
argument_list|)
return|;
block|}
specifier|private
specifier|static
parameter_list|<
name|T
parameter_list|,
name|R
parameter_list|>
name|R
name|waitForMetric
parameter_list|(
name|Function
argument_list|<
name|T
argument_list|,
name|R
argument_list|>
name|f
parameter_list|,
name|T
name|input
parameter_list|,
name|R
name|expected
parameter_list|,
name|R
name|defaultValue
parameter_list|)
block|{
return|return
name|waitForMetric
argument_list|(
name|f
argument_list|,
name|input
argument_list|,
name|expected
argument_list|,
name|defaultValue
argument_list|,
literal|100
argument_list|,
literal|1000
argument_list|)
return|;
block|}
specifier|private
specifier|static
parameter_list|<
name|T
parameter_list|,
name|R
parameter_list|>
name|R
name|waitForMetric
parameter_list|(
name|Function
argument_list|<
name|T
argument_list|,
name|R
argument_list|>
name|f
parameter_list|,
name|T
name|input
parameter_list|,
name|R
name|expected
parameter_list|,
name|R
name|defaultValue
parameter_list|,
name|int
name|intervalMilliseconds
parameter_list|,
name|int
name|waitMilliseconds
parameter_list|)
block|{
name|long
name|end
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|+
name|waitMilliseconds
decl_stmt|;
name|R
name|output
init|=
name|f
operator|.
name|apply
argument_list|(
name|input
argument_list|)
decl_stmt|;
if|if
condition|(
literal|null
operator|!=
name|output
operator|&&
name|output
operator|.
name|equals
argument_list|(
name|expected
argument_list|)
condition|)
block|{
return|return
name|output
return|;
block|}
do|do
block|{
try|try
block|{
name|Thread
operator|.
name|sleep
argument_list|(
name|intervalMilliseconds
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{ }
name|output
operator|=
name|f
operator|.
name|apply
argument_list|(
name|input
argument_list|)
expr_stmt|;
if|if
condition|(
literal|null
operator|!=
name|output
operator|&&
name|output
operator|.
name|equals
argument_list|(
name|expected
argument_list|)
condition|)
block|{
return|return
name|output
return|;
block|}
block|}
do|while
condition|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|<
name|end
condition|)
do|;
return|return
name|defaultValue
return|;
block|}
specifier|private
specifier|static
parameter_list|<
name|T
parameter_list|>
name|Long
name|waitForNonzeroMetric
parameter_list|(
name|Function
argument_list|<
name|T
argument_list|,
name|Long
argument_list|>
name|f
parameter_list|,
name|T
name|input
parameter_list|)
block|{
return|return
name|waitForNonzeroMetric
argument_list|(
name|f
argument_list|,
name|input
argument_list|,
literal|100
argument_list|,
literal|1000
argument_list|)
return|;
block|}
specifier|private
specifier|static
parameter_list|<
name|T
parameter_list|>
name|Long
name|waitForNonzeroMetric
parameter_list|(
name|Function
argument_list|<
name|T
argument_list|,
name|Long
argument_list|>
name|f
parameter_list|,
name|T
name|input
parameter_list|,
name|int
name|intervalMilliseconds
parameter_list|,
name|int
name|waitMilliseconds
parameter_list|)
block|{
name|long
name|end
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|+
name|waitMilliseconds
decl_stmt|;
name|Long
name|output
init|=
name|f
operator|.
name|apply
argument_list|(
name|input
argument_list|)
decl_stmt|;
if|if
condition|(
literal|null
operator|!=
name|output
operator|&&
name|output
operator|>
literal|0L
condition|)
block|{
return|return
name|output
return|;
block|}
do|do
block|{
try|try
block|{
name|Thread
operator|.
name|sleep
argument_list|(
name|intervalMilliseconds
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{ }
name|output
operator|=
name|f
operator|.
name|apply
argument_list|(
name|input
argument_list|)
expr_stmt|;
if|if
condition|(
literal|null
operator|!=
name|output
operator|&&
name|output
operator|>
literal|0L
condition|)
block|{
return|return
name|output
return|;
block|}
block|}
do|while
condition|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|<
name|end
condition|)
do|;
return|return
literal|0L
return|;
block|}
specifier|private
name|boolean
name|idInDsbs
parameter_list|(
name|DataIdentifier
name|id
parameter_list|,
name|DataStoreBlobStore
name|dsbs
parameter_list|)
throws|throws
name|DataStoreException
block|{
name|Iterator
argument_list|<
name|DataIdentifier
argument_list|>
name|iter
init|=
name|dsbs
operator|.
name|getAllIdentifiers
argument_list|()
decl_stmt|;
while|while
condition|(
name|iter
operator|.
name|hasNext
argument_list|()
condition|)
block|{
if|if
condition|(
name|iter
operator|.
name|next
argument_list|()
operator|.
name|equals
argument_list|(
name|id
argument_list|)
condition|)
block|{
return|return
literal|true
return|;
block|}
block|}
return|return
literal|false
return|;
block|}
specifier|private
name|long
name|tomorrow
parameter_list|()
block|{
return|return
name|Instant
operator|.
name|now
argument_list|()
operator|.
name|plusSeconds
argument_list|(
literal|86400
argument_list|)
operator|.
name|toEpochMilli
argument_list|()
return|;
block|}
specifier|private
name|BlobStoreStatsTestableFileDataStore
operator|.
name|BlobStoreStatsTestableFileDataStoreBuilder
name|getDSBuilder
parameter_list|()
block|{
return|return
name|BlobStoreStatsTestableFileDataStore
operator|.
name|getBuilder
argument_list|()
return|;
block|}
specifier|private
name|DataStoreBlobStore
name|setupDSBS
parameter_list|(
name|BlobStoreStatsTestableFileDataStore
operator|.
name|BlobStoreStatsTestableFileDataStoreBuilder
name|dsBuilder
parameter_list|)
throws|throws
name|IOException
throws|,
name|RepositoryException
block|{
name|DataStoreBlobStore
name|dsbs
init|=
operator|new
name|DataStoreBlobStore
argument_list|(
name|setupDS
argument_list|(
name|dsBuilder
argument_list|)
argument_list|)
decl_stmt|;
name|dsbs
operator|.
name|setBlobStatsCollector
argument_list|(
name|stats
argument_list|)
expr_stmt|;
return|return
name|dsbs
return|;
block|}
specifier|private
name|void
name|consumeStream
parameter_list|(
name|DataRecord
name|record
parameter_list|)
throws|throws
name|IOException
throws|,
name|DataStoreException
block|{
try|try
init|(
name|InputStream
name|recordStream
init|=
name|record
operator|.
name|getStream
argument_list|()
init|)
block|{
while|while
condition|(
name|recordStream
operator|.
name|available
argument_list|()
operator|>
literal|0
condition|)
block|{
name|recordStream
operator|.
name|read
argument_list|()
expr_stmt|;
block|}
block|}
block|}
block|}
end_class

end_unit

