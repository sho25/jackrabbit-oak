begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *   http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing,  * software distributed under the License is distributed on an  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  * KIND, either express or implied.  See the License for the  * specific language governing permissions and limitations  * under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|blob
operator|.
name|cloud
operator|.
name|azure
operator|.
name|blobstorage
package|;
end_package

begin_import
import|import static
name|java
operator|.
name|lang
operator|.
name|Thread
operator|.
name|currentThread
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|BufferedInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|ByteArrayInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileNotFoundException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|UnsupportedEncodingException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URI
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URISyntaxException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URLEncoder
import|;
end_import

begin_import
import|import
name|java
operator|.
name|security
operator|.
name|InvalidKeyException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|time
operator|.
name|Instant
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Date
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|EnumSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Properties
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Queue
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|UUID
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|TimeUnit
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Charsets
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Function
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Strings
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|cache
operator|.
name|Cache
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|cache
operator|.
name|CacheBuilder
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|AbstractIterator
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Lists
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Maps
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|AccessCondition
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|RequestOptions
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|ResultContinuation
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|ResultSegment
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|RetryPolicy
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|StorageException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|blob
operator|.
name|BlobListingDetails
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|blob
operator|.
name|BlobRequestOptions
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|blob
operator|.
name|BlockEntry
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|blob
operator|.
name|BlockListingFilter
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|blob
operator|.
name|CloudBlob
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|blob
operator|.
name|CloudBlobContainer
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|blob
operator|.
name|CloudBlobDirectory
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|blob
operator|.
name|CloudBlockBlob
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|blob
operator|.
name|CopyStatus
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|blob
operator|.
name|ListBlobItem
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|blob
operator|.
name|SharedAccessBlobHeaders
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|blob
operator|.
name|SharedAccessBlobPermissions
import|;
end_import

begin_import
import|import
name|com
operator|.
name|microsoft
operator|.
name|azure
operator|.
name|storage
operator|.
name|blob
operator|.
name|SharedAccessBlobPolicy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|io
operator|.
name|IOUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|DataIdentifier
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|DataRecord
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|core
operator|.
name|data
operator|.
name|DataStoreException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|commons
operator|.
name|PropertiesUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|plugins
operator|.
name|blob
operator|.
name|datastore
operator|.
name|directaccess
operator|.
name|DataRecordUploadException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|plugins
operator|.
name|blob
operator|.
name|datastore
operator|.
name|directaccess
operator|.
name|DataRecordUploadToken
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|plugins
operator|.
name|blob
operator|.
name|datastore
operator|.
name|directaccess
operator|.
name|DataRecordDownloadOptions
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|plugins
operator|.
name|blob
operator|.
name|datastore
operator|.
name|directaccess
operator|.
name|DataRecordUpload
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|spi
operator|.
name|blob
operator|.
name|AbstractDataRecord
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|spi
operator|.
name|blob
operator|.
name|AbstractSharedBackend
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|util
operator|.
name|Base64
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jetbrains
operator|.
name|annotations
operator|.
name|NotNull
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_class
specifier|public
class|class
name|AzureBlobStoreBackend
extends|extends
name|AbstractSharedBackend
block|{
specifier|private
specifier|static
specifier|final
name|Logger
name|LOG
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|AzureBlobStoreBackend
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|META_DIR_NAME
init|=
literal|"META"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|META_KEY_PREFIX
init|=
name|META_DIR_NAME
operator|+
literal|"/"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|REF_KEY
init|=
literal|"reference.key"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|long
name|BUFFERED_STREAM_THRESHHOLD
init|=
literal|1024
operator|*
literal|1024
decl_stmt|;
specifier|static
specifier|final
name|long
name|MIN_MULTIPART_UPLOAD_PART_SIZE
init|=
literal|1024
operator|*
literal|1024
operator|*
literal|10
decl_stmt|;
comment|// 10MB
specifier|static
specifier|final
name|long
name|MAX_MULTIPART_UPLOAD_PART_SIZE
init|=
literal|1024
operator|*
literal|1024
operator|*
literal|100
decl_stmt|;
comment|// 100MB
specifier|static
specifier|final
name|long
name|MAX_SINGLE_PUT_UPLOAD_SIZE
init|=
literal|1024
operator|*
literal|1024
operator|*
literal|256
decl_stmt|;
comment|// 256MB, Azure limit
specifier|static
specifier|final
name|long
name|MAX_BINARY_UPLOAD_SIZE
init|=
operator|(
name|long
operator|)
name|Math
operator|.
name|floor
argument_list|(
literal|1024L
operator|*
literal|1024L
operator|*
literal|1024L
operator|*
literal|1024L
operator|*
literal|4.75
argument_list|)
decl_stmt|;
comment|// 4.75TB, Azure limit
specifier|private
specifier|static
specifier|final
name|int
name|MAX_ALLOWABLE_UPLOAD_URIS
init|=
literal|50000
decl_stmt|;
comment|// Azure limit
specifier|private
specifier|static
specifier|final
name|int
name|MAX_UNIQUE_RECORD_TRIES
init|=
literal|10
decl_stmt|;
specifier|private
name|Properties
name|properties
decl_stmt|;
specifier|private
name|String
name|containerName
decl_stmt|;
specifier|private
name|String
name|connectionString
decl_stmt|;
specifier|private
name|int
name|concurrentRequestCount
init|=
literal|1
decl_stmt|;
specifier|private
name|RetryPolicy
name|retryPolicy
decl_stmt|;
specifier|private
name|Integer
name|requestTimeout
decl_stmt|;
specifier|private
name|int
name|httpDownloadURIExpirySeconds
init|=
literal|0
decl_stmt|;
comment|// disabled by default
specifier|private
name|int
name|httpUploadURIExpirySeconds
init|=
literal|0
decl_stmt|;
comment|// disabled by default
specifier|private
name|boolean
name|createBlobContainer
init|=
literal|true
decl_stmt|;
specifier|private
name|Cache
argument_list|<
name|DataIdentifier
argument_list|,
name|URI
argument_list|>
name|httpDownloadURICache
decl_stmt|;
specifier|private
name|byte
index|[]
name|secret
decl_stmt|;
specifier|public
name|void
name|setProperties
parameter_list|(
specifier|final
name|Properties
name|properties
parameter_list|)
block|{
name|this
operator|.
name|properties
operator|=
name|properties
expr_stmt|;
block|}
specifier|protected
name|CloudBlobContainer
name|getAzureContainer
parameter_list|()
throws|throws
name|DataStoreException
block|{
name|CloudBlobContainer
name|container
init|=
name|Utils
operator|.
name|getBlobContainer
argument_list|(
name|connectionString
argument_list|,
name|containerName
argument_list|)
decl_stmt|;
name|RequestOptions
name|requestOptions
init|=
name|container
operator|.
name|getServiceClient
argument_list|()
operator|.
name|getDefaultRequestOptions
argument_list|()
decl_stmt|;
if|if
condition|(
name|retryPolicy
operator|!=
literal|null
condition|)
block|{
name|requestOptions
operator|.
name|setRetryPolicyFactory
argument_list|(
name|retryPolicy
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|requestTimeout
operator|!=
literal|null
condition|)
block|{
name|requestOptions
operator|.
name|setTimeoutIntervalInMs
argument_list|(
name|requestTimeout
argument_list|)
expr_stmt|;
block|}
return|return
name|container
return|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|init
parameter_list|()
throws|throws
name|DataStoreException
block|{
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Started backend initialization"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|null
operator|==
name|properties
condition|)
block|{
try|try
block|{
name|properties
operator|=
name|Utils
operator|.
name|readConfig
argument_list|(
name|Utils
operator|.
name|DEFAULT_CONFIG_FILE
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Unable to initialize Azure Data Store from "
operator|+
name|Utils
operator|.
name|DEFAULT_CONFIG_FILE
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
try|try
block|{
name|Utils
operator|.
name|setProxyIfNeeded
argument_list|(
name|properties
argument_list|)
expr_stmt|;
name|containerName
operator|=
operator|(
name|String
operator|)
name|properties
operator|.
name|get
argument_list|(
name|AzureConstants
operator|.
name|AZURE_BLOB_CONTAINER_NAME
argument_list|)
expr_stmt|;
name|createBlobContainer
operator|=
name|PropertiesUtil
operator|.
name|toBoolean
argument_list|(
name|properties
operator|.
name|getProperty
argument_list|(
name|AzureConstants
operator|.
name|AZURE_CREATE_CONTAINER
argument_list|)
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|connectionString
operator|=
name|Utils
operator|.
name|getConnectionStringFromProperties
argument_list|(
name|properties
argument_list|)
expr_stmt|;
name|concurrentRequestCount
operator|=
name|PropertiesUtil
operator|.
name|toInteger
argument_list|(
name|properties
operator|.
name|get
argument_list|(
name|AzureConstants
operator|.
name|AZURE_BLOB_CONCURRENT_REQUESTS_PER_OPERATION
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Using concurrentRequestsPerOperation={}"
argument_list|,
name|concurrentRequestCount
argument_list|)
expr_stmt|;
name|retryPolicy
operator|=
name|Utils
operator|.
name|getRetryPolicy
argument_list|(
operator|(
name|String
operator|)
name|properties
operator|.
name|get
argument_list|(
name|AzureConstants
operator|.
name|AZURE_BLOB_MAX_REQUEST_RETRY
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|properties
operator|.
name|getProperty
argument_list|(
name|AzureConstants
operator|.
name|AZURE_BLOB_REQUEST_TIMEOUT
argument_list|)
operator|!=
literal|null
condition|)
block|{
name|requestTimeout
operator|=
name|PropertiesUtil
operator|.
name|toInteger
argument_list|(
name|properties
operator|.
name|getProperty
argument_list|(
name|AzureConstants
operator|.
name|AZURE_BLOB_REQUEST_TIMEOUT
argument_list|)
argument_list|,
name|RetryPolicy
operator|.
name|DEFAULT_CLIENT_RETRY_COUNT
argument_list|)
expr_stmt|;
block|}
name|CloudBlobContainer
name|azureContainer
init|=
name|getAzureContainer
argument_list|()
decl_stmt|;
if|if
condition|(
name|createBlobContainer
operator|&&
name|azureContainer
operator|.
name|createIfNotExists
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"New container created. containerName={}"
argument_list|,
name|containerName
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Reusing existing container. containerName={}"
argument_list|,
name|containerName
argument_list|)
expr_stmt|;
block|}
name|LOG
operator|.
name|debug
argument_list|(
literal|"Backend initialized. duration={}"
argument_list|,
operator|+
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
comment|// settings pertaining to DataRecordAccessProvider functionality
name|String
name|putExpiry
init|=
name|properties
operator|.
name|getProperty
argument_list|(
name|AzureConstants
operator|.
name|PRESIGNED_HTTP_UPLOAD_URI_EXPIRY_SECONDS
argument_list|)
decl_stmt|;
if|if
condition|(
literal|null
operator|!=
name|putExpiry
condition|)
block|{
name|this
operator|.
name|setHttpUploadURIExpirySeconds
argument_list|(
name|Integer
operator|.
name|parseInt
argument_list|(
name|putExpiry
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|String
name|getExpiry
init|=
name|properties
operator|.
name|getProperty
argument_list|(
name|AzureConstants
operator|.
name|PRESIGNED_HTTP_DOWNLOAD_URI_EXPIRY_SECONDS
argument_list|)
decl_stmt|;
if|if
condition|(
literal|null
operator|!=
name|getExpiry
condition|)
block|{
name|this
operator|.
name|setHttpDownloadURIExpirySeconds
argument_list|(
name|Integer
operator|.
name|parseInt
argument_list|(
name|getExpiry
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|cacheMaxSize
init|=
name|properties
operator|.
name|getProperty
argument_list|(
name|AzureConstants
operator|.
name|PRESIGNED_HTTP_DOWNLOAD_URI_CACHE_MAX_SIZE
argument_list|)
decl_stmt|;
if|if
condition|(
literal|null
operator|!=
name|cacheMaxSize
condition|)
block|{
name|this
operator|.
name|setHttpDownloadURICacheSize
argument_list|(
name|Integer
operator|.
name|parseInt
argument_list|(
name|cacheMaxSize
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|setHttpDownloadURICacheSize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|// default
block|}
block|}
block|}
catch|catch
parameter_list|(
name|StorageException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
finally|finally
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|InputStream
name|read
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|)
throws|throws
name|DataStoreException
block|{
if|if
condition|(
literal|null
operator|==
name|identifier
condition|)
throw|throw
operator|new
name|NullPointerException
argument_list|(
literal|"identifier"
argument_list|)
throw|;
name|String
name|key
init|=
name|getKeyName
argument_list|(
name|identifier
argument_list|)
decl_stmt|;
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|CloudBlockBlob
name|blob
init|=
name|getAzureContainer
argument_list|()
operator|.
name|getBlockBlobReference
argument_list|(
name|key
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|blob
operator|.
name|exists
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Trying to read missing blob. identifier=%s"
argument_list|,
name|key
argument_list|)
argument_list|)
throw|;
block|}
name|InputStream
name|is
init|=
name|blob
operator|.
name|openInputStream
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Got input stream for blob. identifier={} duration={}"
argument_list|,
name|key
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
return|return
name|is
return|;
block|}
catch|catch
parameter_list|(
name|StorageException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Error reading blob. identifier=%s"
argument_list|,
name|key
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Cannot read blob. identifier=%s"
argument_list|,
name|key
argument_list|)
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|URISyntaxException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Error reading blob. identifier=%s"
argument_list|,
name|key
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Cannot read blob. identifier=%s"
argument_list|,
name|key
argument_list|)
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|write
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|,
name|File
name|file
parameter_list|)
throws|throws
name|DataStoreException
block|{
if|if
condition|(
literal|null
operator|==
name|identifier
condition|)
block|{
throw|throw
operator|new
name|NullPointerException
argument_list|(
literal|"identifier"
argument_list|)
throw|;
block|}
if|if
condition|(
literal|null
operator|==
name|file
condition|)
block|{
throw|throw
operator|new
name|NullPointerException
argument_list|(
literal|"file"
argument_list|)
throw|;
block|}
name|String
name|key
init|=
name|getKeyName
argument_list|(
name|identifier
argument_list|)
decl_stmt|;
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|long
name|len
init|=
name|file
operator|.
name|length
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Blob write started. identifier={} length={}"
argument_list|,
name|key
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|CloudBlockBlob
name|blob
init|=
name|getAzureContainer
argument_list|()
operator|.
name|getBlockBlobReference
argument_list|(
name|key
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|blob
operator|.
name|exists
argument_list|()
condition|)
block|{
name|BlobRequestOptions
name|options
init|=
operator|new
name|BlobRequestOptions
argument_list|()
decl_stmt|;
name|options
operator|.
name|setConcurrentRequestCount
argument_list|(
name|concurrentRequestCount
argument_list|)
expr_stmt|;
name|boolean
name|useBufferedStream
init|=
name|len
operator|<
name|BUFFERED_STREAM_THRESHHOLD
decl_stmt|;
specifier|final
name|InputStream
name|in
init|=
name|useBufferedStream
condition|?
operator|new
name|BufferedInputStream
argument_list|(
operator|new
name|FileInputStream
argument_list|(
name|file
argument_list|)
argument_list|)
else|:
operator|new
name|FileInputStream
argument_list|(
name|file
argument_list|)
decl_stmt|;
try|try
block|{
name|blob
operator|.
name|upload
argument_list|(
name|in
argument_list|,
name|len
argument_list|,
literal|null
argument_list|,
name|options
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Blob created. identifier={} length={} duration={} buffered={}"
argument_list|,
name|key
argument_list|,
name|len
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|,
name|useBufferedStream
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|in
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
return|return;
block|}
name|blob
operator|.
name|downloadAttributes
argument_list|()
expr_stmt|;
if|if
condition|(
name|blob
operator|.
name|getProperties
argument_list|()
operator|.
name|getLength
argument_list|()
operator|!=
name|len
condition|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Length Collision. identifier="
operator|+
name|key
operator|+
literal|" new length="
operator|+
name|len
operator|+
literal|" old length="
operator|+
name|blob
operator|.
name|getProperties
argument_list|()
operator|.
name|getLength
argument_list|()
argument_list|)
throw|;
block|}
name|LOG
operator|.
name|trace
argument_list|(
literal|"Blob already exists. identifier={} lastModified={}"
argument_list|,
name|key
argument_list|,
name|blob
operator|.
name|getProperties
argument_list|()
operator|.
name|getLastModified
argument_list|()
operator|.
name|getTime
argument_list|()
argument_list|)
expr_stmt|;
name|blob
operator|.
name|startCopy
argument_list|(
name|blob
argument_list|)
expr_stmt|;
comment|//TODO: better way of updating lastModified (use custom metadata?)
if|if
condition|(
operator|!
name|waitForCopy
argument_list|(
name|blob
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Cannot update lastModified for blob. identifier=%s status=%s"
argument_list|,
name|key
argument_list|,
name|blob
operator|.
name|getCopyState
argument_list|()
operator|.
name|getStatusDescription
argument_list|()
argument_list|)
argument_list|)
throw|;
block|}
name|LOG
operator|.
name|debug
argument_list|(
literal|"Blob updated. identifier={} lastModified={} duration={}"
argument_list|,
name|key
argument_list|,
name|blob
operator|.
name|getProperties
argument_list|()
operator|.
name|getLastModified
argument_list|()
operator|.
name|getTime
argument_list|()
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|StorageException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Error writing blob. identifier={}"
argument_list|,
name|key
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Cannot write blob. identifier=%s"
argument_list|,
name|key
argument_list|)
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|URISyntaxException
decl||
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Error writing blob. identifier={}"
argument_list|,
name|key
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Cannot write blob. identifier=%s"
argument_list|,
name|key
argument_list|)
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Error writing blob. identifier={}"
argument_list|,
name|key
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Cannot copy blob. identifier=%s"
argument_list|,
name|key
argument_list|)
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
literal|null
operator|!=
name|contextClassLoader
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|private
specifier|static
name|boolean
name|waitForCopy
parameter_list|(
name|CloudBlob
name|blob
parameter_list|)
throws|throws
name|StorageException
throws|,
name|InterruptedException
block|{
name|boolean
name|continueLoop
init|=
literal|true
decl_stmt|;
name|CopyStatus
name|status
init|=
name|CopyStatus
operator|.
name|PENDING
decl_stmt|;
while|while
condition|(
name|continueLoop
condition|)
block|{
name|blob
operator|.
name|downloadAttributes
argument_list|()
expr_stmt|;
name|status
operator|=
name|blob
operator|.
name|getCopyState
argument_list|()
operator|.
name|getStatus
argument_list|()
expr_stmt|;
name|continueLoop
operator|=
name|status
operator|==
name|CopyStatus
operator|.
name|PENDING
expr_stmt|;
comment|// Sleep if retry is needed
if|if
condition|(
name|continueLoop
condition|)
block|{
name|Thread
operator|.
name|sleep
argument_list|(
literal|500
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|status
operator|==
name|CopyStatus
operator|.
name|SUCCESS
return|;
block|}
annotation|@
name|Override
specifier|public
name|byte
index|[]
name|getOrCreateReferenceKey
parameter_list|()
throws|throws
name|DataStoreException
block|{
try|try
block|{
if|if
condition|(
name|secret
operator|!=
literal|null
operator|&&
name|secret
operator|.
name|length
operator|!=
literal|0
condition|)
block|{
return|return
name|secret
return|;
block|}
else|else
block|{
name|byte
index|[]
name|key
decl_stmt|;
comment|// Try reading from the metadata folder if it exists
name|key
operator|=
name|readMetadataBytes
argument_list|(
name|REF_KEY
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
literal|null
condition|)
block|{
name|key
operator|=
name|super
operator|.
name|getOrCreateReferenceKey
argument_list|()
expr_stmt|;
name|addMetadataRecord
argument_list|(
operator|new
name|ByteArrayInputStream
argument_list|(
name|key
argument_list|)
argument_list|,
name|REF_KEY
argument_list|)
expr_stmt|;
name|key
operator|=
name|readMetadataBytes
argument_list|(
name|REF_KEY
argument_list|)
expr_stmt|;
block|}
name|secret
operator|=
name|key
expr_stmt|;
return|return
name|secret
return|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
literal|"Unable to get or create key "
operator|+
name|e
argument_list|)
throw|;
block|}
block|}
specifier|private
name|byte
index|[]
name|readMetadataBytes
parameter_list|(
name|String
name|name
parameter_list|)
throws|throws
name|IOException
throws|,
name|DataStoreException
block|{
name|DataRecord
name|rec
init|=
name|getMetadataRecord
argument_list|(
name|name
argument_list|)
decl_stmt|;
name|byte
index|[]
name|key
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|rec
operator|!=
literal|null
condition|)
block|{
name|InputStream
name|stream
init|=
literal|null
decl_stmt|;
try|try
block|{
name|stream
operator|=
name|rec
operator|.
name|getStream
argument_list|()
expr_stmt|;
return|return
name|IOUtils
operator|.
name|toByteArray
argument_list|(
name|stream
argument_list|)
return|;
block|}
finally|finally
block|{
name|IOUtils
operator|.
name|closeQuietly
argument_list|(
name|stream
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|key
return|;
block|}
annotation|@
name|Override
specifier|public
name|DataRecord
name|getRecord
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|)
throws|throws
name|DataStoreException
block|{
if|if
condition|(
literal|null
operator|==
name|identifier
condition|)
block|{
throw|throw
operator|new
name|NullPointerException
argument_list|(
literal|"identifier"
argument_list|)
throw|;
block|}
name|String
name|key
init|=
name|getKeyName
argument_list|(
name|identifier
argument_list|)
decl_stmt|;
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|CloudBlockBlob
name|blob
init|=
name|getAzureContainer
argument_list|()
operator|.
name|getBlockBlobReference
argument_list|(
name|key
argument_list|)
decl_stmt|;
if|if
condition|(
name|blob
operator|.
name|exists
argument_list|()
condition|)
block|{
name|blob
operator|.
name|downloadAttributes
argument_list|()
expr_stmt|;
name|AzureBlobStoreDataRecord
name|record
init|=
operator|new
name|AzureBlobStoreDataRecord
argument_list|(
name|this
argument_list|,
name|connectionString
argument_list|,
name|containerName
argument_list|,
operator|new
name|DataIdentifier
argument_list|(
name|getIdentifierName
argument_list|(
name|blob
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|)
argument_list|,
name|blob
operator|.
name|getProperties
argument_list|()
operator|.
name|getLastModified
argument_list|()
operator|.
name|getTime
argument_list|()
argument_list|,
name|blob
operator|.
name|getProperties
argument_list|()
operator|.
name|getLength
argument_list|()
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Data record read for blob. identifier={} duration={} record={}"
argument_list|,
name|key
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|,
name|record
argument_list|)
expr_stmt|;
return|return
name|record
return|;
block|}
else|else
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Blob not found. identifier={} duration={}"
argument_list|,
name|key
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Cannot find blob. identifier=%s"
argument_list|,
name|key
argument_list|)
argument_list|)
throw|;
block|}
block|}
catch|catch
parameter_list|(
name|StorageException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Error getting data record for blob. identifier={}"
argument_list|,
name|key
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Cannot retrieve blob. identifier=%s"
argument_list|,
name|key
argument_list|)
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|URISyntaxException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Error getting data record for blob. identifier={}"
argument_list|,
name|key
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Cannot retrieve blob. identifier=%s"
argument_list|,
name|key
argument_list|)
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|Iterator
argument_list|<
name|DataIdentifier
argument_list|>
name|getAllIdentifiers
parameter_list|()
throws|throws
name|DataStoreException
block|{
return|return
operator|new
name|RecordsIterator
argument_list|<
name|DataIdentifier
argument_list|>
argument_list|(
operator|new
name|Function
argument_list|<
name|AzureBlobInfo
argument_list|,
name|DataIdentifier
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|DataIdentifier
name|apply
parameter_list|(
name|AzureBlobInfo
name|input
parameter_list|)
block|{
return|return
operator|new
name|DataIdentifier
argument_list|(
name|getIdentifierName
argument_list|(
name|input
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|)
return|;
block|}
block|}
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|Iterator
argument_list|<
name|DataRecord
argument_list|>
name|getAllRecords
parameter_list|()
throws|throws
name|DataStoreException
block|{
specifier|final
name|AbstractSharedBackend
name|backend
init|=
name|this
decl_stmt|;
return|return
operator|new
name|RecordsIterator
argument_list|<
name|DataRecord
argument_list|>
argument_list|(
operator|new
name|Function
argument_list|<
name|AzureBlobInfo
argument_list|,
name|DataRecord
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|DataRecord
name|apply
parameter_list|(
name|AzureBlobInfo
name|input
parameter_list|)
block|{
return|return
operator|new
name|AzureBlobStoreDataRecord
argument_list|(
name|backend
argument_list|,
name|connectionString
argument_list|,
name|containerName
argument_list|,
operator|new
name|DataIdentifier
argument_list|(
name|getIdentifierName
argument_list|(
name|input
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|)
argument_list|,
name|input
operator|.
name|getLastModified
argument_list|()
argument_list|,
name|input
operator|.
name|getLength
argument_list|()
argument_list|)
return|;
block|}
block|}
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|boolean
name|exists
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|)
throws|throws
name|DataStoreException
block|{
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|String
name|key
init|=
name|getKeyName
argument_list|(
name|identifier
argument_list|)
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|boolean
name|exists
init|=
name|getAzureContainer
argument_list|()
operator|.
name|getBlockBlobReference
argument_list|(
name|key
argument_list|)
operator|.
name|exists
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Blob exists={} identifier={} duration={}"
argument_list|,
name|exists
argument_list|,
name|key
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
return|return
name|exists
return|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
literal|null
operator|!=
name|contextClassLoader
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|close
parameter_list|()
throws|throws
name|DataStoreException
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"AzureBlobBackend closed."
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|deleteRecord
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|)
throws|throws
name|DataStoreException
block|{
if|if
condition|(
literal|null
operator|==
name|identifier
condition|)
throw|throw
operator|new
name|NullPointerException
argument_list|(
literal|"identifier"
argument_list|)
throw|;
name|String
name|key
init|=
name|getKeyName
argument_list|(
name|identifier
argument_list|)
decl_stmt|;
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|boolean
name|result
init|=
name|getAzureContainer
argument_list|()
operator|.
name|getBlockBlobReference
argument_list|(
name|key
argument_list|)
operator|.
name|deleteIfExists
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Blob {}. identifier={} duration={}"
argument_list|,
name|result
condition|?
literal|"deleted"
else|:
literal|"delete requested, but it does not exist (perhaps already deleted)"
argument_list|,
name|key
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|StorageException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Error deleting blob. identifier={}"
argument_list|,
name|key
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|URISyntaxException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|addMetadataRecord
parameter_list|(
name|InputStream
name|input
parameter_list|,
name|String
name|name
parameter_list|)
throws|throws
name|DataStoreException
block|{
if|if
condition|(
literal|null
operator|==
name|input
condition|)
block|{
throw|throw
operator|new
name|NullPointerException
argument_list|(
literal|"input"
argument_list|)
throw|;
block|}
if|if
condition|(
name|Strings
operator|.
name|isNullOrEmpty
argument_list|(
name|name
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"name"
argument_list|)
throw|;
block|}
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|addMetadataRecordImpl
argument_list|(
name|input
argument_list|,
name|name
argument_list|,
operator|-
literal|1L
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Metadata record added. metadataName={} duration={}"
argument_list|,
name|name
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
literal|null
operator|!=
name|contextClassLoader
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|addMetadataRecord
parameter_list|(
name|File
name|input
parameter_list|,
name|String
name|name
parameter_list|)
throws|throws
name|DataStoreException
block|{
if|if
condition|(
literal|null
operator|==
name|input
condition|)
block|{
throw|throw
operator|new
name|NullPointerException
argument_list|(
literal|"input"
argument_list|)
throw|;
block|}
if|if
condition|(
name|Strings
operator|.
name|isNullOrEmpty
argument_list|(
name|name
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"name"
argument_list|)
throw|;
block|}
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|addMetadataRecordImpl
argument_list|(
operator|new
name|FileInputStream
argument_list|(
name|input
argument_list|)
argument_list|,
name|name
argument_list|,
name|input
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Metadata record added. metadataName={} duration={}"
argument_list|,
name|name
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|FileNotFoundException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
literal|null
operator|!=
name|contextClassLoader
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|private
name|void
name|addMetadataRecordImpl
parameter_list|(
specifier|final
name|InputStream
name|input
parameter_list|,
name|String
name|name
parameter_list|,
name|long
name|recordLength
parameter_list|)
throws|throws
name|DataStoreException
block|{
try|try
block|{
name|CloudBlobDirectory
name|metaDir
init|=
name|getAzureContainer
argument_list|()
operator|.
name|getDirectoryReference
argument_list|(
name|META_DIR_NAME
argument_list|)
decl_stmt|;
name|CloudBlockBlob
name|blob
init|=
name|metaDir
operator|.
name|getBlockBlobReference
argument_list|(
name|name
argument_list|)
decl_stmt|;
name|blob
operator|.
name|upload
argument_list|(
name|input
argument_list|,
name|recordLength
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|StorageException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Error adding metadata record. metadataName={} length={}"
argument_list|,
name|name
argument_list|,
name|recordLength
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|URISyntaxException
decl||
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|DataRecord
name|getMetadataRecord
parameter_list|(
name|String
name|name
parameter_list|)
block|{
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|CloudBlobDirectory
name|metaDir
init|=
name|getAzureContainer
argument_list|()
operator|.
name|getDirectoryReference
argument_list|(
name|META_DIR_NAME
argument_list|)
decl_stmt|;
name|CloudBlockBlob
name|blob
init|=
name|metaDir
operator|.
name|getBlockBlobReference
argument_list|(
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|blob
operator|.
name|exists
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Trying to read missing metadata. metadataName={}"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
name|blob
operator|.
name|downloadAttributes
argument_list|()
expr_stmt|;
name|long
name|lastModified
init|=
name|blob
operator|.
name|getProperties
argument_list|()
operator|.
name|getLastModified
argument_list|()
operator|.
name|getTime
argument_list|()
decl_stmt|;
name|long
name|length
init|=
name|blob
operator|.
name|getProperties
argument_list|()
operator|.
name|getLength
argument_list|()
decl_stmt|;
name|AzureBlobStoreDataRecord
name|record
init|=
operator|new
name|AzureBlobStoreDataRecord
argument_list|(
name|this
argument_list|,
name|connectionString
argument_list|,
name|containerName
argument_list|,
operator|new
name|DataIdentifier
argument_list|(
name|name
argument_list|)
argument_list|,
name|lastModified
argument_list|,
name|length
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Metadata record read. metadataName={} duration={} record={}"
argument_list|,
name|name
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|,
name|record
argument_list|)
expr_stmt|;
return|return
name|record
return|;
block|}
catch|catch
parameter_list|(
name|StorageException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Error reading metadata record. metadataName={}"
argument_list|,
name|name
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Error reading metadata record. metadataName={}"
argument_list|,
name|name
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
literal|null
operator|!=
name|contextClassLoader
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|List
argument_list|<
name|DataRecord
argument_list|>
name|getAllMetadataRecords
parameter_list|(
name|String
name|prefix
parameter_list|)
block|{
if|if
condition|(
literal|null
operator|==
name|prefix
condition|)
block|{
throw|throw
operator|new
name|NullPointerException
argument_list|(
literal|"prefix"
argument_list|)
throw|;
block|}
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
specifier|final
name|List
argument_list|<
name|DataRecord
argument_list|>
name|records
init|=
name|Lists
operator|.
name|newArrayList
argument_list|()
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|CloudBlobDirectory
name|metaDir
init|=
name|getAzureContainer
argument_list|()
operator|.
name|getDirectoryReference
argument_list|(
name|META_DIR_NAME
argument_list|)
decl_stmt|;
for|for
control|(
name|ListBlobItem
name|item
range|:
name|metaDir
operator|.
name|listBlobs
argument_list|(
name|prefix
argument_list|)
control|)
block|{
if|if
condition|(
name|item
operator|instanceof
name|CloudBlob
condition|)
block|{
name|CloudBlob
name|blob
init|=
operator|(
name|CloudBlob
operator|)
name|item
decl_stmt|;
name|records
operator|.
name|add
argument_list|(
operator|new
name|AzureBlobStoreDataRecord
argument_list|(
name|this
argument_list|,
name|connectionString
argument_list|,
name|containerName
argument_list|,
operator|new
name|DataIdentifier
argument_list|(
name|stripMetaKeyPrefix
argument_list|(
name|blob
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|)
argument_list|,
name|blob
operator|.
name|getProperties
argument_list|()
operator|.
name|getLastModified
argument_list|()
operator|.
name|getTime
argument_list|()
argument_list|,
name|blob
operator|.
name|getProperties
argument_list|()
operator|.
name|getLength
argument_list|()
argument_list|,
literal|true
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|LOG
operator|.
name|debug
argument_list|(
literal|"Metadata records read. recordsRead={} metadataFolder={} duration={}"
argument_list|,
name|records
operator|.
name|size
argument_list|()
argument_list|,
name|prefix
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|StorageException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Error reading all metadata records. metadataFolder={}"
argument_list|,
name|prefix
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
decl||
name|URISyntaxException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Error reading all metadata records. metadataFolder={}"
argument_list|,
name|prefix
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
literal|null
operator|!=
name|contextClassLoader
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|records
return|;
block|}
annotation|@
name|Override
specifier|public
name|boolean
name|deleteMetadataRecord
parameter_list|(
name|String
name|name
parameter_list|)
block|{
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|CloudBlockBlob
name|blob
init|=
name|getAzureContainer
argument_list|()
operator|.
name|getBlockBlobReference
argument_list|(
name|addMetaKeyPrefix
argument_list|(
name|name
argument_list|)
argument_list|)
decl_stmt|;
name|boolean
name|result
init|=
name|blob
operator|.
name|deleteIfExists
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Metadata record {}. metadataName={} duration={}"
argument_list|,
name|result
condition|?
literal|"deleted"
else|:
literal|"delete requested, but it does not exist (perhaps already deleted)"
argument_list|,
name|name
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
catch|catch
parameter_list|(
name|StorageException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Error deleting metadata record. metadataName={}"
argument_list|,
name|name
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
decl||
name|URISyntaxException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Error deleting metadata record. metadataName={}"
argument_list|,
name|name
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|false
return|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|deleteAllMetadataRecords
parameter_list|(
name|String
name|prefix
parameter_list|)
block|{
if|if
condition|(
literal|null
operator|==
name|prefix
condition|)
block|{
throw|throw
operator|new
name|NullPointerException
argument_list|(
literal|"prefix"
argument_list|)
throw|;
block|}
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|CloudBlobDirectory
name|metaDir
init|=
name|getAzureContainer
argument_list|()
operator|.
name|getDirectoryReference
argument_list|(
name|META_DIR_NAME
argument_list|)
decl_stmt|;
name|int
name|total
init|=
literal|0
decl_stmt|;
for|for
control|(
name|ListBlobItem
name|item
range|:
name|metaDir
operator|.
name|listBlobs
argument_list|(
name|prefix
argument_list|)
control|)
block|{
if|if
condition|(
name|item
operator|instanceof
name|CloudBlob
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|CloudBlob
operator|)
name|item
operator|)
operator|.
name|deleteIfExists
argument_list|()
condition|)
block|{
name|total
operator|++
expr_stmt|;
block|}
block|}
block|}
name|LOG
operator|.
name|debug
argument_list|(
literal|"Metadata records deleted. recordsDeleted={} metadataFolder={} duration={}"
argument_list|,
name|total
argument_list|,
name|prefix
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|StorageException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Error deleting all metadata records. metadataFolder={}"
argument_list|,
name|prefix
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
decl||
name|URISyntaxException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Error deleting all metadata records. metadataFolder={}"
argument_list|,
name|prefix
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
literal|null
operator|!=
name|contextClassLoader
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|boolean
name|metadataRecordExists
parameter_list|(
name|String
name|name
parameter_list|)
block|{
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|CloudBlockBlob
name|blob
init|=
name|getAzureContainer
argument_list|()
operator|.
name|getBlockBlobReference
argument_list|(
name|addMetaKeyPrefix
argument_list|(
name|name
argument_list|)
argument_list|)
decl_stmt|;
name|boolean
name|exists
init|=
name|blob
operator|.
name|exists
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Metadata record {} exists {}. duration={}"
argument_list|,
name|name
argument_list|,
name|exists
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
return|return
name|exists
return|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
decl||
name|StorageException
decl||
name|URISyntaxException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Error checking existence of metadata record = {}"
argument_list|,
name|name
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|false
return|;
block|}
comment|/**      * Get key from data identifier. Object is stored with key in ADS.      */
specifier|private
specifier|static
name|String
name|getKeyName
parameter_list|(
name|DataIdentifier
name|identifier
parameter_list|)
block|{
name|String
name|key
init|=
name|identifier
operator|.
name|toString
argument_list|()
decl_stmt|;
return|return
name|key
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
literal|4
argument_list|)
operator|+
name|Utils
operator|.
name|DASH
operator|+
name|key
operator|.
name|substring
argument_list|(
literal|4
argument_list|)
return|;
block|}
comment|/**      * Get data identifier from key.      */
specifier|private
specifier|static
name|String
name|getIdentifierName
parameter_list|(
name|String
name|key
parameter_list|)
block|{
if|if
condition|(
operator|!
name|key
operator|.
name|contains
argument_list|(
name|Utils
operator|.
name|DASH
argument_list|)
condition|)
block|{
return|return
literal|null
return|;
block|}
elseif|else
if|if
condition|(
name|key
operator|.
name|contains
argument_list|(
name|META_KEY_PREFIX
argument_list|)
condition|)
block|{
return|return
name|key
return|;
block|}
return|return
name|key
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
literal|4
argument_list|)
operator|+
name|key
operator|.
name|substring
argument_list|(
literal|5
argument_list|)
return|;
block|}
specifier|private
specifier|static
name|String
name|addMetaKeyPrefix
parameter_list|(
specifier|final
name|String
name|key
parameter_list|)
block|{
return|return
name|META_KEY_PREFIX
operator|+
name|key
return|;
block|}
specifier|private
specifier|static
name|String
name|stripMetaKeyPrefix
parameter_list|(
name|String
name|name
parameter_list|)
block|{
if|if
condition|(
name|name
operator|.
name|startsWith
argument_list|(
name|META_KEY_PREFIX
argument_list|)
condition|)
block|{
return|return
name|name
operator|.
name|substring
argument_list|(
name|META_KEY_PREFIX
operator|.
name|length
argument_list|()
argument_list|)
return|;
block|}
return|return
name|name
return|;
block|}
name|void
name|setHttpDownloadURIExpirySeconds
parameter_list|(
name|int
name|seconds
parameter_list|)
block|{
name|httpDownloadURIExpirySeconds
operator|=
name|seconds
expr_stmt|;
block|}
name|void
name|setHttpDownloadURICacheSize
parameter_list|(
name|int
name|maxSize
parameter_list|)
block|{
comment|// max size 0 or smaller is used to turn off the cache
if|if
condition|(
name|maxSize
operator|>
literal|0
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"presigned GET URI cache enabled, maxSize = {} items, expiry = {} seconds"
argument_list|,
name|maxSize
argument_list|,
name|httpDownloadURIExpirySeconds
operator|/
literal|2
argument_list|)
expr_stmt|;
name|httpDownloadURICache
operator|=
name|CacheBuilder
operator|.
name|newBuilder
argument_list|()
operator|.
name|maximumSize
argument_list|(
name|maxSize
argument_list|)
operator|.
name|expireAfterWrite
argument_list|(
name|httpDownloadURIExpirySeconds
operator|/
literal|2
argument_list|,
name|TimeUnit
operator|.
name|SECONDS
argument_list|)
operator|.
name|build
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"presigned GET URI cache disabled"
argument_list|)
expr_stmt|;
name|httpDownloadURICache
operator|=
literal|null
expr_stmt|;
block|}
block|}
name|URI
name|createHttpDownloadURI
parameter_list|(
annotation|@
name|NotNull
name|DataIdentifier
name|identifier
parameter_list|,
annotation|@
name|NotNull
name|DataRecordDownloadOptions
name|downloadOptions
parameter_list|)
block|{
name|URI
name|uri
init|=
literal|null
decl_stmt|;
comment|// When running unit test from Maven, it doesn't always honor the @NotNull decorators
if|if
condition|(
literal|null
operator|==
name|identifier
condition|)
throw|throw
operator|new
name|NullPointerException
argument_list|(
literal|"identifier"
argument_list|)
throw|;
if|if
condition|(
literal|null
operator|==
name|downloadOptions
condition|)
throw|throw
operator|new
name|NullPointerException
argument_list|(
literal|"downloadOptions"
argument_list|)
throw|;
if|if
condition|(
name|httpDownloadURIExpirySeconds
operator|>
literal|0
condition|)
block|{
comment|// Check if this identifier exists.  If not, we want to return null
comment|// even if the identifier is in the download URI cache.
try|try
block|{
if|if
condition|(
operator|!
name|exists
argument_list|(
name|identifier
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Cannot create download URI for nonexistent blob {}; returning null"
argument_list|,
name|getKeyName
argument_list|(
name|identifier
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
block|}
catch|catch
parameter_list|(
name|DataStoreException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Cannot create download URI for blob {} (caught DataStoreException); returning null"
argument_list|,
name|getKeyName
argument_list|(
name|identifier
argument_list|)
argument_list|,
name|e
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
if|if
condition|(
literal|null
operator|!=
name|httpDownloadURICache
condition|)
block|{
name|uri
operator|=
name|httpDownloadURICache
operator|.
name|getIfPresent
argument_list|(
name|identifier
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
literal|null
operator|==
name|uri
condition|)
block|{
name|String
name|key
init|=
name|getKeyName
argument_list|(
name|identifier
argument_list|)
decl_stmt|;
name|SharedAccessBlobHeaders
name|headers
init|=
operator|new
name|SharedAccessBlobHeaders
argument_list|()
decl_stmt|;
name|headers
operator|.
name|setCacheControl
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"private, max-age=%d, immutable"
argument_list|,
name|httpDownloadURIExpirySeconds
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|contentType
init|=
name|downloadOptions
operator|.
name|getContentTypeHeader
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|Strings
operator|.
name|isNullOrEmpty
argument_list|(
name|contentType
argument_list|)
condition|)
block|{
name|headers
operator|.
name|setContentType
argument_list|(
name|contentType
argument_list|)
expr_stmt|;
block|}
name|String
name|contentDisposition
init|=
name|downloadOptions
operator|.
name|getContentDispositionHeader
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|Strings
operator|.
name|isNullOrEmpty
argument_list|(
name|contentDisposition
argument_list|)
condition|)
block|{
name|headers
operator|.
name|setContentDisposition
argument_list|(
name|contentDisposition
argument_list|)
expr_stmt|;
block|}
name|uri
operator|=
name|createPresignedURI
argument_list|(
name|key
argument_list|,
name|EnumSet
operator|.
name|of
argument_list|(
name|SharedAccessBlobPermissions
operator|.
name|READ
argument_list|)
argument_list|,
name|httpDownloadURIExpirySeconds
argument_list|,
name|headers
argument_list|)
expr_stmt|;
if|if
condition|(
name|uri
operator|!=
literal|null
operator|&&
name|httpDownloadURICache
operator|!=
literal|null
condition|)
block|{
name|httpDownloadURICache
operator|.
name|put
argument_list|(
name|identifier
argument_list|,
name|uri
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|uri
return|;
block|}
name|void
name|setHttpUploadURIExpirySeconds
parameter_list|(
name|int
name|seconds
parameter_list|)
block|{
name|httpUploadURIExpirySeconds
operator|=
name|seconds
expr_stmt|;
block|}
specifier|private
name|DataIdentifier
name|generateSafeRandomIdentifier
parameter_list|()
block|{
return|return
operator|new
name|DataIdentifier
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"%s-%d"
argument_list|,
name|UUID
operator|.
name|randomUUID
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|,
name|Instant
operator|.
name|now
argument_list|()
operator|.
name|toEpochMilli
argument_list|()
argument_list|)
argument_list|)
return|;
block|}
name|DataRecordUpload
name|initiateHttpUpload
parameter_list|(
name|long
name|maxUploadSizeInBytes
parameter_list|,
name|int
name|maxNumberOfURIs
parameter_list|)
block|{
name|List
argument_list|<
name|URI
argument_list|>
name|uploadPartURIs
init|=
name|Lists
operator|.
name|newArrayList
argument_list|()
decl_stmt|;
name|long
name|minPartSize
init|=
name|MIN_MULTIPART_UPLOAD_PART_SIZE
decl_stmt|;
name|long
name|maxPartSize
init|=
name|MAX_MULTIPART_UPLOAD_PART_SIZE
decl_stmt|;
if|if
condition|(
literal|0L
operator|>=
name|maxUploadSizeInBytes
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"maxUploadSizeInBytes must be> 0"
argument_list|)
throw|;
block|}
elseif|else
if|if
condition|(
literal|0
operator|==
name|maxNumberOfURIs
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"maxNumberOfURIs must either be> 0 or -1"
argument_list|)
throw|;
block|}
elseif|else
if|if
condition|(
operator|-
literal|1
operator|>
name|maxNumberOfURIs
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"maxNumberOfURIs must either be> 0 or -1"
argument_list|)
throw|;
block|}
elseif|else
if|if
condition|(
name|maxUploadSizeInBytes
operator|>
name|MAX_SINGLE_PUT_UPLOAD_SIZE
operator|&&
name|maxNumberOfURIs
operator|==
literal|1
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Cannot do single-put upload with file size %d - exceeds max single-put upload size of %d"
argument_list|,
name|maxUploadSizeInBytes
argument_list|,
name|MAX_SINGLE_PUT_UPLOAD_SIZE
argument_list|)
argument_list|)
throw|;
block|}
elseif|else
if|if
condition|(
name|maxUploadSizeInBytes
operator|>
name|MAX_BINARY_UPLOAD_SIZE
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Cannot do upload with file size %d - exceeds max upload size of %d"
argument_list|,
name|maxUploadSizeInBytes
argument_list|,
name|MAX_BINARY_UPLOAD_SIZE
argument_list|)
argument_list|)
throw|;
block|}
name|DataIdentifier
name|newIdentifier
init|=
name|generateSafeRandomIdentifier
argument_list|()
decl_stmt|;
name|String
name|blobId
init|=
name|getKeyName
argument_list|(
name|newIdentifier
argument_list|)
decl_stmt|;
name|String
name|uploadId
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|httpUploadURIExpirySeconds
operator|>
literal|0
condition|)
block|{
comment|// Always do multi-part uploads for Azure, even for small binaries.
comment|//
comment|// This is because Azure requires a unique header, "x-ms-blob-type=BlockBlob", to be
comment|// set but only for single-put uploads, not multi-part.
comment|// This would require clients to know not only the type of service provider being used
comment|// but also the type of upload (single-put vs multi-part), which breaks abstraction.
comment|// Instead we can insist that clients always do multi-part uploads to Azure, even
comment|// if the multi-part upload consists of only one upload part.  This doesn't require
comment|// additional work on the part of the client since the "complete" request must always
comment|// be sent regardless, but it helps us avoid the client having to know what type
comment|// of provider is being used, or us having to instruct the client to use specific
comment|// types of headers, etc.
comment|// Azure doesn't use upload IDs like AWS does
comment|// Generate a fake one for compatibility - we use them to determine whether we are
comment|// doing multi-part or single-put upload
name|uploadId
operator|=
name|Base64
operator|.
name|encode
argument_list|(
name|UUID
operator|.
name|randomUUID
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|long
name|numParts
init|=
literal|0L
decl_stmt|;
if|if
condition|(
name|maxNumberOfURIs
operator|>
literal|0
condition|)
block|{
name|long
name|requestedPartSize
init|=
operator|(
name|long
operator|)
name|Math
operator|.
name|ceil
argument_list|(
operator|(
operator|(
name|double
operator|)
name|maxUploadSizeInBytes
operator|)
operator|/
operator|(
operator|(
name|double
operator|)
name|maxNumberOfURIs
operator|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|requestedPartSize
operator|<=
name|maxPartSize
condition|)
block|{
name|numParts
operator|=
name|Math
operator|.
name|min
argument_list|(
name|maxNumberOfURIs
argument_list|,
name|Math
operator|.
name|min
argument_list|(
operator|(
name|long
operator|)
name|Math
operator|.
name|ceil
argument_list|(
operator|(
operator|(
name|double
operator|)
name|maxUploadSizeInBytes
operator|)
operator|/
operator|(
operator|(
name|double
operator|)
name|minPartSize
operator|)
argument_list|)
argument_list|,
name|MAX_ALLOWABLE_UPLOAD_URIS
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Cannot do multi-part upload with requested part size %d"
argument_list|,
name|requestedPartSize
argument_list|)
argument_list|)
throw|;
block|}
block|}
else|else
block|{
name|long
name|maximalNumParts
init|=
operator|(
name|long
operator|)
name|Math
operator|.
name|ceil
argument_list|(
operator|(
operator|(
name|double
operator|)
name|maxUploadSizeInBytes
operator|)
operator|/
operator|(
operator|(
name|double
operator|)
name|MIN_MULTIPART_UPLOAD_PART_SIZE
operator|)
argument_list|)
decl_stmt|;
name|numParts
operator|=
name|Math
operator|.
name|min
argument_list|(
name|maximalNumParts
argument_list|,
name|MAX_ALLOWABLE_UPLOAD_URIS
argument_list|)
expr_stmt|;
block|}
name|String
name|key
init|=
name|getKeyName
argument_list|(
name|newIdentifier
argument_list|)
decl_stmt|;
name|EnumSet
argument_list|<
name|SharedAccessBlobPermissions
argument_list|>
name|perms
init|=
name|EnumSet
operator|.
name|of
argument_list|(
name|SharedAccessBlobPermissions
operator|.
name|WRITE
argument_list|)
decl_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|presignedURIRequestParams
init|=
name|Maps
operator|.
name|newHashMap
argument_list|()
decl_stmt|;
name|presignedURIRequestParams
operator|.
name|put
argument_list|(
literal|"comp"
argument_list|,
literal|"block"
argument_list|)
expr_stmt|;
for|for
control|(
name|long
name|blockId
init|=
literal|1
init|;
name|blockId
operator|<=
name|numParts
condition|;
operator|++
name|blockId
control|)
block|{
name|presignedURIRequestParams
operator|.
name|put
argument_list|(
literal|"blockId"
argument_list|,
name|Base64
operator|.
name|encode
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"%06d"
argument_list|,
name|blockId
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|uploadPartURIs
operator|.
name|add
argument_list|(
name|createPresignedURI
argument_list|(
name|key
argument_list|,
name|perms
argument_list|,
name|httpUploadURIExpirySeconds
argument_list|,
name|presignedURIRequestParams
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
try|try
block|{
name|byte
index|[]
name|secret
init|=
name|getOrCreateReferenceKey
argument_list|()
decl_stmt|;
name|String
name|uploadToken
init|=
operator|new
name|DataRecordUploadToken
argument_list|(
name|blobId
argument_list|,
name|uploadId
argument_list|)
operator|.
name|getEncodedToken
argument_list|(
name|secret
argument_list|)
decl_stmt|;
return|return
operator|new
name|DataRecordUpload
argument_list|()
block|{
annotation|@
name|Override
annotation|@
name|NotNull
specifier|public
name|String
name|getUploadToken
parameter_list|()
block|{
return|return
name|uploadToken
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getMinPartSize
parameter_list|()
block|{
return|return
name|minPartSize
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getMaxPartSize
parameter_list|()
block|{
return|return
name|maxPartSize
return|;
block|}
annotation|@
name|Override
annotation|@
name|NotNull
specifier|public
name|Collection
argument_list|<
name|URI
argument_list|>
name|getUploadURIs
parameter_list|()
block|{
return|return
name|uploadPartURIs
return|;
block|}
block|}
return|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Unable to obtain data store key"
argument_list|)
expr_stmt|;
block|}
return|return
literal|null
return|;
block|}
name|DataRecord
name|completeHttpUpload
parameter_list|(
annotation|@
name|NotNull
name|String
name|uploadTokenStr
parameter_list|)
throws|throws
name|DataRecordUploadException
throws|,
name|DataStoreException
block|{
if|if
condition|(
name|Strings
operator|.
name|isNullOrEmpty
argument_list|(
name|uploadTokenStr
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"uploadToken required"
argument_list|)
throw|;
block|}
name|DataRecordUploadToken
name|uploadToken
init|=
name|DataRecordUploadToken
operator|.
name|fromEncodedToken
argument_list|(
name|uploadTokenStr
argument_list|,
name|getOrCreateReferenceKey
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|key
init|=
name|uploadToken
operator|.
name|getBlobId
argument_list|()
decl_stmt|;
name|DataIdentifier
name|blobId
init|=
operator|new
name|DataIdentifier
argument_list|(
name|getIdentifierName
argument_list|(
name|key
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|exists
argument_list|(
name|blobId
argument_list|)
condition|)
block|{
try|try
block|{
if|if
condition|(
name|uploadToken
operator|.
name|getUploadId
argument_list|()
operator|.
name|isPresent
argument_list|()
condition|)
block|{
comment|// An existing upload ID means this is a multi-part upload
name|CloudBlockBlob
name|blob
init|=
name|getAzureContainer
argument_list|()
operator|.
name|getBlockBlobReference
argument_list|(
name|key
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|BlockEntry
argument_list|>
name|blocks
init|=
name|blob
operator|.
name|downloadBlockList
argument_list|(
name|BlockListingFilter
operator|.
name|UNCOMMITTED
argument_list|,
name|AccessCondition
operator|.
name|generateEmptyCondition
argument_list|()
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|blob
operator|.
name|commitBlockList
argument_list|(
name|blocks
argument_list|)
expr_stmt|;
block|}
comment|// else do nothing - single put is already complete
if|if
condition|(
operator|!
name|exists
argument_list|(
name|blobId
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|DataRecordUploadException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Unable to finalize direct write of binary %s"
argument_list|,
name|blobId
argument_list|)
argument_list|)
throw|;
block|}
block|}
catch|catch
parameter_list|(
name|URISyntaxException
decl||
name|StorageException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|DataRecordUploadException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Unable to finalize direct write of binary %s"
argument_list|,
name|blobId
argument_list|)
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
comment|// else return the already existing record for this blob ID
return|return
name|getRecord
argument_list|(
name|blobId
argument_list|)
return|;
block|}
specifier|private
name|URI
name|createPresignedURI
parameter_list|(
name|String
name|key
parameter_list|,
name|EnumSet
argument_list|<
name|SharedAccessBlobPermissions
argument_list|>
name|permissions
parameter_list|,
name|int
name|expirySeconds
parameter_list|,
name|SharedAccessBlobHeaders
name|optionalHeaders
parameter_list|)
block|{
return|return
name|createPresignedURI
argument_list|(
name|key
argument_list|,
name|permissions
argument_list|,
name|expirySeconds
argument_list|,
name|Maps
operator|.
name|newHashMap
argument_list|()
argument_list|,
name|optionalHeaders
argument_list|)
return|;
block|}
specifier|private
name|URI
name|createPresignedURI
parameter_list|(
name|String
name|key
parameter_list|,
name|EnumSet
argument_list|<
name|SharedAccessBlobPermissions
argument_list|>
name|permissions
parameter_list|,
name|int
name|expirySeconds
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|additionalQueryParams
parameter_list|)
block|{
return|return
name|createPresignedURI
argument_list|(
name|key
argument_list|,
name|permissions
argument_list|,
name|expirySeconds
argument_list|,
name|additionalQueryParams
argument_list|,
literal|null
argument_list|)
return|;
block|}
specifier|private
name|URI
name|createPresignedURI
parameter_list|(
name|String
name|key
parameter_list|,
name|EnumSet
argument_list|<
name|SharedAccessBlobPermissions
argument_list|>
name|permissions
parameter_list|,
name|int
name|expirySeconds
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|additionalQueryParams
parameter_list|,
name|SharedAccessBlobHeaders
name|optionalHeaders
parameter_list|)
block|{
name|SharedAccessBlobPolicy
name|policy
init|=
operator|new
name|SharedAccessBlobPolicy
argument_list|()
decl_stmt|;
name|Date
name|expiry
init|=
name|Date
operator|.
name|from
argument_list|(
name|Instant
operator|.
name|now
argument_list|()
operator|.
name|plusSeconds
argument_list|(
name|expirySeconds
argument_list|)
argument_list|)
decl_stmt|;
name|policy
operator|.
name|setSharedAccessExpiryTime
argument_list|(
name|expiry
argument_list|)
expr_stmt|;
name|policy
operator|.
name|setPermissions
argument_list|(
name|permissions
argument_list|)
expr_stmt|;
name|String
name|accountName
init|=
name|properties
operator|.
name|getProperty
argument_list|(
name|AzureConstants
operator|.
name|AZURE_STORAGE_ACCOUNT_NAME
argument_list|,
literal|""
argument_list|)
decl_stmt|;
if|if
condition|(
name|Strings
operator|.
name|isNullOrEmpty
argument_list|(
name|accountName
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Can't generate presigned URI - Azure account name not found in properties"
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
name|URI
name|presignedURI
init|=
literal|null
decl_stmt|;
try|try
block|{
name|CloudBlockBlob
name|blob
init|=
name|getAzureContainer
argument_list|()
operator|.
name|getBlockBlobReference
argument_list|(
name|key
argument_list|)
decl_stmt|;
name|String
name|sharedAccessSignature
init|=
literal|null
operator|==
name|optionalHeaders
condition|?
name|blob
operator|.
name|generateSharedAccessSignature
argument_list|(
name|policy
argument_list|,
literal|null
argument_list|)
else|:
name|blob
operator|.
name|generateSharedAccessSignature
argument_list|(
name|policy
argument_list|,
name|optionalHeaders
argument_list|,
literal|null
argument_list|)
decl_stmt|;
comment|// Shared access signature is returned encoded already.
name|String
name|uriString
init|=
name|String
operator|.
name|format
argument_list|(
literal|"https://%s.blob.core.windows.net/%s/%s?%s"
argument_list|,
name|accountName
argument_list|,
name|containerName
argument_list|,
name|key
argument_list|,
name|sharedAccessSignature
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|additionalQueryParams
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|e
range|:
name|additionalQueryParams
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|builder
operator|.
name|append
argument_list|(
literal|"&"
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|URLEncoder
operator|.
name|encode
argument_list|(
name|e
operator|.
name|getKey
argument_list|()
argument_list|,
name|Charsets
operator|.
name|UTF_8
operator|.
name|name
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"="
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|URLEncoder
operator|.
name|encode
argument_list|(
name|e
operator|.
name|getValue
argument_list|()
argument_list|,
name|Charsets
operator|.
name|UTF_8
operator|.
name|name
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|uriString
operator|+=
name|builder
operator|.
name|toString
argument_list|()
expr_stmt|;
block|}
name|presignedURI
operator|=
operator|new
name|URI
argument_list|(
name|uriString
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"No connection to Azure Blob Storage"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|URISyntaxException
decl||
name|InvalidKeyException
decl||
name|UnsupportedEncodingException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Can't generate a presigned URI for key {}"
argument_list|,
name|key
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|StorageException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Azure request to create presigned Azure Blob Storage {} URI failed. "
operator|+
literal|"Key: {}, Error: {}, HTTP Code: {}, Azure Error Code: {}"
argument_list|,
name|permissions
operator|.
name|contains
argument_list|(
name|SharedAccessBlobPermissions
operator|.
name|READ
argument_list|)
condition|?
literal|"GET"
else|:
operator|(
name|permissions
operator|.
name|contains
argument_list|(
name|SharedAccessBlobPermissions
operator|.
name|WRITE
argument_list|)
condition|?
literal|"PUT"
else|:
literal|""
operator|)
argument_list|,
name|key
argument_list|,
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
operator|.
name|getHttpStatusCode
argument_list|()
argument_list|,
name|e
operator|.
name|getErrorCode
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|presignedURI
return|;
block|}
specifier|private
specifier|static
class|class
name|AzureBlobInfo
block|{
specifier|private
specifier|final
name|String
name|name
decl_stmt|;
specifier|private
specifier|final
name|long
name|lastModified
decl_stmt|;
specifier|private
specifier|final
name|long
name|length
decl_stmt|;
specifier|public
name|AzureBlobInfo
parameter_list|(
name|String
name|name
parameter_list|,
name|long
name|lastModified
parameter_list|,
name|long
name|length
parameter_list|)
block|{
name|this
operator|.
name|name
operator|=
name|name
expr_stmt|;
name|this
operator|.
name|lastModified
operator|=
name|lastModified
expr_stmt|;
name|this
operator|.
name|length
operator|=
name|length
expr_stmt|;
block|}
specifier|public
name|String
name|getName
parameter_list|()
block|{
return|return
name|name
return|;
block|}
specifier|public
name|long
name|getLastModified
parameter_list|()
block|{
return|return
name|lastModified
return|;
block|}
specifier|public
name|long
name|getLength
parameter_list|()
block|{
return|return
name|length
return|;
block|}
specifier|public
specifier|static
name|AzureBlobInfo
name|fromCloudBlob
parameter_list|(
name|CloudBlob
name|cloudBlob
parameter_list|)
block|{
return|return
operator|new
name|AzureBlobInfo
argument_list|(
name|cloudBlob
operator|.
name|getName
argument_list|()
argument_list|,
name|cloudBlob
operator|.
name|getProperties
argument_list|()
operator|.
name|getLastModified
argument_list|()
operator|.
name|getTime
argument_list|()
argument_list|,
name|cloudBlob
operator|.
name|getProperties
argument_list|()
operator|.
name|getLength
argument_list|()
argument_list|)
return|;
block|}
block|}
specifier|private
class|class
name|RecordsIterator
parameter_list|<
name|T
parameter_list|>
extends|extends
name|AbstractIterator
argument_list|<
name|T
argument_list|>
block|{
comment|// Seems to be thread-safe (in 5.0.0)
name|ResultContinuation
name|resultContinuation
decl_stmt|;
name|boolean
name|firstCall
init|=
literal|true
decl_stmt|;
specifier|final
name|Function
argument_list|<
name|AzureBlobInfo
argument_list|,
name|T
argument_list|>
name|transformer
decl_stmt|;
specifier|final
name|Queue
argument_list|<
name|AzureBlobInfo
argument_list|>
name|items
init|=
name|Lists
operator|.
name|newLinkedList
argument_list|()
decl_stmt|;
specifier|public
name|RecordsIterator
parameter_list|(
name|Function
argument_list|<
name|AzureBlobInfo
argument_list|,
name|T
argument_list|>
name|transformer
parameter_list|)
block|{
name|this
operator|.
name|transformer
operator|=
name|transformer
expr_stmt|;
block|}
annotation|@
name|Override
specifier|protected
name|T
name|computeNext
parameter_list|()
block|{
if|if
condition|(
name|items
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|loadItems
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|items
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
return|return
name|transformer
operator|.
name|apply
argument_list|(
name|items
operator|.
name|remove
argument_list|()
argument_list|)
return|;
block|}
return|return
name|endOfData
argument_list|()
return|;
block|}
specifier|private
name|boolean
name|loadItems
parameter_list|()
block|{
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|ClassLoader
name|contextClassLoader
init|=
name|currentThread
argument_list|()
operator|.
name|getContextClassLoader
argument_list|()
decl_stmt|;
try|try
block|{
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
name|CloudBlobContainer
name|container
init|=
name|Utils
operator|.
name|getBlobContainer
argument_list|(
name|connectionString
argument_list|,
name|containerName
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|firstCall
operator|&&
operator|(
name|resultContinuation
operator|==
literal|null
operator|||
operator|!
name|resultContinuation
operator|.
name|hasContinuation
argument_list|()
operator|)
condition|)
block|{
name|LOG
operator|.
name|trace
argument_list|(
literal|"No more records in container. containerName={}"
argument_list|,
name|container
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
name|firstCall
operator|=
literal|false
expr_stmt|;
name|ResultSegment
argument_list|<
name|ListBlobItem
argument_list|>
name|results
init|=
name|container
operator|.
name|listBlobsSegmented
argument_list|(
literal|null
argument_list|,
literal|false
argument_list|,
name|EnumSet
operator|.
name|noneOf
argument_list|(
name|BlobListingDetails
operator|.
name|class
argument_list|)
argument_list|,
literal|null
argument_list|,
name|resultContinuation
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|resultContinuation
operator|=
name|results
operator|.
name|getContinuationToken
argument_list|()
expr_stmt|;
for|for
control|(
name|ListBlobItem
name|item
range|:
name|results
operator|.
name|getResults
argument_list|()
control|)
block|{
if|if
condition|(
name|item
operator|instanceof
name|CloudBlob
condition|)
block|{
name|items
operator|.
name|add
argument_list|(
name|AzureBlobInfo
operator|.
name|fromCloudBlob
argument_list|(
operator|(
name|CloudBlob
operator|)
name|item
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|LOG
operator|.
name|debug
argument_list|(
literal|"Container records batch read. batchSize={} containerName={} duration={}"
argument_list|,
name|results
operator|.
name|getLength
argument_list|()
argument_list|,
name|containerName
argument_list|,
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
argument_list|)
expr_stmt|;
return|return
name|results
operator|.
name|getLength
argument_list|()
operator|>
literal|0
return|;
block|}
catch|catch
parameter_list|(
name|StorageException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Error listing blobs. containerName={}"
argument_list|,
name|containerName
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|DataStoreException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Cannot list blobs. containerName={}"
argument_list|,
name|containerName
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|contextClassLoader
operator|!=
literal|null
condition|)
block|{
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|contextClassLoader
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|false
return|;
block|}
block|}
specifier|static
class|class
name|AzureBlobStoreDataRecord
extends|extends
name|AbstractDataRecord
block|{
specifier|final
name|String
name|connectionString
decl_stmt|;
specifier|final
name|String
name|containerName
decl_stmt|;
specifier|final
name|long
name|lastModified
decl_stmt|;
specifier|final
name|long
name|length
decl_stmt|;
specifier|final
name|boolean
name|isMeta
decl_stmt|;
specifier|public
name|AzureBlobStoreDataRecord
parameter_list|(
name|AbstractSharedBackend
name|backend
parameter_list|,
name|String
name|connectionString
parameter_list|,
name|String
name|containerName
parameter_list|,
name|DataIdentifier
name|key
parameter_list|,
name|long
name|lastModified
parameter_list|,
name|long
name|length
parameter_list|)
block|{
name|this
argument_list|(
name|backend
argument_list|,
name|connectionString
argument_list|,
name|containerName
argument_list|,
name|key
argument_list|,
name|lastModified
argument_list|,
name|length
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
specifier|public
name|AzureBlobStoreDataRecord
parameter_list|(
name|AbstractSharedBackend
name|backend
parameter_list|,
name|String
name|connectionString
parameter_list|,
name|String
name|containerName
parameter_list|,
name|DataIdentifier
name|key
parameter_list|,
name|long
name|lastModified
parameter_list|,
name|long
name|length
parameter_list|,
name|boolean
name|isMeta
parameter_list|)
block|{
name|super
argument_list|(
name|backend
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|this
operator|.
name|connectionString
operator|=
name|connectionString
expr_stmt|;
name|this
operator|.
name|containerName
operator|=
name|containerName
expr_stmt|;
name|this
operator|.
name|lastModified
operator|=
name|lastModified
expr_stmt|;
name|this
operator|.
name|length
operator|=
name|length
expr_stmt|;
name|this
operator|.
name|isMeta
operator|=
name|isMeta
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getLength
parameter_list|()
throws|throws
name|DataStoreException
block|{
return|return
name|length
return|;
block|}
annotation|@
name|Override
specifier|public
name|InputStream
name|getStream
parameter_list|()
throws|throws
name|DataStoreException
block|{
name|String
name|id
init|=
name|getKeyName
argument_list|(
name|getIdentifier
argument_list|()
argument_list|)
decl_stmt|;
name|CloudBlobContainer
name|container
init|=
name|Utils
operator|.
name|getBlobContainer
argument_list|(
name|connectionString
argument_list|,
name|containerName
argument_list|)
decl_stmt|;
if|if
condition|(
name|isMeta
condition|)
block|{
name|id
operator|=
name|addMetaKeyPrefix
argument_list|(
name|getIdentifier
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
comment|// Log message, with exception so we can get a trace to see where the call
comment|// came from
name|LOG
operator|.
name|debug
argument_list|(
literal|"binary downloaded from Azure Blob Storage: "
operator|+
name|getIdentifier
argument_list|()
argument_list|,
operator|new
name|Exception
argument_list|()
argument_list|)
expr_stmt|;
block|}
try|try
block|{
return|return
name|container
operator|.
name|getBlockBlobReference
argument_list|(
name|id
argument_list|)
operator|.
name|openInputStream
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|StorageException
decl||
name|URISyntaxException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|DataStoreException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|long
name|getLastModified
parameter_list|()
block|{
return|return
name|lastModified
return|;
block|}
annotation|@
name|Override
specifier|public
name|String
name|toString
parameter_list|()
block|{
return|return
literal|"AzureBlobStoreDataRecord{"
operator|+
literal|"identifier="
operator|+
name|getIdentifier
argument_list|()
operator|+
literal|", length="
operator|+
name|length
operator|+
literal|", lastModified="
operator|+
name|lastModified
operator|+
literal|", containerName='"
operator|+
name|containerName
operator|+
literal|'\''
operator|+
literal|'}'
return|;
block|}
block|}
block|}
end_class

end_unit

