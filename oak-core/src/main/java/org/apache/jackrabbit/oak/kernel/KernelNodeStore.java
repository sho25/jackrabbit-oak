begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|kernel
package|;
end_package

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|mk
operator|.
name|api
operator|.
name|MicroKernel
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|mk
operator|.
name|api
operator|.
name|MicroKernelException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|api
operator|.
name|CommitFailedException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|api
operator|.
name|CoreValueFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|api
operator|.
name|PropertyState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|commons
operator|.
name|PathUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|spi
operator|.
name|state
operator|.
name|AbstractChildNodeEntry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|spi
operator|.
name|state
operator|.
name|AbstractNodeState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|spi
operator|.
name|state
operator|.
name|AbstractNodeStore
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|spi
operator|.
name|state
operator|.
name|ChildNodeEntry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|spi
operator|.
name|state
operator|.
name|NodeState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|spi
operator|.
name|state
operator|.
name|NodeStateBuilder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|util
operator|.
name|Function1
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|util
operator|.
name|Iterators
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|jackrabbit
operator|.
name|oak
operator|.
name|util
operator|.
name|Predicate
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_class
specifier|public
class|class
name|KernelNodeStore
extends|extends
name|AbstractNodeStore
block|{
comment|/**      * The {@link org.apache.jackrabbit.mk.api.MicroKernel} instance used to store the content tree.      */
specifier|private
specifier|final
name|MicroKernel
name|kernel
decl_stmt|;
comment|/**      * Value factory backed by the {@link #kernel} instance.      */
specifier|private
specifier|final
name|CoreValueFactory
name|valueFactory
decl_stmt|;
comment|/**      * State of the current root node.      */
specifier|private
name|KernelNodeState
name|root
decl_stmt|;
specifier|public
name|KernelNodeStore
parameter_list|(
name|MicroKernel
name|kernel
parameter_list|)
block|{
name|this
operator|.
name|kernel
operator|=
name|kernel
expr_stmt|;
name|this
operator|.
name|valueFactory
operator|=
operator|new
name|CoreValueFactoryImpl
argument_list|(
name|kernel
argument_list|)
expr_stmt|;
name|this
operator|.
name|root
operator|=
operator|new
name|KernelNodeState
argument_list|(
name|kernel
argument_list|,
name|valueFactory
argument_list|,
literal|"/"
argument_list|,
name|kernel
operator|.
name|getHeadRevision
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
specifier|synchronized
name|NodeState
name|getRoot
parameter_list|()
block|{
name|String
name|revision
init|=
name|kernel
operator|.
name|getHeadRevision
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|revision
operator|.
name|equals
argument_list|(
name|root
operator|.
name|getRevision
argument_list|()
argument_list|)
condition|)
block|{
name|root
operator|=
operator|new
name|KernelNodeState
argument_list|(
name|kernel
argument_list|,
name|valueFactory
argument_list|,
literal|"/"
argument_list|,
name|kernel
operator|.
name|getHeadRevision
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|root
return|;
block|}
annotation|@
name|Override
specifier|public
name|NodeStateBuilder
name|getBuilder
parameter_list|(
name|NodeState
name|base
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|base
operator|instanceof
name|KernelNodeState
operator|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Alien node state"
argument_list|)
throw|;
block|}
name|KernelNodeState
name|kernelNodeState
init|=
operator|(
name|KernelNodeState
operator|)
name|base
decl_stmt|;
name|String
name|branchRevision
init|=
name|kernel
operator|.
name|branch
argument_list|(
name|kernelNodeState
operator|.
name|getRevision
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|path
init|=
name|kernelNodeState
operator|.
name|getPath
argument_list|()
decl_stmt|;
name|KernelNodeState
name|branchRoot
init|=
operator|new
name|KernelNodeState
argument_list|(
name|kernel
argument_list|,
name|valueFactory
argument_list|,
name|path
argument_list|,
name|branchRevision
argument_list|)
decl_stmt|;
return|return
name|KernelNodeStateBuilder
operator|.
name|create
argument_list|(
operator|new
name|NodeStateBuilderContext
argument_list|(
name|branchRoot
argument_list|)
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|apply
parameter_list|(
name|NodeStateBuilder
name|builder
parameter_list|)
throws|throws
name|CommitFailedException
block|{
if|if
condition|(
operator|!
operator|(
name|builder
operator|instanceof
name|KernelNodeStateBuilder
operator|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Alien builder"
argument_list|)
throw|;
block|}
name|KernelNodeStateBuilder
name|kernelNodeStateBuilder
init|=
operator|(
name|KernelNodeStateBuilder
operator|)
name|builder
decl_stmt|;
name|kernelNodeStateBuilder
operator|.
name|getContext
argument_list|()
operator|.
name|applyPendingChanges
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|CoreValueFactory
name|getValueFactory
parameter_list|()
block|{
return|return
name|valueFactory
return|;
block|}
comment|//------------------------------------------------------------< internal>---
class|class
name|NodeStateBuilderContext
block|{
specifier|private
specifier|static
specifier|final
name|int
name|PURGE_LIMIT
init|=
literal|1024
decl_stmt|;
comment|// TODO make configurable?
specifier|private
specifier|final
name|String
name|path
decl_stmt|;
specifier|private
name|NodeState
name|root
decl_stmt|;
specifier|private
name|String
name|revision
decl_stmt|;
specifier|private
name|StringBuilder
name|jsop
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|NodeStateBuilderContext
parameter_list|(
name|KernelNodeState
name|root
parameter_list|)
block|{
name|this
operator|.
name|path
operator|=
name|root
operator|.
name|getPath
argument_list|()
expr_stmt|;
name|this
operator|.
name|root
operator|=
name|root
expr_stmt|;
name|this
operator|.
name|revision
operator|=
name|root
operator|.
name|getRevision
argument_list|()
expr_stmt|;
block|}
name|String
name|getPath
parameter_list|()
block|{
return|return
name|path
return|;
block|}
name|NodeState
name|getNodeState
parameter_list|(
name|String
name|path
parameter_list|)
block|{
name|NodeState
name|state
init|=
name|root
decl_stmt|;
for|for
control|(
name|String
name|name
range|:
name|PathUtils
operator|.
name|elements
argument_list|(
name|path
argument_list|)
control|)
block|{
name|state
operator|=
name|state
operator|.
name|getChildNode
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
return|return
name|state
return|;
block|}
name|void
name|addNode
parameter_list|(
name|String
name|relPath
parameter_list|)
block|{
name|jsop
operator|.
name|append
argument_list|(
literal|"+\""
argument_list|)
operator|.
name|append
argument_list|(
name|relPath
argument_list|)
operator|.
name|append
argument_list|(
literal|"\":{}"
argument_list|)
expr_stmt|;
name|root
operator|=
name|addNode
argument_list|(
name|root
argument_list|,
name|EMPTY_STATE
argument_list|,
name|PathUtils
operator|.
name|elements
argument_list|(
name|relPath
argument_list|)
operator|.
name|iterator
argument_list|()
argument_list|)
expr_stmt|;
name|purgeOnLimit
argument_list|()
expr_stmt|;
block|}
name|void
name|addNode
parameter_list|(
name|NodeState
name|node
parameter_list|,
name|String
name|relPath
parameter_list|)
block|{
name|buildJsop
argument_list|(
name|relPath
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|root
operator|=
name|addNode
argument_list|(
name|root
argument_list|,
name|node
argument_list|,
name|PathUtils
operator|.
name|elements
argument_list|(
name|relPath
argument_list|)
operator|.
name|iterator
argument_list|()
argument_list|)
expr_stmt|;
name|purgeOnLimit
argument_list|()
expr_stmt|;
block|}
name|void
name|removeNode
parameter_list|(
name|String
name|relPath
parameter_list|)
block|{
name|jsop
operator|.
name|append
argument_list|(
literal|"-\""
argument_list|)
operator|.
name|append
argument_list|(
name|relPath
argument_list|)
operator|.
name|append
argument_list|(
literal|'"'
argument_list|)
expr_stmt|;
name|root
operator|=
name|removeNode
argument_list|(
name|root
argument_list|,
name|PathUtils
operator|.
name|elements
argument_list|(
name|relPath
argument_list|)
operator|.
name|iterator
argument_list|()
argument_list|)
expr_stmt|;
name|purgeOnLimit
argument_list|()
expr_stmt|;
block|}
name|void
name|addProperty
parameter_list|(
name|PropertyState
name|property
parameter_list|,
name|String
name|parentPath
parameter_list|)
block|{
name|String
name|path
init|=
name|PathUtils
operator|.
name|concat
argument_list|(
name|parentPath
argument_list|,
name|property
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|value
init|=
name|property
operator|.
name|isArray
argument_list|()
condition|?
name|CoreValueMapper
operator|.
name|toJsonArray
argument_list|(
name|property
operator|.
name|getValues
argument_list|()
argument_list|)
else|:
name|CoreValueMapper
operator|.
name|toJsonValue
argument_list|(
name|property
operator|.
name|getValue
argument_list|()
argument_list|)
decl_stmt|;
name|jsop
operator|.
name|append
argument_list|(
literal|"^\""
argument_list|)
operator|.
name|append
argument_list|(
name|path
argument_list|)
operator|.
name|append
argument_list|(
literal|"\":"
argument_list|)
operator|.
name|append
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|root
operator|=
name|addProperty
argument_list|(
name|root
argument_list|,
name|property
argument_list|,
name|PathUtils
operator|.
name|elements
argument_list|(
name|parentPath
argument_list|)
operator|.
name|iterator
argument_list|()
argument_list|)
expr_stmt|;
name|purgeOnLimit
argument_list|()
expr_stmt|;
block|}
name|void
name|setProperty
parameter_list|(
name|PropertyState
name|property
parameter_list|,
name|String
name|parentPath
parameter_list|)
block|{
name|String
name|path
init|=
name|PathUtils
operator|.
name|concat
argument_list|(
name|parentPath
argument_list|,
name|property
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|value
init|=
name|property
operator|.
name|isArray
argument_list|()
condition|?
name|CoreValueMapper
operator|.
name|toJsonArray
argument_list|(
name|property
operator|.
name|getValues
argument_list|()
argument_list|)
else|:
name|CoreValueMapper
operator|.
name|toJsonValue
argument_list|(
name|property
operator|.
name|getValue
argument_list|()
argument_list|)
decl_stmt|;
name|jsop
operator|.
name|append
argument_list|(
literal|"^\""
argument_list|)
operator|.
name|append
argument_list|(
name|path
argument_list|)
operator|.
name|append
argument_list|(
literal|"\":"
argument_list|)
operator|.
name|append
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|root
operator|=
name|setProperty
argument_list|(
name|root
argument_list|,
name|property
argument_list|,
name|PathUtils
operator|.
name|elements
argument_list|(
name|parentPath
argument_list|)
operator|.
name|iterator
argument_list|()
argument_list|)
expr_stmt|;
name|purgeOnLimit
argument_list|()
expr_stmt|;
block|}
name|void
name|removeProperty
parameter_list|(
name|String
name|relPath
parameter_list|)
block|{
name|jsop
operator|.
name|append
argument_list|(
literal|"^\""
argument_list|)
operator|.
name|append
argument_list|(
name|relPath
argument_list|)
operator|.
name|append
argument_list|(
literal|"\":null"
argument_list|)
expr_stmt|;
name|root
operator|=
name|removeProperty
argument_list|(
name|root
argument_list|,
name|PathUtils
operator|.
name|elements
argument_list|(
name|relPath
argument_list|)
operator|.
name|iterator
argument_list|()
argument_list|)
expr_stmt|;
name|purgeOnLimit
argument_list|()
expr_stmt|;
block|}
name|void
name|moveNode
parameter_list|(
name|String
name|sourcePath
parameter_list|,
name|String
name|destPath
parameter_list|)
block|{
name|jsop
operator|.
name|append
argument_list|(
literal|">\""
argument_list|)
operator|.
name|append
argument_list|(
name|sourcePath
argument_list|)
operator|.
name|append
argument_list|(
literal|"\":\""
argument_list|)
operator|.
name|append
argument_list|(
name|destPath
argument_list|)
operator|.
name|append
argument_list|(
literal|'"'
argument_list|)
expr_stmt|;
name|NodeState
name|moveNode
init|=
name|getChildNode
argument_list|(
name|root
argument_list|,
name|sourcePath
argument_list|)
decl_stmt|;
name|root
operator|=
name|removeNode
argument_list|(
name|root
argument_list|,
name|PathUtils
operator|.
name|elements
argument_list|(
name|sourcePath
argument_list|)
operator|.
name|iterator
argument_list|()
argument_list|)
expr_stmt|;
name|root
operator|=
name|addNode
argument_list|(
name|root
argument_list|,
name|moveNode
argument_list|,
name|PathUtils
operator|.
name|elements
argument_list|(
name|destPath
argument_list|)
operator|.
name|iterator
argument_list|()
argument_list|)
expr_stmt|;
name|purgeOnLimit
argument_list|()
expr_stmt|;
block|}
name|void
name|copyNode
parameter_list|(
name|String
name|sourcePath
parameter_list|,
name|String
name|destPath
parameter_list|)
block|{
name|jsop
operator|.
name|append
argument_list|(
literal|"*\""
argument_list|)
operator|.
name|append
argument_list|(
name|sourcePath
argument_list|)
operator|.
name|append
argument_list|(
literal|"\":\""
argument_list|)
operator|.
name|append
argument_list|(
name|destPath
argument_list|)
operator|.
name|append
argument_list|(
literal|'"'
argument_list|)
expr_stmt|;
name|NodeState
name|copyNode
init|=
name|getChildNode
argument_list|(
name|root
argument_list|,
name|sourcePath
argument_list|)
decl_stmt|;
name|root
operator|=
name|addNode
argument_list|(
name|root
argument_list|,
name|copyNode
argument_list|,
name|PathUtils
operator|.
name|elements
argument_list|(
name|destPath
argument_list|)
operator|.
name|iterator
argument_list|()
argument_list|)
expr_stmt|;
name|purgeOnLimit
argument_list|()
expr_stmt|;
block|}
name|void
name|applyPendingChanges
parameter_list|()
throws|throws
name|CommitFailedException
block|{
try|try
block|{
name|purgePendingChanges
argument_list|()
expr_stmt|;
name|kernel
operator|.
name|merge
argument_list|(
name|revision
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|revision
operator|=
literal|null
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|MicroKernelException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|CommitFailedException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
comment|//------------------------------------------------------------< private>---
specifier|private
name|void
name|purgeOnLimit
parameter_list|()
block|{
if|if
condition|(
name|jsop
operator|.
name|length
argument_list|()
operator|>
name|PURGE_LIMIT
condition|)
block|{
name|purgePendingChanges
argument_list|()
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|purgePendingChanges
parameter_list|()
block|{
if|if
condition|(
name|revision
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"Branch has been merged already"
argument_list|)
throw|;
block|}
if|if
condition|(
name|jsop
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
name|revision
operator|=
name|kernel
operator|.
name|commit
argument_list|(
name|path
argument_list|,
name|jsop
operator|.
name|toString
argument_list|()
argument_list|,
name|revision
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|root
operator|=
operator|new
name|KernelNodeState
argument_list|(
name|kernel
argument_list|,
name|valueFactory
argument_list|,
name|path
argument_list|,
name|revision
argument_list|)
expr_stmt|;
name|jsop
operator|=
operator|new
name|StringBuilder
argument_list|()
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|buildJsop
parameter_list|(
name|String
name|path
parameter_list|,
name|NodeState
name|nodeState
parameter_list|)
block|{
name|jsop
operator|.
name|append
argument_list|(
literal|"+\""
argument_list|)
operator|.
name|append
argument_list|(
name|path
argument_list|)
operator|.
name|append
argument_list|(
literal|"\":{}"
argument_list|)
expr_stmt|;
for|for
control|(
name|PropertyState
name|property
range|:
name|nodeState
operator|.
name|getProperties
argument_list|()
control|)
block|{
name|String
name|targetPath
init|=
name|PathUtils
operator|.
name|concat
argument_list|(
name|path
argument_list|,
name|property
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|value
init|=
name|property
operator|.
name|isArray
argument_list|()
condition|?
name|CoreValueMapper
operator|.
name|toJsonArray
argument_list|(
name|property
operator|.
name|getValues
argument_list|()
argument_list|)
else|:
name|CoreValueMapper
operator|.
name|toJsonValue
argument_list|(
name|property
operator|.
name|getValue
argument_list|()
argument_list|)
decl_stmt|;
name|jsop
operator|.
name|append
argument_list|(
literal|"^\""
argument_list|)
operator|.
name|append
argument_list|(
name|targetPath
argument_list|)
operator|.
name|append
argument_list|(
literal|"\":"
argument_list|)
operator|.
name|append
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|ChildNodeEntry
name|child
range|:
name|nodeState
operator|.
name|getChildNodeEntries
argument_list|(
literal|0
argument_list|,
operator|-
literal|1
argument_list|)
control|)
block|{
name|String
name|targetPath
init|=
name|PathUtils
operator|.
name|concat
argument_list|(
name|path
argument_list|,
name|child
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
name|buildJsop
argument_list|(
name|targetPath
argument_list|,
name|child
operator|.
name|getNodeState
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|NodeState
name|addNode
parameter_list|(
name|NodeState
name|parent
parameter_list|,
name|NodeState
name|node
parameter_list|,
name|Iterator
argument_list|<
name|String
argument_list|>
name|path
parameter_list|)
block|{
name|String
name|name
init|=
name|path
operator|.
name|next
argument_list|()
decl_stmt|;
if|if
condition|(
name|path
operator|.
name|hasNext
argument_list|()
condition|)
block|{
return|return
name|setChildNode
argument_list|(
name|parent
argument_list|,
name|name
argument_list|,
name|addNode
argument_list|(
name|parent
operator|.
name|getChildNode
argument_list|(
name|name
argument_list|)
argument_list|,
name|node
argument_list|,
name|path
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|addChildNode
argument_list|(
name|parent
argument_list|,
name|name
argument_list|,
name|node
argument_list|)
return|;
block|}
block|}
specifier|private
name|NodeState
name|removeNode
parameter_list|(
name|NodeState
name|parent
parameter_list|,
name|Iterator
argument_list|<
name|String
argument_list|>
name|path
parameter_list|)
block|{
name|String
name|name
init|=
name|path
operator|.
name|next
argument_list|()
decl_stmt|;
if|if
condition|(
name|path
operator|.
name|hasNext
argument_list|()
condition|)
block|{
return|return
name|setChildNode
argument_list|(
name|parent
argument_list|,
name|name
argument_list|,
name|removeNode
argument_list|(
name|parent
operator|.
name|getChildNode
argument_list|(
name|name
argument_list|)
argument_list|,
name|path
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|removeChildNode
argument_list|(
name|parent
argument_list|,
name|name
argument_list|)
return|;
block|}
block|}
specifier|private
name|NodeState
name|addProperty
parameter_list|(
name|NodeState
name|parent
parameter_list|,
name|PropertyState
name|added
parameter_list|,
name|Iterator
argument_list|<
name|String
argument_list|>
name|parentPath
parameter_list|)
block|{
if|if
condition|(
name|parentPath
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|String
name|name
init|=
name|parentPath
operator|.
name|next
argument_list|()
decl_stmt|;
return|return
name|setChildNode
argument_list|(
name|parent
argument_list|,
name|name
argument_list|,
name|addProperty
argument_list|(
name|parent
operator|.
name|getChildNode
argument_list|(
name|name
argument_list|)
argument_list|,
name|added
argument_list|,
name|parentPath
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|addChildProperty
argument_list|(
name|parent
argument_list|,
name|added
argument_list|)
return|;
block|}
block|}
specifier|private
name|NodeState
name|setProperty
parameter_list|(
name|NodeState
name|parent
parameter_list|,
name|PropertyState
name|property
parameter_list|,
name|Iterator
argument_list|<
name|String
argument_list|>
name|parentPath
parameter_list|)
block|{
if|if
condition|(
name|parentPath
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|String
name|name
init|=
name|parentPath
operator|.
name|next
argument_list|()
decl_stmt|;
return|return
name|setChildNode
argument_list|(
name|parent
argument_list|,
name|name
argument_list|,
name|setProperty
argument_list|(
name|parent
operator|.
name|getChildNode
argument_list|(
name|name
argument_list|)
argument_list|,
name|property
argument_list|,
name|parentPath
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|setChildProperty
argument_list|(
name|parent
argument_list|,
name|property
argument_list|)
return|;
block|}
block|}
specifier|private
name|NodeState
name|removeProperty
parameter_list|(
name|NodeState
name|parent
parameter_list|,
name|Iterator
argument_list|<
name|String
argument_list|>
name|path
parameter_list|)
block|{
name|String
name|name
init|=
name|path
operator|.
name|next
argument_list|()
decl_stmt|;
if|if
condition|(
name|path
operator|.
name|hasNext
argument_list|()
condition|)
block|{
return|return
name|setChildNode
argument_list|(
name|parent
argument_list|,
name|name
argument_list|,
name|removeProperty
argument_list|(
name|parent
operator|.
name|getChildNode
argument_list|(
name|name
argument_list|)
argument_list|,
name|path
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|removeChildProperty
argument_list|(
name|parent
argument_list|,
name|name
argument_list|)
return|;
block|}
block|}
specifier|private
name|NodeState
name|getChildNode
parameter_list|(
name|NodeState
name|state
parameter_list|,
name|String
name|relPath
parameter_list|)
block|{
for|for
control|(
name|String
name|name
range|:
name|PathUtils
operator|.
name|elements
argument_list|(
name|relPath
argument_list|)
control|)
block|{
name|state
operator|=
name|state
operator|.
name|getChildNode
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
return|return
name|state
return|;
block|}
specifier|private
specifier|final
name|NodeState
name|EMPTY_STATE
init|=
operator|new
name|AbstractNodeState
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|PropertyState
name|getProperty
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
literal|null
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getPropertyCount
parameter_list|()
block|{
return|return
literal|0
return|;
block|}
annotation|@
name|Override
specifier|public
name|Iterable
argument_list|<
name|?
extends|extends
name|PropertyState
argument_list|>
name|getProperties
parameter_list|()
block|{
return|return
operator|new
name|Iterable
argument_list|<
name|PropertyState
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Iterator
argument_list|<
name|PropertyState
argument_list|>
name|iterator
parameter_list|()
block|{
return|return
name|Iterators
operator|.
name|empty
argument_list|()
return|;
block|}
block|}
return|;
block|}
annotation|@
name|Override
specifier|public
name|NodeState
name|getChildNode
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
literal|null
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getChildNodeCount
parameter_list|()
block|{
return|return
literal|0
return|;
block|}
annotation|@
name|Override
specifier|public
name|Iterable
argument_list|<
name|?
extends|extends
name|ChildNodeEntry
argument_list|>
name|getChildNodeEntries
parameter_list|(
name|long
name|offset
parameter_list|,
name|int
name|count
parameter_list|)
block|{
return|return
operator|new
name|Iterable
argument_list|<
name|ChildNodeEntry
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Iterator
argument_list|<
name|ChildNodeEntry
argument_list|>
name|iterator
parameter_list|()
block|{
return|return
name|Iterators
operator|.
name|empty
argument_list|()
return|;
block|}
block|}
return|;
block|}
block|}
decl_stmt|;
specifier|private
name|ChildNodeEntry
name|createCNE
parameter_list|(
specifier|final
name|String
name|name
parameter_list|,
specifier|final
name|NodeState
name|state
parameter_list|)
block|{
return|return
operator|new
name|AbstractChildNodeEntry
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|String
name|getName
parameter_list|()
block|{
return|return
name|name
return|;
block|}
annotation|@
name|Override
specifier|public
name|NodeState
name|getNodeState
parameter_list|()
block|{
return|return
name|state
return|;
block|}
block|}
return|;
block|}
specifier|private
name|NodeState
name|addChildNode
parameter_list|(
specifier|final
name|NodeState
name|parent
parameter_list|,
specifier|final
name|String
name|childName
parameter_list|,
specifier|final
name|NodeState
name|node
parameter_list|)
block|{
return|return
operator|new
name|AbstractNodeState
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|PropertyState
name|getProperty
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|parent
operator|.
name|getProperty
argument_list|(
name|name
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getPropertyCount
parameter_list|()
block|{
return|return
name|parent
operator|.
name|getPropertyCount
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|Iterable
argument_list|<
name|?
extends|extends
name|PropertyState
argument_list|>
name|getProperties
parameter_list|()
block|{
return|return
name|parent
operator|.
name|getProperties
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|NodeState
name|getChildNode
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|childName
operator|.
name|equals
argument_list|(
name|name
argument_list|)
condition|?
name|node
else|:
name|parent
operator|.
name|getChildNode
argument_list|(
name|name
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getChildNodeCount
parameter_list|()
block|{
return|return
literal|1
operator|+
name|parent
operator|.
name|getChildNodeCount
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|Iterable
argument_list|<
name|?
extends|extends
name|ChildNodeEntry
argument_list|>
name|getChildNodeEntries
parameter_list|(
specifier|final
name|long
name|offset
parameter_list|,
specifier|final
name|int
name|count
parameter_list|)
block|{
if|if
condition|(
name|offset
operator|>=
name|getChildNodeCount
argument_list|()
condition|)
block|{
return|return
operator|new
name|Iterable
argument_list|<
name|ChildNodeEntry
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Iterator
argument_list|<
name|ChildNodeEntry
argument_list|>
name|iterator
parameter_list|()
block|{
return|return
name|Iterators
operator|.
name|empty
argument_list|()
return|;
block|}
block|}
return|;
block|}
elseif|else
if|if
condition|(
name|count
operator|==
operator|-
literal|1
operator|||
name|offset
operator|+
name|count
operator|>
name|getChildNodeCount
argument_list|()
condition|)
block|{
return|return
operator|new
name|Iterable
argument_list|<
name|ChildNodeEntry
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Iterator
argument_list|<
name|ChildNodeEntry
argument_list|>
name|iterator
parameter_list|()
block|{
return|return
name|Iterators
operator|.
name|chain
argument_list|(
name|parent
operator|.
name|getChildNodeEntries
argument_list|(
name|offset
argument_list|,
name|count
argument_list|)
operator|.
name|iterator
argument_list|()
argument_list|,
name|Iterators
operator|.
name|singleton
argument_list|(
name|createCNE
argument_list|(
name|childName
argument_list|,
name|node
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
block|}
return|;
block|}
else|else
block|{
return|return
name|parent
operator|.
name|getChildNodeEntries
argument_list|(
name|offset
argument_list|,
name|count
argument_list|)
return|;
block|}
block|}
block|}
return|;
block|}
specifier|private
name|NodeState
name|setChildNode
parameter_list|(
specifier|final
name|NodeState
name|parent
parameter_list|,
specifier|final
name|String
name|childName
parameter_list|,
specifier|final
name|NodeState
name|node
parameter_list|)
block|{
return|return
operator|new
name|AbstractNodeState
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|PropertyState
name|getProperty
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|parent
operator|.
name|getProperty
argument_list|(
name|name
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getPropertyCount
parameter_list|()
block|{
return|return
name|parent
operator|.
name|getPropertyCount
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|Iterable
argument_list|<
name|?
extends|extends
name|PropertyState
argument_list|>
name|getProperties
parameter_list|()
block|{
return|return
name|parent
operator|.
name|getProperties
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|NodeState
name|getChildNode
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|childName
operator|.
name|equals
argument_list|(
name|name
argument_list|)
condition|?
name|node
else|:
name|parent
operator|.
name|getChildNode
argument_list|(
name|name
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getChildNodeCount
parameter_list|()
block|{
return|return
name|parent
operator|.
name|getChildNodeCount
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|Iterable
argument_list|<
name|?
extends|extends
name|ChildNodeEntry
argument_list|>
name|getChildNodeEntries
parameter_list|(
specifier|final
name|long
name|offset
parameter_list|,
specifier|final
name|int
name|count
parameter_list|)
block|{
return|return
operator|new
name|Iterable
argument_list|<
name|ChildNodeEntry
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Iterator
argument_list|<
name|ChildNodeEntry
argument_list|>
name|iterator
parameter_list|()
block|{
return|return
name|Iterators
operator|.
name|map
argument_list|(
name|parent
operator|.
name|getChildNodeEntries
argument_list|(
name|offset
argument_list|,
name|count
argument_list|)
operator|.
name|iterator
argument_list|()
argument_list|,
operator|new
name|Function1
argument_list|<
name|ChildNodeEntry
argument_list|,
name|ChildNodeEntry
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ChildNodeEntry
name|apply
parameter_list|(
name|ChildNodeEntry
name|cne
parameter_list|)
block|{
return|return
name|childName
operator|.
name|equals
argument_list|(
name|cne
operator|.
name|getName
argument_list|()
argument_list|)
condition|?
name|createCNE
argument_list|(
name|childName
argument_list|,
name|node
argument_list|)
else|:
name|cne
return|;
block|}
block|}
argument_list|)
return|;
block|}
block|}
return|;
block|}
block|}
return|;
block|}
specifier|private
name|NodeState
name|removeChildNode
parameter_list|(
specifier|final
name|NodeState
name|parent
parameter_list|,
specifier|final
name|String
name|childName
parameter_list|)
block|{
return|return
operator|new
name|AbstractNodeState
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|PropertyState
name|getProperty
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|parent
operator|.
name|getProperty
argument_list|(
name|name
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getPropertyCount
parameter_list|()
block|{
return|return
name|parent
operator|.
name|getPropertyCount
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|Iterable
argument_list|<
name|?
extends|extends
name|PropertyState
argument_list|>
name|getProperties
parameter_list|()
block|{
return|return
name|parent
operator|.
name|getProperties
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|NodeState
name|getChildNode
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|childName
operator|.
name|equals
argument_list|(
name|name
argument_list|)
condition|?
literal|null
else|:
name|parent
operator|.
name|getChildNode
argument_list|(
name|name
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getChildNodeCount
parameter_list|()
block|{
return|return
name|parent
operator|.
name|getChildNodeCount
argument_list|()
operator|-
literal|1
return|;
block|}
annotation|@
name|Override
specifier|public
name|Iterable
argument_list|<
name|?
extends|extends
name|ChildNodeEntry
argument_list|>
name|getChildNodeEntries
parameter_list|(
specifier|final
name|long
name|offset
parameter_list|,
specifier|final
name|int
name|count
parameter_list|)
block|{
return|return
operator|new
name|Iterable
argument_list|<
name|ChildNodeEntry
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Iterator
argument_list|<
name|ChildNodeEntry
argument_list|>
name|iterator
parameter_list|()
block|{
return|return
name|Iterators
operator|.
name|filter
argument_list|(
name|parent
operator|.
name|getChildNodeEntries
argument_list|(
name|offset
argument_list|,
name|count
argument_list|)
operator|.
name|iterator
argument_list|()
argument_list|,
comment|// FIXME offsetting doesn't compose with filtering
operator|new
name|Predicate
argument_list|<
name|ChildNodeEntry
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|boolean
name|evaluate
parameter_list|(
name|ChildNodeEntry
name|cne
parameter_list|)
block|{
return|return
operator|!
name|childName
operator|.
name|equals
argument_list|(
name|cne
operator|.
name|getName
argument_list|()
argument_list|)
return|;
block|}
block|}
argument_list|)
return|;
block|}
block|}
return|;
block|}
block|}
return|;
block|}
specifier|private
name|NodeState
name|addChildProperty
parameter_list|(
specifier|final
name|NodeState
name|parent
parameter_list|,
specifier|final
name|PropertyState
name|property
parameter_list|)
block|{
return|return
operator|new
name|AbstractNodeState
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|PropertyState
name|getProperty
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|property
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|name
argument_list|)
condition|?
name|property
else|:
name|parent
operator|.
name|getProperty
argument_list|(
name|name
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getPropertyCount
parameter_list|()
block|{
return|return
name|parent
operator|.
name|getPropertyCount
argument_list|()
operator|+
literal|1
return|;
block|}
annotation|@
name|Override
specifier|public
name|Iterable
argument_list|<
name|?
extends|extends
name|PropertyState
argument_list|>
name|getProperties
parameter_list|()
block|{
return|return
operator|new
name|Iterable
argument_list|<
name|PropertyState
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Iterator
argument_list|<
name|PropertyState
argument_list|>
name|iterator
parameter_list|()
block|{
return|return
name|Iterators
operator|.
name|chain
argument_list|(
name|parent
operator|.
name|getProperties
argument_list|()
operator|.
name|iterator
argument_list|()
argument_list|,
name|Iterators
operator|.
name|singleton
argument_list|(
name|property
argument_list|)
argument_list|)
return|;
block|}
block|}
return|;
block|}
annotation|@
name|Override
specifier|public
name|NodeState
name|getChildNode
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|parent
operator|.
name|getChildNode
argument_list|(
name|name
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getChildNodeCount
parameter_list|()
block|{
return|return
name|parent
operator|.
name|getChildNodeCount
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|Iterable
argument_list|<
name|?
extends|extends
name|ChildNodeEntry
argument_list|>
name|getChildNodeEntries
parameter_list|(
name|long
name|offset
parameter_list|,
name|int
name|count
parameter_list|)
block|{
return|return
name|parent
operator|.
name|getChildNodeEntries
argument_list|(
name|offset
argument_list|,
name|count
argument_list|)
return|;
block|}
block|}
return|;
block|}
specifier|private
name|NodeState
name|setChildProperty
parameter_list|(
specifier|final
name|NodeState
name|parent
parameter_list|,
specifier|final
name|PropertyState
name|property
parameter_list|)
block|{
return|return
operator|new
name|AbstractNodeState
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|PropertyState
name|getProperty
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|property
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|name
argument_list|)
condition|?
name|property
else|:
name|parent
operator|.
name|getProperty
argument_list|(
name|name
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getPropertyCount
parameter_list|()
block|{
return|return
name|parent
operator|.
name|getPropertyCount
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|Iterable
argument_list|<
name|?
extends|extends
name|PropertyState
argument_list|>
name|getProperties
parameter_list|()
block|{
return|return
operator|new
name|Iterable
argument_list|<
name|PropertyState
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Iterator
argument_list|<
name|PropertyState
argument_list|>
name|iterator
parameter_list|()
block|{
return|return
name|Iterators
operator|.
name|map
argument_list|(
name|parent
operator|.
name|getProperties
argument_list|()
operator|.
name|iterator
argument_list|()
argument_list|,
operator|new
name|Function1
argument_list|<
name|PropertyState
argument_list|,
name|PropertyState
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|PropertyState
name|apply
parameter_list|(
name|PropertyState
name|state
parameter_list|)
block|{
return|return
name|property
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|state
operator|.
name|getName
argument_list|()
argument_list|)
condition|?
name|property
else|:
name|state
return|;
block|}
block|}
argument_list|)
return|;
block|}
block|}
return|;
block|}
annotation|@
name|Override
specifier|public
name|NodeState
name|getChildNode
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|parent
operator|.
name|getChildNode
argument_list|(
name|name
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getChildNodeCount
parameter_list|()
block|{
return|return
name|parent
operator|.
name|getChildNodeCount
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|Iterable
argument_list|<
name|?
extends|extends
name|ChildNodeEntry
argument_list|>
name|getChildNodeEntries
parameter_list|(
name|long
name|offset
parameter_list|,
name|int
name|count
parameter_list|)
block|{
return|return
name|parent
operator|.
name|getChildNodeEntries
argument_list|(
name|offset
argument_list|,
name|count
argument_list|)
return|;
block|}
block|}
return|;
block|}
specifier|private
name|NodeState
name|removeChildProperty
parameter_list|(
specifier|final
name|NodeState
name|parent
parameter_list|,
specifier|final
name|String
name|propertyName
parameter_list|)
block|{
return|return
operator|new
name|AbstractNodeState
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|PropertyState
name|getProperty
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|propertyName
operator|.
name|equals
argument_list|(
name|name
argument_list|)
condition|?
literal|null
else|:
name|parent
operator|.
name|getProperty
argument_list|(
name|name
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getPropertyCount
parameter_list|()
block|{
return|return
name|parent
operator|.
name|getPropertyCount
argument_list|()
operator|-
literal|1
return|;
block|}
annotation|@
name|Override
specifier|public
name|Iterable
argument_list|<
name|?
extends|extends
name|PropertyState
argument_list|>
name|getProperties
parameter_list|()
block|{
return|return
operator|new
name|Iterable
argument_list|<
name|PropertyState
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Iterator
argument_list|<
name|PropertyState
argument_list|>
name|iterator
parameter_list|()
block|{
return|return
name|Iterators
operator|.
name|filter
argument_list|(
name|parent
operator|.
name|getProperties
argument_list|()
operator|.
name|iterator
argument_list|()
argument_list|,
operator|new
name|Predicate
argument_list|<
name|PropertyState
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|boolean
name|evaluate
parameter_list|(
name|PropertyState
name|prop
parameter_list|)
block|{
return|return
operator|!
name|propertyName
operator|.
name|equals
argument_list|(
name|prop
operator|.
name|getName
argument_list|()
argument_list|)
return|;
block|}
block|}
argument_list|)
return|;
block|}
block|}
return|;
block|}
annotation|@
name|Override
specifier|public
name|NodeState
name|getChildNode
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|parent
operator|.
name|getChildNode
argument_list|(
name|name
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getChildNodeCount
parameter_list|()
block|{
return|return
name|parent
operator|.
name|getChildNodeCount
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|Iterable
argument_list|<
name|?
extends|extends
name|ChildNodeEntry
argument_list|>
name|getChildNodeEntries
parameter_list|(
name|long
name|offset
parameter_list|,
name|int
name|count
parameter_list|)
block|{
return|return
name|parent
operator|.
name|getChildNodeEntries
argument_list|(
name|offset
argument_list|,
name|count
argument_list|)
return|;
block|}
block|}
return|;
block|}
block|}
block|}
end_class

end_unit

